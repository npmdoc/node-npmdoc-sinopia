<div class="apidocDiv">
<style>
/*csslint
*/
.apidocDiv {
    background: #fff;
    font-family: Arial, Helvetica, sans-serif;
}
.apidocDiv a[href] {
    color: #33f;
    font-weight: bold;
    text-decoration: none;
}
.apidocDiv a[href]:hover {
    text-decoration: underline;
}
.apidocCodeCommentSpan {
    background: #bbf;
    color: #000;
    display: block;
}
.apidocCodeKeywordSpan {
    color: #d00;
    font-weight: bold;
}
.apidocCodePre {
    background: #eef;
    border: 1px solid;
    color: #777;
    padding: 5px;
    white-space: pre-wrap;
}
.apidocFooterDiv {
    margin-top: 20px;
    text-align: center;
}
.apidocModuleLi {
    margin-top: 10px;
}
.apidocSectionDiv {
    border-top: 1px solid;
    margin-top: 20px;
}
.apidocSignatureSpan {
    color: #777;
    font-weight: bold;
}
</style>
<h1>api-documentation for
    <a
        
        href="https://github.com/rlidwka/sinopia"
        
    >sinopia (v1.4.0)</a>
</h1>
<h4>Private npm repository server</h4>
<div class="apidocSectionDiv"><a
    href="#apidoc.tableOfContents"
    id="apidoc.tableOfContents"
><h1>table of contents</h1></a><ol>
    
    <li class="apidocModuleLi"><a href="#apidoc.module.sinopia">module sinopia</a><ol>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.auth">
            function <span class="apidocSignatureSpan">sinopia.</span>auth
            <span class="apidocSignatureSpan">(config)</span>
            </a>
            
        </li>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.config">
            function <span class="apidocSignatureSpan">sinopia.</span>config
            <span class="apidocSignatureSpan">(config)</span>
            </a>
            
        </li>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.local_data">
            function <span class="apidocSignatureSpan">sinopia.</span>local_data
            <span class="apidocSignatureSpan">(path)</span>
            </a>
            
        </li>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.local_storage">
            function <span class="apidocSignatureSpan">sinopia.</span>local_storage
            <span class="apidocSignatureSpan">(config)</span>
            </a>
            
        </li>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.storage">
            function <span class="apidocSignatureSpan">sinopia.</span>storage
            <span class="apidocSignatureSpan">(config)</span>
            </a>
            
        </li>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.up_storage">
            function <span class="apidocSignatureSpan">sinopia.</span>up_storage
            <span class="apidocSignatureSpan">(config, mainconfig)</span>
            </a>
            
        </li>
        
        <li>
            
            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">sinopia.</span>auth.prototype</span>
            
        </li>
        
        <li>
            
            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">sinopia.</span>config.prototype</span>
            
        </li>
        
        <li>
            
            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">sinopia.</span>local_data.prototype</span>
            
        </li>
        
        <li>
            
            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">sinopia.</span>local_fs</span>
            
        </li>
        
        <li>
            
            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">sinopia.</span>local_storage.prototype</span>
            
        </li>
        
        <li>
            
            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">sinopia.</span>logger</span>
            
        </li>
        
        <li>
            
            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">sinopia.</span>middleware</span>
            
        </li>
        
        <li>
            
            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">sinopia.</span>plugin_loader</span>
            
        </li>
        
        <li>
            
            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">sinopia.</span>status_cats</span>
            
        </li>
        
        <li>
            
            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">sinopia.</span>storage.prototype</span>
            
        </li>
        
        <li>
            
            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">sinopia.</span>streams</span>
            
        </li>
        
        <li>
            
            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">sinopia.</span>up_storage.prototype</span>
            
        </li>
        
        <li>
            
            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">sinopia.</span>utils</span>
            
        </li>
        
    </ol></li>
    
    <li class="apidocModuleLi"><a href="#apidoc.module.sinopia.auth">module sinopia.auth</a><ol>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.auth.auth">
            function <span class="apidocSignatureSpan">sinopia.</span>auth
            <span class="apidocSignatureSpan">(config)</span>
            </a>
            
        </li>
        
    </ol></li>
    
    <li class="apidocModuleLi"><a href="#apidoc.module.sinopia.auth.prototype">module sinopia.auth.prototype</a><ol>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.auth.prototype.add_user">
            function <span class="apidocSignatureSpan">sinopia.auth.prototype.</span>add_user
            <span class="apidocSignatureSpan">(user, password, cb)</span>
            </a>
            
        </li>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.auth.prototype.aes_decrypt">
            function <span class="apidocSignatureSpan">sinopia.auth.prototype.</span>aes_decrypt
            <span class="apidocSignatureSpan">(buf)</span>
            </a>
            
        </li>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.auth.prototype.aes_encrypt">
            function <span class="apidocSignatureSpan">sinopia.auth.prototype.</span>aes_encrypt
            <span class="apidocSignatureSpan">(buf)</span>
            </a>
            
        </li>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.auth.prototype.allow_access">
            function <span class="apidocSignatureSpan">sinopia.auth.prototype.</span>allow_access
            <span class="apidocSignatureSpan">(package_name, user, callback)</span>
            </a>
            
        </li>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.auth.prototype.allow_publish">
            function <span class="apidocSignatureSpan">sinopia.auth.prototype.</span>allow_publish
            <span class="apidocSignatureSpan">(package_name, user, callback)</span>
            </a>
            
        </li>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.auth.prototype.authenticate">
            function <span class="apidocSignatureSpan">sinopia.auth.prototype.</span>authenticate
            <span class="apidocSignatureSpan">(user, password, cb)</span>
            </a>
            
        </li>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.auth.prototype.basic_middleware">
            function <span class="apidocSignatureSpan">sinopia.auth.prototype.</span>basic_middleware
            <span class="apidocSignatureSpan">()</span>
            </a>
            
        </li>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.auth.prototype.bearer_middleware">
            function <span class="apidocSignatureSpan">sinopia.auth.prototype.</span>bearer_middleware
            <span class="apidocSignatureSpan">()</span>
            </a>
            
        </li>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.auth.prototype.cookie_middleware">
            function <span class="apidocSignatureSpan">sinopia.auth.prototype.</span>cookie_middleware
            <span class="apidocSignatureSpan">()</span>
            </a>
            
        </li>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.auth.prototype.decode_token">
            function <span class="apidocSignatureSpan">sinopia.auth.prototype.</span>decode_token
            <span class="apidocSignatureSpan">(str, expire_time)</span>
            </a>
            
        </li>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.auth.prototype.issue_token">
            function <span class="apidocSignatureSpan">sinopia.auth.prototype.</span>issue_token
            <span class="apidocSignatureSpan">(user)</span>
            </a>
            
        </li>
        
    </ol></li>
    
    <li class="apidocModuleLi"><a href="#apidoc.module.sinopia.config">module sinopia.config</a><ol>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.config.config">
            function <span class="apidocSignatureSpan">sinopia.</span>config
            <span class="apidocSignatureSpan">(config)</span>
            </a>
            
        </li>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.config.parse_interval">
            function <span class="apidocSignatureSpan">sinopia.config.</span>parse_interval
            <span class="apidocSignatureSpan">(interval)</span>
            </a>
            
        </li>
        
    </ol></li>
    
    <li class="apidocModuleLi"><a href="#apidoc.module.sinopia.config.prototype">module sinopia.config.prototype</a><ol>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.config.prototype.can_proxy_to">
            function <span class="apidocSignatureSpan">sinopia.config.prototype.</span>can_proxy_to
            <span class="apidocSignatureSpan">(package, uplink)</span>
            </a>
            
        </li>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.config.prototype.get_package_spec">
            function <span class="apidocSignatureSpan">sinopia.config.prototype.</span>get_package_spec
            <span class="apidocSignatureSpan">(package)</span>
            </a>
            
        </li>
        
    </ol></li>
    
    <li class="apidocModuleLi"><a href="#apidoc.module.sinopia.local_data">module sinopia.local_data</a><ol>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.local_data.local_data">
            function <span class="apidocSignatureSpan">sinopia.</span>local_data
            <span class="apidocSignatureSpan">(path)</span>
            </a>
            
        </li>
        
    </ol></li>
    
    <li class="apidocModuleLi"><a href="#apidoc.module.sinopia.local_data.prototype">module sinopia.local_data.prototype</a><ol>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.local_data.prototype.add">
            function <span class="apidocSignatureSpan">sinopia.local_data.prototype.</span>add
            <span class="apidocSignatureSpan">(name)</span>
            </a>
            
        </li>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.local_data.prototype.get">
            function <span class="apidocSignatureSpan">sinopia.local_data.prototype.</span>get
            <span class="apidocSignatureSpan">()</span>
            </a>
            
        </li>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.local_data.prototype.remove">
            function <span class="apidocSignatureSpan">sinopia.local_data.prototype.</span>remove
            <span class="apidocSignatureSpan">(name)</span>
            </a>
            
        </li>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.local_data.prototype.sync">
            function <span class="apidocSignatureSpan">sinopia.local_data.prototype.</span>sync
            <span class="apidocSignatureSpan">()</span>
            </a>
            
        </li>
        
    </ol></li>
    
    <li class="apidocModuleLi"><a href="#apidoc.module.sinopia.local_fs">module sinopia.local_fs</a><ol>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.local_fs.create">
            function <span class="apidocSignatureSpan">sinopia.local_fs.</span>create
            <span class="apidocSignatureSpan">(name, contents, callback)</span>
            </a>
            
        </li>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.local_fs.create_json">
            function <span class="apidocSignatureSpan">sinopia.local_fs.</span>create_json
            <span class="apidocSignatureSpan">(name, value, cb)</span>
            </a>
            
        </li>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.local_fs.lock_and_read">
            function <span class="apidocSignatureSpan">sinopia.local_fs.</span>lock_and_read
            <span class="apidocSignatureSpan">(name, _callback)</span>
            </a>
            
        </li>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.local_fs.lock_and_read_json">
            function <span class="apidocSignatureSpan">sinopia.local_fs.</span>lock_and_read_json
            <span class="apidocSignatureSpan">(name, cb)</span>
            </a>
            
        </li>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.local_fs.read">
            function <span class="apidocSignatureSpan">sinopia.local_fs.</span>read
            <span class="apidocSignatureSpan">(name, callback)</span>
            </a>
            
        </li>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.local_fs.read_json">
            function <span class="apidocSignatureSpan">sinopia.local_fs.</span>read_json
            <span class="apidocSignatureSpan">(name, cb)</span>
            </a>
            
        </li>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.local_fs.read_stream">
            function <span class="apidocSignatureSpan">sinopia.local_fs.</span>read_stream
            <span class="apidocSignatureSpan">(name, stream, callback)</span>
            </a>
            
        </li>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.local_fs.rmdir">
            function <span class="apidocSignatureSpan">sinopia.local_fs.</span>rmdir
            <span class="apidocSignatureSpan">(path, callback)</span>
            </a>
            
        </li>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.local_fs.unlink">
            function <span class="apidocSignatureSpan">sinopia.local_fs.</span>unlink
            <span class="apidocSignatureSpan">(path, callback)</span>
            </a>
            
        </li>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.local_fs.update">
            function <span class="apidocSignatureSpan">sinopia.local_fs.</span>update
            <span class="apidocSignatureSpan">(name, contents, callback)</span>
            </a>
            
        </li>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.local_fs.update_json">
            function <span class="apidocSignatureSpan">sinopia.local_fs.</span>update_json
            <span class="apidocSignatureSpan">(name, value, cb)</span>
            </a>
            
        </li>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.local_fs.write">
            function <span class="apidocSignatureSpan">sinopia.local_fs.</span>write
            <span class="apidocSignatureSpan">(dest, data, cb)</span>
            </a>
            
        </li>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.local_fs.write_json">
            function <span class="apidocSignatureSpan">sinopia.local_fs.</span>write_json
            <span class="apidocSignatureSpan">(name, value, cb)</span>
            </a>
            
        </li>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.local_fs.write_stream">
            function <span class="apidocSignatureSpan">sinopia.local_fs.</span>write_stream
            <span class="apidocSignatureSpan">(name)</span>
            </a>
            
        </li>
        
    </ol></li>
    
    <li class="apidocModuleLi"><a href="#apidoc.module.sinopia.local_storage">module sinopia.local_storage</a><ol>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.local_storage.local_storage">
            function <span class="apidocSignatureSpan">sinopia.</span>local_storage
            <span class="apidocSignatureSpan">(config)</span>
            </a>
            
        </li>
        
    </ol></li>
    
    <li class="apidocModuleLi"><a href="#apidoc.module.sinopia.local_storage.prototype">module sinopia.local_storage.prototype</a><ol>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.local_storage.prototype._each_package">
            function <span class="apidocSignatureSpan">sinopia.local_storage.prototype.</span>_each_package
            <span class="apidocSignatureSpan">(on_package, on_end)</span>
            </a>
            
        </li>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.local_storage.prototype._internal_error">
            function <span class="apidocSignatureSpan">sinopia.local_storage.prototype.</span>_internal_error
            <span class="apidocSignatureSpan">(err, file, message)</span>
            </a>
            
        </li>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.local_storage.prototype._normalize_package">
            function <span class="apidocSignatureSpan">sinopia.local_storage.prototype.</span>_normalize_package
            <span class="apidocSignatureSpan">(pkg)</span>
            </a>
            
        </li>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.local_storage.prototype._read_create_package">
            function <span class="apidocSignatureSpan">sinopia.local_storage.prototype.</span>_read_create_package
            <span class="apidocSignatureSpan">(name, callback)</span>
            </a>
            
        </li>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.local_storage.prototype._write_package">
            function <span class="apidocSignatureSpan">sinopia.local_storage.prototype.</span>_write_package
            <span class="apidocSignatureSpan">(name, json, callback)</span>
            </a>
            
        </li>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.local_storage.prototype.add_package">
            function <span class="apidocSignatureSpan">sinopia.local_storage.prototype.</span>add_package
            <span class="apidocSignatureSpan">(name, info, callback)</span>
            </a>
            
        </li>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.local_storage.prototype.add_tarball">
            function <span class="apidocSignatureSpan">sinopia.local_storage.prototype.</span>add_tarball
            <span class="apidocSignatureSpan">(name, filename)</span>
            </a>
            
        </li>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.local_storage.prototype.add_version">
            function <span class="apidocSignatureSpan">sinopia.local_storage.prototype.</span>add_version
            <span class="apidocSignatureSpan">(name, version, metadata, tag, callback)</span>
            </a>
            
        </li>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.local_storage.prototype.change_package">
            function <span class="apidocSignatureSpan">sinopia.local_storage.prototype.</span>change_package
            <span class="apidocSignatureSpan">(name, metadata, revision, callback)</span>
            </a>
            
        </li>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.local_storage.prototype.get_package">
            function <span class="apidocSignatureSpan">sinopia.local_storage.prototype.</span>get_package
            <span class="apidocSignatureSpan">(name, options, callback)</span>
            </a>
            
        </li>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.local_storage.prototype.get_tarball">
            function <span class="apidocSignatureSpan">sinopia.local_storage.prototype.</span>get_tarball
            <span class="apidocSignatureSpan">(name, filename, callback)</span>
            </a>
            
        </li>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.local_storage.prototype.merge_tags">
            function <span class="apidocSignatureSpan">sinopia.local_storage.prototype.</span>merge_tags
            <span class="apidocSignatureSpan">(name, tags, callback)</span>
            </a>
            
        </li>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.local_storage.prototype.remove_package">
            function <span class="apidocSignatureSpan">sinopia.local_storage.prototype.</span>remove_package
            <span class="apidocSignatureSpan">(name, callback)</span>
            </a>
            
        </li>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.local_storage.prototype.remove_tarball">
            function <span class="apidocSignatureSpan">sinopia.local_storage.prototype.</span>remove_tarball
            <span class="apidocSignatureSpan">(name, filename, revision, callback)</span>
            </a>
            
        </li>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.local_storage.prototype.replace_tags">
            function <span class="apidocSignatureSpan">sinopia.local_storage.prototype.</span>replace_tags
            <span class="apidocSignatureSpan">(name, tags, callback)</span>
            </a>
            
        </li>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.local_storage.prototype.search">
            function <span class="apidocSignatureSpan">sinopia.local_storage.prototype.</span>search
            <span class="apidocSignatureSpan">(startkey, options)</span>
            </a>
            
        </li>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.local_storage.prototype.storage">
            function <span class="apidocSignatureSpan">sinopia.local_storage.prototype.</span>storage
            <span class="apidocSignatureSpan">(package)</span>
            </a>
            
        </li>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.local_storage.prototype.update_package">
            function <span class="apidocSignatureSpan">sinopia.local_storage.prototype.</span>update_package
            <span class="apidocSignatureSpan">(name, updateFn, _callback)</span>
            </a>
            
        </li>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.local_storage.prototype.update_versions">
            function <span class="apidocSignatureSpan">sinopia.local_storage.prototype.</span>update_versions
            <span class="apidocSignatureSpan">(name, newdata, callback)</span>
            </a>
            
        </li>
        
    </ol></li>
    
    <li class="apidocModuleLi"><a href="#apidoc.module.sinopia.logger">module sinopia.logger</a><ol>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.logger.setup">
            function <span class="apidocSignatureSpan">sinopia.logger.</span>setup
            <span class="apidocSignatureSpan">(logs)</span>
            </a>
            
        </li>
        
        <li>
            
            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">sinopia.</span>logger</span>
            
        </li>
        
    </ol></li>
    
    <li class="apidocModuleLi"><a href="#apidoc.module.sinopia.middleware">module sinopia.middleware</a><ol>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.middleware.allow">
            function <span class="apidocSignatureSpan">sinopia.middleware.</span>allow
            <span class="apidocSignatureSpan">(auth)</span>
            </a>
            
        </li>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.middleware.anti_loop">
            function <span class="apidocSignatureSpan">sinopia.middleware.</span>anti_loop
            <span class="apidocSignatureSpan">(config)</span>
            </a>
            
        </li>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.middleware.expect_json">
            function <span class="apidocSignatureSpan">sinopia.middleware.</span>expect_json
            <span class="apidocSignatureSpan">(req, res, next)</span>
            </a>
            
        </li>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.middleware.final">
            function <span class="apidocSignatureSpan">sinopia.middleware.</span>final
            <span class="apidocSignatureSpan">(body, req, res, next)</span>
            </a>
            
        </li>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.middleware.log">
            function <span class="apidocSignatureSpan">sinopia.middleware.</span>log
            <span class="apidocSignatureSpan">(req, res, next)</span>
            </a>
            
        </li>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.middleware.match">
            function <span class="apidocSignatureSpan">sinopia.middleware.</span>match
            <span class="apidocSignatureSpan">(regexp)</span>
            </a>
            
        </li>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.middleware.media">
            function <span class="apidocSignatureSpan">sinopia.middleware.</span>media
            <span class="apidocSignatureSpan">(expect)</span>
            </a>
            
        </li>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.middleware.validate_name">
            function <span class="apidocSignatureSpan">sinopia.middleware.</span>validate_name
            <span class="apidocSignatureSpan">(req, res, next, value, name)</span>
            </a>
            
        </li>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.middleware.validate_package">
            function <span class="apidocSignatureSpan">sinopia.middleware.</span>validate_package
            <span class="apidocSignatureSpan">(req, res, next, value, name)</span>
            </a>
            
        </li>
        
    </ol></li>
    
    <li class="apidocModuleLi"><a href="#apidoc.module.sinopia.plugin_loader">module sinopia.plugin_loader</a><ol>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.plugin_loader.load_plugins">
            function <span class="apidocSignatureSpan">sinopia.plugin_loader.</span>load_plugins
            <span class="apidocSignatureSpan">(config, plugin_configs, params, sanity_check)</span>
            </a>
            
        </li>
        
    </ol></li>
    
    <li class="apidocModuleLi"><a href="#apidoc.module.sinopia.status_cats">module sinopia.status_cats</a><ol>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.status_cats.get_image">
            function <span class="apidocSignatureSpan">sinopia.status_cats.</span>get_image
            <span class="apidocSignatureSpan">(status)</span>
            </a>
            
        </li>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.status_cats.middleware">
            function <span class="apidocSignatureSpan">sinopia.status_cats.</span>middleware
            <span class="apidocSignatureSpan">(req, res, next)</span>
            </a>
            
        </li>
        
    </ol></li>
    
    <li class="apidocModuleLi"><a href="#apidoc.module.sinopia.storage">module sinopia.storage</a><ol>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.storage.storage">
            function <span class="apidocSignatureSpan">sinopia.</span>storage
            <span class="apidocSignatureSpan">(config)</span>
            </a>
            
        </li>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.storage._merge_versions">
            function <span class="apidocSignatureSpan">sinopia.storage.</span>_merge_versions
            <span class="apidocSignatureSpan">(local, up, config)</span>
            </a>
            
        </li>
        
    </ol></li>
    
    <li class="apidocModuleLi"><a href="#apidoc.module.sinopia.storage.prototype">module sinopia.storage.prototype</a><ol>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.storage.prototype._sync_package_with_uplinks">
            function <span class="apidocSignatureSpan">sinopia.storage.prototype.</span>_sync_package_with_uplinks
            <span class="apidocSignatureSpan">(name, pkginfo, options, callback)</span>
            </a>
            
        </li>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.storage.prototype.add_package">
            function <span class="apidocSignatureSpan">sinopia.storage.prototype.</span>add_package
            <span class="apidocSignatureSpan">(name, metadata, callback)</span>
            </a>
            
        </li>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.storage.prototype.add_tarball">
            function <span class="apidocSignatureSpan">sinopia.storage.prototype.</span>add_tarball
            <span class="apidocSignatureSpan">(name, filename)</span>
            </a>
            
        </li>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.storage.prototype.add_version">
            function <span class="apidocSignatureSpan">sinopia.storage.prototype.</span>add_version
            <span class="apidocSignatureSpan">(name, version, metadata, tag, callback)</span>
            </a>
            
        </li>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.storage.prototype.change_package">
            function <span class="apidocSignatureSpan">sinopia.storage.prototype.</span>change_package
            <span class="apidocSignatureSpan">(name, metadata, revision, callback)</span>
            </a>
            
        </li>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.storage.prototype.get_local">
            function <span class="apidocSignatureSpan">sinopia.storage.prototype.</span>get_local
            <span class="apidocSignatureSpan">(callback)</span>
            </a>
            
        </li>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.storage.prototype.get_package">
            function <span class="apidocSignatureSpan">sinopia.storage.prototype.</span>get_package
            <span class="apidocSignatureSpan">(name, options, callback)</span>
            </a>
            
        </li>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.storage.prototype.get_tarball">
            function <span class="apidocSignatureSpan">sinopia.storage.prototype.</span>get_tarball
            <span class="apidocSignatureSpan">(name, filename)</span>
            </a>
            
        </li>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.storage.prototype.merge_tags">
            function <span class="apidocSignatureSpan">sinopia.storage.prototype.</span>merge_tags
            <span class="apidocSignatureSpan">(name, tag_hash, callback)</span>
            </a>
            
        </li>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.storage.prototype.remove_package">
            function <span class="apidocSignatureSpan">sinopia.storage.prototype.</span>remove_package
            <span class="apidocSignatureSpan">(name, callback)</span>
            </a>
            
        </li>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.storage.prototype.remove_tarball">
            function <span class="apidocSignatureSpan">sinopia.storage.prototype.</span>remove_tarball
            <span class="apidocSignatureSpan">(name, filename, revision, callback)</span>
            </a>
            
        </li>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.storage.prototype.replace_tags">
            function <span class="apidocSignatureSpan">sinopia.storage.prototype.</span>replace_tags
            <span class="apidocSignatureSpan">(name, tag_hash, callback)</span>
            </a>
            
        </li>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.storage.prototype.search">
            function <span class="apidocSignatureSpan">sinopia.storage.prototype.</span>search
            <span class="apidocSignatureSpan">(startkey, options)</span>
            </a>
            
        </li>
        
    </ol></li>
    
    <li class="apidocModuleLi"><a href="#apidoc.module.sinopia.streams">module sinopia.streams</a><ol>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.streams.ReadTarballStream">
            function <span class="apidocSignatureSpan">sinopia.streams.</span>ReadTarballStream
            <span class="apidocSignatureSpan">(options)</span>
            </a>
            
        </li>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.streams.UploadTarballStream">
            function <span class="apidocSignatureSpan">sinopia.streams.</span>UploadTarballStream
            <span class="apidocSignatureSpan">(options)</span>
            </a>
            
        </li>
        
    </ol></li>
    
    <li class="apidocModuleLi"><a href="#apidoc.module.sinopia.up_storage">module sinopia.up_storage</a><ol>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.up_storage.up_storage">
            function <span class="apidocSignatureSpan">sinopia.</span>up_storage
            <span class="apidocSignatureSpan">(config, mainconfig)</span>
            </a>
            
        </li>
        
    </ol></li>
    
    <li class="apidocModuleLi"><a href="#apidoc.module.sinopia.up_storage.prototype">module sinopia.up_storage.prototype</a><ol>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.up_storage.prototype._add_proxy_headers">
            function <span class="apidocSignatureSpan">sinopia.up_storage.prototype.</span>_add_proxy_headers
            <span class="apidocSignatureSpan">(req, headers)</span>
            </a>
            
        </li>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.up_storage.prototype.can_fetch_url">
            function <span class="apidocSignatureSpan">sinopia.up_storage.prototype.</span>can_fetch_url
            <span class="apidocSignatureSpan">(url)</span>
            </a>
            
        </li>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.up_storage.prototype.get_package">
            function <span class="apidocSignatureSpan">sinopia.up_storage.prototype.</span>get_package
            <span class="apidocSignatureSpan">(name, options, callback)</span>
            </a>
            
        </li>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.up_storage.prototype.get_tarball">
            function <span class="apidocSignatureSpan">sinopia.up_storage.prototype.</span>get_tarball
            <span class="apidocSignatureSpan">(name, options, filename)</span>
            </a>
            
        </li>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.up_storage.prototype.get_url">
            function <span class="apidocSignatureSpan">sinopia.up_storage.prototype.</span>get_url
            <span class="apidocSignatureSpan">(url)</span>
            </a>
            
        </li>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.up_storage.prototype.request">
            function <span class="apidocSignatureSpan">sinopia.up_storage.prototype.</span>request
            <span class="apidocSignatureSpan">(options, cb)</span>
            </a>
            
        </li>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.up_storage.prototype.search">
            function <span class="apidocSignatureSpan">sinopia.up_storage.prototype.</span>search
            <span class="apidocSignatureSpan">(startkey, options)</span>
            </a>
            
        </li>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.up_storage.prototype.status_check">
            function <span class="apidocSignatureSpan">sinopia.up_storage.prototype.</span>status_check
            <span class="apidocSignatureSpan">(alive)</span>
            </a>
            
        </li>
        
    </ol></li>
    
    <li class="apidocModuleLi"><a href="#apidoc.module.sinopia.utils">module sinopia.utils</a><ol>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.utils.filter_tarball_urls">
            function <span class="apidocSignatureSpan">sinopia.utils.</span>filter_tarball_urls
            <span class="apidocSignatureSpan">(pkg, req, config)</span>
            </a>
            
        </li>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.utils.get_version">
            function <span class="apidocSignatureSpan">sinopia.utils.</span>get_version
            <span class="apidocSignatureSpan">(object, version)</span>
            </a>
            
        </li>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.utils.is_object">
            function <span class="apidocSignatureSpan">sinopia.utils.</span>is_object
            <span class="apidocSignatureSpan">(obj)</span>
            </a>
            
        </li>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.utils.parse_address">
            function <span class="apidocSignatureSpan">sinopia.utils.</span>parse_address
            <span class="apidocSignatureSpan">(addr)</span>
            </a>
            
        </li>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.utils.semver_sort">
            function <span class="apidocSignatureSpan">sinopia.utils.</span>semver_sort
            <span class="apidocSignatureSpan">(array)</span>
            </a>
            
        </li>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.utils.tag_version">
            function <span class="apidocSignatureSpan">sinopia.utils.</span>tag_version
            <span class="apidocSignatureSpan">(data, version, tag, config)</span>
            </a>
            
        </li>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.utils.validate_metadata">
            function <span class="apidocSignatureSpan">sinopia.utils.</span>validate_metadata
            <span class="apidocSignatureSpan">(object, name)</span>
            </a>
            
        </li>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.utils.validate_name">
            function <span class="apidocSignatureSpan">sinopia.utils.</span>validate_name
            <span class="apidocSignatureSpan">(name)</span>
            </a>
            
        </li>
        
        <li>
            
            <a class="apidocElementLiA" href="#apidoc.element.sinopia.utils.validate_package">
            function <span class="apidocSignatureSpan">sinopia.utils.</span>validate_package
            <span class="apidocSignatureSpan">(name)</span>
            </a>
            
        </li>
        
    </ol></li>
    
</ol></div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.sinopia" id="apidoc.module.sinopia">module sinopia</a></h1>
    
    
    <h2>
        <a href="#apidoc.element.sinopia.auth" id="apidoc.element.sinopia.auth">
        function <span class="apidocSignatureSpan">sinopia.</span>auth
        <span class="apidocSignatureSpan">(config)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function Auth(config) {
  var self = Object.create(Auth.prototype)
  self.config = config
  self.logger = Logger.logger.child({ sub: &#x27;auth&#x27; })
  self.secret = config.secret

  var plugin_params = {
    config: config,
    logger: self.logger
  }

  if (config.users_file) {
    if (!config.auth || !config.auth.htpasswd) {
      // b/w compat
      config.auth = config.auth || {}
      config.auth.htpasswd = { file: config.users_file }
    }
  }

  self.plugins = load_plugins(config, config.auth, plugin_params, function (p) {
    return p.authenticate || p.allow_access || p.allow_publish
  })

  self.plugins.unshift({
    sinopia_version: &#x27;1.1.0&#x27;,

    authenticate: function(user, password, cb) {
      if (config.users != null
       &#x26;&#x26; config.users[user] != null
       &#x26;&#x26; (Crypto.createHash(&#x27;sha1&#x27;).update(password).digest(&#x27;hex&#x27;)
            === config.users[user].password)
      ) {
        return cb(null, [ user ])
      }

      return cb()
    },

    adduser: function(user, password, cb) {
      if (config.users &#x26;&#x26; config.users[user])
        return cb( Error[403](&#x27;this user already exists&#x27;) )

      return cb()
    },
  })

  function allow_action(action) {
    return function(user, package, cb) {
      var ok = package[action].reduce(function(prev, curr) {
        if (user.groups.indexOf(curr) !== -1) return true
        return prev
      }, false)

      if (ok) return cb(null, true)

      if (user.name) {
        cb( Error[403](&#x27;user &#x27; + user.name + &#x27; is not allowed to &#x27; + action + &#x27; package &#x27; + package.name) )
      } else {
        cb( Error[403](&#x27;unregistered users are not allowed to &#x27; + action + &#x27; package &#x27; + package.name) )
      }
    }
  }

  self.plugins.push({
    authenticate: function(user, password, cb) {
      return cb( Error[403](&#x27;bad username/password, access denied&#x27;) )
    },

    add_user: function(user, password, cb) {
      return cb( Error[409](&#x27;registration is disabled&#x27;) )
    },

    allow_access: allow_action(&#x27;access&#x27;),
    allow_publish: allow_action(&#x27;publish&#x27;),
  })

  return self
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>
    
    
    
    <h2>
        <a href="#apidoc.element.sinopia.config" id="apidoc.element.sinopia.config">
        function <span class="apidocSignatureSpan">sinopia.</span>config
        <span class="apidocSignatureSpan">(config)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function Config(config) {
  var self = Object.create(Config.prototype)
  for (var i in config) {
    if (self[i] == null) self[i] = config[i]
  }
  if (!self.user_agent) self.user_agent = &#x27;Sinopia/&#x27;+pkg.version

  // some weird shell scripts are valid yaml files parsed as string
  assert.equal(typeof(config), &#x27;object&#x27;, &#x27;CONFIG: it doesn\&#x27;t look like a valid config file&#x27;)

  assert(self.storage, &#x27;CONFIG: storage path not defined&#x27;)
  self.localList = LocalData(
    Path.join(
      Path.resolve(Path.dirname(self.self_path), self.storage),
      &#x27;.sinopia-db.json&#x27;
    )
  )
  if (!self.secret) {
    self.secret = self.localList.data.secret

    if (!self.secret) {
      self.secret = Crypto.pseudoRandomBytes(32).toString(&#x27;hex&#x27;)
      self.localList.data.secret = self.secret
      self.localList.sync()
    }
  }

  var users = {all:true, anonymous:true, &#x27;undefined&#x27;:true, owner:true, none:true}

  var check_user_or_uplink = function(arg) {
    assert(arg !== &#x27;all&#x27; &#x26;&#x26; arg !== &#x27;owner&#x27; &#x26;&#x26; arg !== &#x27;anonymous&#x27; &#x26;&#x26; arg !== &#x27;undefined&#x27; &#x26;&#x26; arg !== &#x27;none&#x27;, &#x27;CONFIG: reserved u\
ser/uplink name: &#x27; + arg)
    assert(!arg.match(/\s/), &#x27;CONFIG: invalid user name: &#x27; + arg)
    assert(users[arg] == null, &#x27;CONFIG: duplicate user/uplink name: &#x27; + arg)
    users[arg] = true
  }

  ;[ &#x27;users&#x27;, &#x27;uplinks&#x27;, &#x27;packages&#x27; ].forEach(function(x) {
    if (self[x] == null) self[x] = {}
    assert(Utils.is_object(self[x]), &#x27;CONFIG: bad &#x22;&#x27;+x+&#x27;&#x22; value (object expected)&#x27;)
  })

  for (var i in self.users) check_user_or_uplink(i)
  for (var i in self.uplinks) check_user_or_uplink(i)

  for (var i in self.users) {
    assert(self.users[i].password, &#x27;CONFIG: no password for user: &#x27; + i)
    assert(
      typeof(self.users[i].password) === &#x27;string&#x27; &#x26;&#x26;
      self.users[i].password.match(/^[a-f0-9]{40}$/)
    , &#x27;CONFIG: wrong password format for user: &#x27; + i + &#x27;, sha1 expected&#x27;)
  }

  for (var i in self.uplinks) {
    assert(self.uplinks[i].url, &#x27;CONFIG: no url for uplink: &#x27; + i)
    assert( typeof(self.uplinks[i].url) === &#x27;string&#x27;
          , &#x27;CONFIG: wrong url format for uplink: &#x27; + i)
    self.uplinks[i].url = self.uplinks[i].url.replace(/\/$/, &#x27;&#x27;)
  }

  function normalize_userlist() {
    var result = []

    for (var i=0; i&#x3c;arguments.length; i++) {
      if (arguments[i] == null) continue

      // if it&#x27;s a string, split it to array
      if (typeof(arguments[i]) === &#x27;string&#x27;) {
        result.push(arguments[i].split(/\s+/))
      } else if (Array.isArray(arguments[i])) {
        result.push(arguments[i])
      } else {
        throw Error(&#x27;CONFIG: bad package acl (array or string expected): &#x27; + JSON.stringify(arguments[i]))
      }
    }
    return flatten(result)
  }

  // add a default rule for all packages to make writing plugins easier
  if (self.packages[&#x27;**&#x27;] == null) {
    self.packages[&#x27;**&#x27;] = {}
  }

  for (var i in self.packages) {
    assert(
      typeof(self.packages[i]) === &#x27;object&#x27; &#x26;&#x26;
      !Array.isArray(self.packages[i])
    , &#x27;CONFIG: bad &#x22;&#x27;+i+&#x27;&#x22; package description (object expected)&#x27;)

    self.packages[i].access = normalize_userlist(
      self.packages[i].allow_access,
      self.packages[i].access
    );
    delete self.packages[i].allow_access

    self.packages[i].publish = normalize_userlist(
      self.packages[i].allow_publish,
      self.packages[i].publish
    );
    delete self.packages[i].allow_publish

    self.packages[i].proxy = normalize_userlist(
      self.packages[i].proxy_access,
      self.packages[i].proxy
    );
    delete self.packages[i].proxy_access
  }

  // loading these from ENV if aren&#x27;t in config
  ;[ &#x27;http_proxy&#x27;, &#x27;https_proxy&#x27;, &#x27;no_proxy&#x27; ].forEach((function(v) {
    if (!(v in self)) {
      self[v] = process.env[v] || process.env[v.toUpperCase()]
    }
  }).bind(self))

  // unique identifier of self server (or a cluster), used to avoid loops
  if (!self.server_id) {
    self.server_id = Crypto.pseudoRandomBytes(6).toString(&#x27;hex&#x27;)
  }

  if (self.ignore_latest_tag == null) self.ignore_latest_tag = false

  return self
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>
    
    
    
    <h2>
        <a href="#apidoc.element.sinopia.local_data" id="apidoc.element.sinopia.local_data">
        function <span class="apidocSignatureSpan">sinopia.</span>local_data
        <span class="apidocSignatureSpan">(path)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function LocalData(path) {
  var self = Object.create(LocalData.prototype)
  self.path = path
  try {
    self.data = JSON.parse(fs.readFileSync(self.path, &#x27;utf8&#x27;))
  } catch(_) {
    self.data = { list: [] }
  }
  return self
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>
    
    
    
    <h2>
        <a href="#apidoc.element.sinopia.local_storage" id="apidoc.element.sinopia.local_storage">
        function <span class="apidocSignatureSpan">sinopia.</span>local_storage
        <span class="apidocSignatureSpan">(config)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function Storage(config) {
  var self = Object.create(Storage.prototype)
  self.config = config
  self.logger = Logger.logger.child({ sub: &#x27;fs&#x27; })
  return self
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>
    
    
    
    <h2>
        <a href="#apidoc.element.sinopia.storage" id="apidoc.element.sinopia.storage">
        function <span class="apidocSignatureSpan">sinopia.</span>storage
        <span class="apidocSignatureSpan">(config)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function Storage(config) {
  var self = Object.create(Storage.prototype)
  self.config = config

  // we support a number of uplinks, but only one local storage
  // Proxy and Local classes should have similar API interfaces
  self.uplinks = {}
  for (var p in config.uplinks) {
    self.uplinks[p] = Proxy(config.uplinks[p], config)
    self.uplinks[p].upname = p
  }
  self.local = Local(config)
  self.logger = Logger.logger.child()

  return self
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
Storage.prototype._internal_error = function(err, file, message) {
this.logger.error( { err: err, file: file }
                 , message + &#x27; @{file}: @{!err.message}&#x27; )
return Error[500]()
}

Storage.prototype.add_package = function(name, info, callback) {
var storage = this.<span class="apidocCodeKeywordSpan">storage</span>(name)
if (!storage) return callback( Error[404](&#x27;this package cannot be added&#x27;) )

storage.create_json(info_file, get_boilerplate(name), function(err) {
  if (err &#x26;&#x26; err.code === &#x27;EEXISTS&#x27;) {
    return callback( Error[409](&#x27;this package is already present&#x27;) )
  }
...</pre></li>
    </ul>
    
    
    
    <h2>
        <a href="#apidoc.element.sinopia.up_storage" id="apidoc.element.sinopia.up_storage">
        function <span class="apidocSignatureSpan">sinopia.</span>up_storage
        <span class="apidocSignatureSpan">(config, mainconfig)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function Storage(config, mainconfig) {
  var self = Object.create(Storage.prototype)
  self.config = config
  self.failed_requests = 0
  self.userAgent = mainconfig.user_agent
  self.ca = config.ca
  self.logger = Logger.logger.child({sub: &#x27;out&#x27;})
  self.server_id = mainconfig.server_id

  self.url = URL.parse(self.config.url)

  _setupProxy.call(self, self.url.hostname, config, mainconfig, self.url.protocol === &#x27;https:&#x27;)

  self.config.url = self.config.url.replace(/\/$/, &#x27;&#x27;)
  if (Number(self.config.timeout) &#x3e;= 1000) {
    self.logger.warn([ &#x27;Too big timeout value: &#x27; + self.config.timeout,
                       &#x27;We changed time format to nginx-like one&#x27;,
                       &#x27;(see http://wiki.nginx.org/ConfigNotation)&#x27;,
                       &#x27;so please update your config accordingly&#x27; ].join(&#x27;\n&#x27;))
  }

  // a bunch of different configurable timers
  self.maxage       = parse_interval(config_get(&#x27;maxage&#x27;      , &#x27;2m&#x27; ))
  self.timeout      = parse_interval(config_get(&#x27;timeout&#x27;     , &#x27;30s&#x27;))
  self.max_fails    =         Number(config_get(&#x27;max_fails&#x27;   ,  2   ))
  self.fail_timeout = parse_interval(config_get(&#x27;fail_timeout&#x27;, &#x27;5m&#x27; ))
  return self

  // just a helper (`config[key] || default` doesn&#x27;t work because of zeroes)
  function config_get(key, def) {
    return config[key] != null ? config[key] : def
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.sinopia.auth" id="apidoc.module.sinopia.auth">module sinopia.auth</a></h1>
    
    
    <h2>
        <a href="#apidoc.element.sinopia.auth.auth" id="apidoc.element.sinopia.auth.auth">
        function <span class="apidocSignatureSpan">sinopia.</span>auth
        <span class="apidocSignatureSpan">(config)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function Auth(config) {
  var self = Object.create(Auth.prototype)
  self.config = config
  self.logger = Logger.logger.child({ sub: &#x27;auth&#x27; })
  self.secret = config.secret

  var plugin_params = {
    config: config,
    logger: self.logger
  }

  if (config.users_file) {
    if (!config.auth || !config.auth.htpasswd) {
      // b/w compat
      config.auth = config.auth || {}
      config.auth.htpasswd = { file: config.users_file }
    }
  }

  self.plugins = load_plugins(config, config.auth, plugin_params, function (p) {
    return p.authenticate || p.allow_access || p.allow_publish
  })

  self.plugins.unshift({
    sinopia_version: &#x27;1.1.0&#x27;,

    authenticate: function(user, password, cb) {
      if (config.users != null
       &#x26;&#x26; config.users[user] != null
       &#x26;&#x26; (Crypto.createHash(&#x27;sha1&#x27;).update(password).digest(&#x27;hex&#x27;)
            === config.users[user].password)
      ) {
        return cb(null, [ user ])
      }

      return cb()
    },

    adduser: function(user, password, cb) {
      if (config.users &#x26;&#x26; config.users[user])
        return cb( Error[403](&#x27;this user already exists&#x27;) )

      return cb()
    },
  })

  function allow_action(action) {
    return function(user, package, cb) {
      var ok = package[action].reduce(function(prev, curr) {
        if (user.groups.indexOf(curr) !== -1) return true
        return prev
      }, false)

      if (ok) return cb(null, true)

      if (user.name) {
        cb( Error[403](&#x27;user &#x27; + user.name + &#x27; is not allowed to &#x27; + action + &#x27; package &#x27; + package.name) )
      } else {
        cb( Error[403](&#x27;unregistered users are not allowed to &#x27; + action + &#x27; package &#x27; + package.name) )
      }
    }
  }

  self.plugins.push({
    authenticate: function(user, password, cb) {
      return cb( Error[403](&#x27;bad username/password, access denied&#x27;) )
    },

    add_user: function(user, password, cb) {
      return cb( Error[409](&#x27;registration is disabled&#x27;) )
    },

    allow_access: allow_action(&#x27;access&#x27;),
    allow_publish: allow_action(&#x27;publish&#x27;),
  })

  return self
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>
    
    
</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.sinopia.auth.prototype" id="apidoc.module.sinopia.auth.prototype">module sinopia.auth.prototype</a></h1>
    
    
    <h2>
        <a href="#apidoc.element.sinopia.auth.prototype.add_user" id="apidoc.element.sinopia.auth.prototype.add_user">
        function <span class="apidocSignatureSpan">sinopia.auth.prototype.</span>add_user
        <span class="apidocSignatureSpan">(user, password, cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">add_user = function (user, password, cb) {
  var self = this
  var plugins = this.plugins.slice(0)

  ;(function next() {
    var p = plugins.shift()
    var n = &#x27;adduser&#x27;
    if (typeof(p[n]) !== &#x27;function&#x27;) {
      n = &#x27;add_user&#x27;
    }
    if (typeof(p[n]) !== &#x27;function&#x27;) {
      next()
    } else {
      p[n](user, password, function(err, ok) {
        if (err) return cb(err)
        if (ok) return self.authenticate(user, password, cb)
        next()
      })
    }
  })()
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
if (typeof(req.body.name) !== &#x27;string&#x27; || typeof(req.body.password) !== &#x27;string&#x27;) {
  if (typeof(req.body.password_sha)) {
    return next( Error[422](&#x27;your npm version is outdated\nPlease update to npm@1.4.5 or greater.\nSee https://github.com/r\
lidwka/sinopia/issues/93 for details.&#x27;) )
  } else {
    return next( Error[422](&#x27;user/password is not found in request (npm issue?)&#x27;) )
  }
}
auth.<span class="apidocCodeKeywordSpan">add_user</span>(req.body.name, req.body.password, function(err, user) {
  if (err) {
    if (err.status &#x3e;= 400 &#x26;&#x26; err.status &#x3c; 500) {
      // With npm registering is the same as logging in,
      // and npm accepts only an 409 error.
      // So, changing status code here.
      return next( Error[409](err.message) )
    }
...</pre></li>
    </ul>
    
    
    
    <h2>
        <a href="#apidoc.element.sinopia.auth.prototype.aes_decrypt" id="apidoc.element.sinopia.auth.prototype.aes_decrypt">
        function <span class="apidocSignatureSpan">sinopia.auth.prototype.</span>aes_decrypt
        <span class="apidocSignatureSpan">(buf)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">aes_decrypt = function (buf) {
  try {
    var c = Crypto.createDecipher(&#x27;aes192&#x27;, this.secret)
    var b1 = c.update(buf)
    var b2 = c.final()
  } catch(_) {
    return Buffer(0)
  }
  return Buffer.concat([ b1, b2 ])
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
if (parts.length !== 2)
  return next( Error[400](&#x27;bad authorization header&#x27;) )

var scheme = parts[0]
if (scheme === &#x27;Basic&#x27;) {
  var credentials = Buffer(parts[1], &#x27;base64&#x27;).toString()
} else if (scheme === &#x27;Bearer&#x27;) {
  var credentials = self.<span class="apidocCodeKeywordSpan">aes_decrypt</span>(Buffer(parts[1], &#x27;base64&#x27;)).toString(&\
#x27;utf8&#x27;)
  if (!credentials) return next()
} else {
  return next()
}

var index = credentials.indexOf(&#x27;:&#x27;)
if (index &#x3c; 0) return next()
...</pre></li>
    </ul>
    
    
    
    <h2>
        <a href="#apidoc.element.sinopia.auth.prototype.aes_encrypt" id="apidoc.element.sinopia.auth.prototype.aes_encrypt">
        function <span class="apidocSignatureSpan">sinopia.auth.prototype.</span>aes_encrypt
        <span class="apidocSignatureSpan">(buf)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">aes_encrypt = function (buf) {
  var c = Crypto.createCipher(&#x27;aes192&#x27;, this.secret)
  var b1 = c.update(buf)
  var b2 = c.final()
  return Buffer.concat([ b1, b2 ])
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  next({
    ok: &#x27;you are authenticated as &#x22;&#x27; + req.remote_user.name + &#x27;&#x22;&#x27;,
  })
})

app.put(&#x27;/-/user/:org_couchdb_user/:_rev?/:revision?&#x27;, function(req, res, next) {
  var token = (req.body.name &#x26;&#x26; req.body.password)
            ? auth.<span class="apidocCodeKeywordSpan">aes_encrypt</span>(req.body.name + &#x27;:&#x27; + req.body.password).toS\
tring(&#x27;base64&#x27;)
            : undefined
  if (req.remote_user.name != null) {
    res.status(201)
    return next({
      ok: &#x22;you are authenticated as &#x27;&#x22; + req.remote_user.name + &#x22;&#x27;&#x22;,
      //token: auth.issue_token(req.remote_user),
      token: token,
...</pre></li>
    </ul>
    
    
    
    <h2>
        <a href="#apidoc.element.sinopia.auth.prototype.allow_access" id="apidoc.element.sinopia.auth.prototype.allow_access">
        function <span class="apidocSignatureSpan">sinopia.auth.prototype.</span>allow_access
        <span class="apidocSignatureSpan">(package_name, user, callback)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">allow_access = function (package_name, user, callback) {
  var plugins = this.plugins.slice(0)
  var package = Object.assign({ name: package_name },
                              this.config.get_package_spec(package_name))

  ;(function next() {
    var p = plugins.shift()

    if (typeof(p.allow_access) !== &#x27;function&#x27;) {
      return next()
    }

    p.allow_access(user, package, function(err, ok) {
      if (err) return callback(err)
      if (ok) return callback(null, ok)
      next() // cb(null, false) causes next plugin to roll
    })
  })()
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  ;(function next() {
    var p = plugins.shift()

    if (typeof(p.allow_access) !== &#x27;function&#x27;) {
      return next()
    }

    p.<span class="apidocCodeKeywordSpan">allow_access</span>(user, package, function(err, ok) {
      if (err) return callback(err)
      if (ok) return callback(null, ok)
      next() // cb(null, false) causes next plugin to roll
    })
  })()
}
...</pre></li>
    </ul>
    
    
    
    <h2>
        <a href="#apidoc.element.sinopia.auth.prototype.allow_publish" id="apidoc.element.sinopia.auth.prototype.allow_publish">
        function <span class="apidocSignatureSpan">sinopia.auth.prototype.</span>allow_publish
        <span class="apidocSignatureSpan">(package_name, user, callback)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">allow_publish = function (package_name, user, callback) {
  var plugins = this.plugins.slice(0)
  var package = Object.assign({ name: package_name },
                              this.config.get_package_spec(package_name))

  ;(function next() {
    var p = plugins.shift()

    if (typeof(p.allow_publish) !== &#x27;function&#x27;) {
      return next()
    }

    p.allow_publish(user, package, function(err, ok) {
      if (err) return callback(err)
      if (ok) return callback(null, ok)
      next() // cb(null, false) causes next plugin to roll
    })
  })()
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  ;(function next() {
    var p = plugins.shift()

    if (typeof(p.allow_publish) !== &#x27;function&#x27;) {
      return next()
    }

    p.<span class="apidocCodeKeywordSpan">allow_publish</span>(user, package, function(err, ok) {
      if (err) return callback(err)
      if (ok) return callback(null, ok)
      next() // cb(null, false) causes next plugin to roll
    })
  })()
}
...</pre></li>
    </ul>
    
    
    
    <h2>
        <a href="#apidoc.element.sinopia.auth.prototype.authenticate" id="apidoc.element.sinopia.auth.prototype.authenticate">
        function <span class="apidocSignatureSpan">sinopia.auth.prototype.</span>authenticate
        <span class="apidocSignatureSpan">(user, password, cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">authenticate = function (user, password, cb) {
  var plugins = this.plugins.slice(0)

  ;(function next() {
    var p = plugins.shift()

    if (typeof(p.authenticate) !== &#x27;function&#x27;) {
      return next()
    }

    p.authenticate(user, password, function(err, groups) {
      if (err) return cb(err)
      if (groups != null &#x26;&#x26; groups != false)
        return cb(err, AuthenticatedUser(user, groups))
      next()
    })
  })()
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  ;(function next() {
    var p = plugins.shift()

    if (typeof(p.authenticate) !== &#x27;function&#x27;) {
      return next()
    }

    p.<span class="apidocCodeKeywordSpan">authenticate</span>(user, password, function(err, groups) {
      if (err) return cb(err)
      if (groups != null &#x26;&#x26; groups != false)
        return cb(err, AuthenticatedUser(user, groups))
      next()
    })
  })()
}
...</pre></li>
    </ul>
    
    
    
    <h2>
        <a href="#apidoc.element.sinopia.auth.prototype.basic_middleware" id="apidoc.element.sinopia.auth.prototype.basic_middleware">
        function <span class="apidocSignatureSpan">sinopia.auth.prototype.</span>basic_middleware
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">basic_middleware = function () {
  var self = this
  return function(req, res, _next) {
    req.pause()
    function next(err) {
      req.resume()
      // uncomment this to reject users with bad auth headers
      //return _next.apply(null, arguments)

      // swallow error, user remains unauthorized
      // set remoteUserError to indicate that user was attempting authentication
      if (err) req.remote_user.error = err.message
      return _next()
    }

    if (req.remote_user != null &#x26;&#x26; req.remote_user.name !== undefined)
      return next()
    req.remote_user = AnonymousUser()

    var authorization = req.headers.authorization
    if (authorization == null) return next()

    var parts = authorization.split(&#x27; &#x27;)

    if (parts.length !== 2)
      return next( Error[400](&#x27;bad authorization header&#x27;) )

    var scheme = parts[0]
    if (scheme === &#x27;Basic&#x27;) {
      var credentials = Buffer(parts[1], &#x27;base64&#x27;).toString()
    } else if (scheme === &#x27;Bearer&#x27;) {
      var credentials = self.aes_decrypt(Buffer(parts[1], &#x27;base64&#x27;)).toString(&#x27;utf8&#x27;)
      if (!credentials) return next()
    } else {
      return next()
    }

    var index = credentials.indexOf(&#x27;:&#x27;)
    if (index &#x3c; 0) return next()

    var user = credentials.slice(0, index)
    var pass = credentials.slice(index + 1)

    self.authenticate(user, pass, function(err, user) {
      if (!err) {
        req.remote_user = user
        next()
      } else {
        req.remote_user = AnonymousUser()
        next(err)
      }
    })
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
app.param(&#x27;revision&#x27;, validate_name)

// these can&#x27;t be safely put into express url for some reason
app.param(&#x27;_rev&#x27;,             match(/^-rev$/))
app.param(&#x27;org_couchdb_user&#x27;, match(/^org\.couchdb\.user:/))
app.param(&#x27;anything&#x27;,         match(/.*/))

app.use(auth.<span class="apidocCodeKeywordSpan">basic_middleware</span>())
//app.use(auth.bearer_middleware())
app.use(expressJson5({ strict: false, limit: config.max_body_size || &#x27;10mb&#x27; }))
app.use(Middleware.anti_loop(config))

// for &#x22;npm whoami&#x22;
app.get(&#x27;/whoami&#x27;, function(req, res, next) {
  if (req.headers.referer === &#x27;whoami&#x27;) {
...</pre></li>
    </ul>
    
    
    
    <h2>
        <a href="#apidoc.element.sinopia.auth.prototype.bearer_middleware" id="apidoc.element.sinopia.auth.prototype.bearer_middleware">
        function <span class="apidocSignatureSpan">sinopia.auth.prototype.</span>bearer_middleware
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">bearer_middleware = function () {
  var self = this
  return function(req, res, _next) {
    req.pause()
    function next(_err) {
      req.resume()
      return _next.apply(null, arguments)
    }

    if (req.remote_user != null &#x26;&#x26; req.remote_user.name !== undefined)
      return next()
    req.remote_user = AnonymousUser()

    var authorization = req.headers.authorization
    if (authorization == null) return next()

    var parts = authorization.split(&#x27; &#x27;)

    if (parts.length !== 2)
      return next( Error[400](&#x27;bad authorization header&#x27;) )

    var scheme = parts[0]
    var token = parts[1]

    if (scheme !== &#x27;Bearer&#x27;)
      return next()

    try {
      var user = self.decode_token(token)
    } catch(err) {
      return next(err)
    }

    req.remote_user = AuthenticatedUser(user.u, user.g)
    req.remote_user.token = token
    next()
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...

// these can&#x27;t be safely put into express url for some reason
app.param(&#x27;_rev&#x27;,             match(/^-rev$/))
app.param(&#x27;org_couchdb_user&#x27;, match(/^org\.couchdb\.user:/))
app.param(&#x27;anything&#x27;,         match(/.*/))

app.use(auth.basic_middleware())
//app.use(auth.<span class="apidocCodeKeywordSpan">bearer_middleware</span>())
app.use(expressJson5({ strict: false, limit: config.max_body_size || &#x27;10mb&#x27; }))
app.use(Middleware.anti_loop(config))

// for &#x22;npm whoami&#x22;
app.get(&#x27;/whoami&#x27;, function(req, res, next) {
  if (req.headers.referer === &#x27;whoami&#x27;) {
    next({ username: req.remote_user.name })
...</pre></li>
    </ul>
    
    
    
    <h2>
        <a href="#apidoc.element.sinopia.auth.prototype.cookie_middleware" id="apidoc.element.sinopia.auth.prototype.cookie_middleware">
        function <span class="apidocSignatureSpan">sinopia.auth.prototype.</span>cookie_middleware
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">cookie_middleware = function () {
  var self = this
  return function(req, res, _next) {
    req.pause()
    function next(_err) {
      req.resume()
      return _next()
    }

    if (req.remote_user != null &#x26;&#x26; req.remote_user.name !== undefined)
      return next()

    req.remote_user = AnonymousUser()

    var token = req.cookies.get(&#x27;token&#x27;)
    if (token == null) return next()

<span class="apidocCodeCommentSpan">    /*try {
      var user = self.decode_token(token, 60*60)
    } catch(err) {
      return next()
    }

    req.remote_user = AuthenticatedUser(user.u, user.g)
    req.remote_user.token = token
    next()*/
</span>    var credentials = self.aes_decrypt(Buffer(token, &#x27;base64&#x27;)).toString(&#x27;utf8&#x27;)
    if (!credentials) return next()

    var index = credentials.indexOf(&#x27;:&#x27;)
    if (index &#x3c; 0) return next()

    var user = credentials.slice(0, index)
    var pass = credentials.slice(index + 1)

    self.authenticate(user, pass, function(err, user) {
      if (!err) {
        req.remote_user = user
        next()
      } else {
        req.remote_user = AnonymousUser()
        next(err)
      }
    })
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
app.param(&#x27;package&#x27;,  validate_pkg)
app.param(&#x27;filename&#x27;, validate_name)
app.param(&#x27;version&#x27;,  validate_name)
app.param(&#x27;anything&#x27;, match(/.*/))

app.use(Cookies.express())
app.use(bodyParser.urlencoded({ extended: false }))
app.use(auth.<span class="apidocCodeKeywordSpan">cookie_middleware</span>())
app.use(function(req, res, next) {
  // disable loading in frames (clickjacking, etc.)
  res.header(&#x27;X-Frame-Options&#x27;, &#x27;deny&#x27;)
  next()
})

Search.configureStorage(storage)
...</pre></li>
    </ul>
    
    
    
    <h2>
        <a href="#apidoc.element.sinopia.auth.prototype.decode_token" id="apidoc.element.sinopia.auth.prototype.decode_token">
        function <span class="apidocSignatureSpan">sinopia.auth.prototype.</span>decode_token
        <span class="apidocSignatureSpan">(str, expire_time)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">decode_token = function (str, expire_time) {
  var buf = Buffer(str, &#x27;base64&#x27;)
  if (buf.length &#x3c;= 32) throw Error[401](&#x27;invalid token&#x27;)

  var data      = buf.slice(0, buf.length - 32)
  var their_mac = buf.slice(buf.length - 32)
  var good_mac  = Crypto.createHmac(&#x27;sha256&#x27;, this.secret).update(data).digest()

  their_mac = Crypto.createHash(&#x27;sha512&#x27;).update(their_mac).digest(&#x27;hex&#x27;)
  good_mac  = Crypto.createHash(&#x27;sha512&#x27;).update(good_mac).digest(&#x27;hex&#x27;)
  if (their_mac !== good_mac) throw Error[401](&#x27;bad signature&#x27;)

  // make token expire in 24 hours
  // TODO: make configurable?
  expire_time = expire_time || 24*60*60

  data = jju.parse(data.toString(&#x27;utf8&#x27;))
  if (Math.abs(data.t - ~~(Date.now()/1000)) &#x3e; expire_time)
    throw Error[401](&#x27;token expired&#x27;)

  return data
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
var scheme = parts[0]
var token = parts[1]

if (scheme !== &#x27;Bearer&#x27;)
  return next()

try {
  var user = self.<span class="apidocCodeKeywordSpan">decode_token</span>(token)
} catch(err) {
  return next(err)
}

req.remote_user = AuthenticatedUser(user.u, user.g)
req.remote_user.token = token
next()
...</pre></li>
    </ul>
    
    
    
    <h2>
        <a href="#apidoc.element.sinopia.auth.prototype.issue_token" id="apidoc.element.sinopia.auth.prototype.issue_token">
        function <span class="apidocSignatureSpan">sinopia.auth.prototype.</span>issue_token
        <span class="apidocSignatureSpan">(user)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">issue_token = function (user) {
  var data = jju.stringify({
    u: user.name,
    g: user.real_groups &#x26;&#x26; user.real_groups.length ? user.real_groups : undefined,
    t: ~~(Date.now()/1000),
  }, { indent: false })

  data = Buffer(data, &#x27;utf8&#x27;)
  var mac = Crypto.createHmac(&#x27;sha256&#x27;, this.secret).update(data).digest()
  return Buffer.concat([ data, mac ]).toString(&#x27;base64&#x27;)
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
var token = (req.body.name &#x26;&#x26; req.body.password)
          ? auth.aes_encrypt(req.body.name + &#x27;:&#x27; + req.body.password).toString(&#x27;base64&#x27;)
          : undefined
if (req.remote_user.name != null) {
  res.status(201)
  return next({
    ok: &#x22;you are authenticated as &#x27;&#x22; + req.remote_user.name + &#x22;&#x27;&#x22;,
    //token: auth.<span class="apidocCodeKeywordSpan">issue_token</span>(req.remote_user),
    token: token,
  })
} else {
  if (typeof(req.body.name) !== &#x27;string&#x27; || typeof(req.body.password) !== &#x27;string&#x27;) {
    if (typeof(req.body.password_sha)) {
      return next( Error[422](&#x27;your npm version is outdated\nPlease update to npm@1.4.5 or greater.\nSee https://github.com\
/rlidwka/sinopia/issues/93 for details.&#x27;) )
    } else {
...</pre></li>
    </ul>
    
    
</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.sinopia.config" id="apidoc.module.sinopia.config">module sinopia.config</a></h1>
    
    
    <h2>
        <a href="#apidoc.element.sinopia.config.config" id="apidoc.element.sinopia.config.config">
        function <span class="apidocSignatureSpan">sinopia.</span>config
        <span class="apidocSignatureSpan">(config)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function Config(config) {
  var self = Object.create(Config.prototype)
  for (var i in config) {
    if (self[i] == null) self[i] = config[i]
  }
  if (!self.user_agent) self.user_agent = &#x27;Sinopia/&#x27;+pkg.version

  // some weird shell scripts are valid yaml files parsed as string
  assert.equal(typeof(config), &#x27;object&#x27;, &#x27;CONFIG: it doesn\&#x27;t look like a valid config file&#x27;)

  assert(self.storage, &#x27;CONFIG: storage path not defined&#x27;)
  self.localList = LocalData(
    Path.join(
      Path.resolve(Path.dirname(self.self_path), self.storage),
      &#x27;.sinopia-db.json&#x27;
    )
  )
  if (!self.secret) {
    self.secret = self.localList.data.secret

    if (!self.secret) {
      self.secret = Crypto.pseudoRandomBytes(32).toString(&#x27;hex&#x27;)
      self.localList.data.secret = self.secret
      self.localList.sync()
    }
  }

  var users = {all:true, anonymous:true, &#x27;undefined&#x27;:true, owner:true, none:true}

  var check_user_or_uplink = function(arg) {
    assert(arg !== &#x27;all&#x27; &#x26;&#x26; arg !== &#x27;owner&#x27; &#x26;&#x26; arg !== &#x27;anonymous&#x27; &#x26;&#x26; arg !== &#x27;undefined&#x27; &#x26;&#x26; arg !== &#x27;none&#x27;, &#x27;CONFIG: reserved u\
ser/uplink name: &#x27; + arg)
    assert(!arg.match(/\s/), &#x27;CONFIG: invalid user name: &#x27; + arg)
    assert(users[arg] == null, &#x27;CONFIG: duplicate user/uplink name: &#x27; + arg)
    users[arg] = true
  }

  ;[ &#x27;users&#x27;, &#x27;uplinks&#x27;, &#x27;packages&#x27; ].forEach(function(x) {
    if (self[x] == null) self[x] = {}
    assert(Utils.is_object(self[x]), &#x27;CONFIG: bad &#x22;&#x27;+x+&#x27;&#x22; value (object expected)&#x27;)
  })

  for (var i in self.users) check_user_or_uplink(i)
  for (var i in self.uplinks) check_user_or_uplink(i)

  for (var i in self.users) {
    assert(self.users[i].password, &#x27;CONFIG: no password for user: &#x27; + i)
    assert(
      typeof(self.users[i].password) === &#x27;string&#x27; &#x26;&#x26;
      self.users[i].password.match(/^[a-f0-9]{40}$/)
    , &#x27;CONFIG: wrong password format for user: &#x27; + i + &#x27;, sha1 expected&#x27;)
  }

  for (var i in self.uplinks) {
    assert(self.uplinks[i].url, &#x27;CONFIG: no url for uplink: &#x27; + i)
    assert( typeof(self.uplinks[i].url) === &#x27;string&#x27;
          , &#x27;CONFIG: wrong url format for uplink: &#x27; + i)
    self.uplinks[i].url = self.uplinks[i].url.replace(/\/$/, &#x27;&#x27;)
  }

  function normalize_userlist() {
    var result = []

    for (var i=0; i&#x3c;arguments.length; i++) {
      if (arguments[i] == null) continue

      // if it&#x27;s a string, split it to array
      if (typeof(arguments[i]) === &#x27;string&#x27;) {
        result.push(arguments[i].split(/\s+/))
      } else if (Array.isArray(arguments[i])) {
        result.push(arguments[i])
      } else {
        throw Error(&#x27;CONFIG: bad package acl (array or string expected): &#x27; + JSON.stringify(arguments[i]))
      }
    }
    return flatten(result)
  }

  // add a default rule for all packages to make writing plugins easier
  if (self.packages[&#x27;**&#x27;] == null) {
    self.packages[&#x27;**&#x27;] = {}
  }

  for (var i in self.packages) {
    assert(
      typeof(self.packages[i]) === &#x27;object&#x27; &#x26;&#x26;
      !Array.isArray(self.packages[i])
    , &#x27;CONFIG: bad &#x22;&#x27;+i+&#x27;&#x22; package description (object expected)&#x27;)

    self.packages[i].access = normalize_userlist(
      self.packages[i].allow_access,
      self.packages[i].access
    );
    delete self.packages[i].allow_access

    self.packages[i].publish = normalize_userlist(
      self.packages[i].allow_publish,
      self.packages[i].publish
    );
    delete self.packages[i].allow_publish

    self.packages[i].proxy = normalize_userlist(
      self.packages[i].proxy_access,
      self.packages[i].proxy
    );
    delete self.packages[i].proxy_access
  }

  // loading these from ENV if aren&#x27;t in config
  ;[ &#x27;http_proxy&#x27;, &#x27;https_proxy&#x27;, &#x27;no_proxy&#x27; ].forEach((function(v) {
    if (!(v in self)) {
      self[v] = process.env[v] || process.env[v.toUpperCase()]
    }
  }).bind(self))

  // unique identifier of self server (or a cluster), used to avoid loops
  if (!self.server_id) {
    self.server_id = Crypto.pseudoRandomBytes(6).toString(&#x27;hex&#x27;)
  }

  if (self.ignore_latest_tag == null) self.ignore_latest_tag = false

  return self
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>
    
    
    
    <h2>
        <a href="#apidoc.element.sinopia.config.parse_interval" id="apidoc.element.sinopia.config.parse_interval">
        function <span class="apidocSignatureSpan">sinopia.config.</span>parse_interval
        <span class="apidocSignatureSpan">(interval)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">parse_interval = function (interval) {
  if (typeof(interval) === &#x27;number&#x27;) return interval * 1000

  var result = 0
  var last_suffix = Infinity
  interval.split(/\s+/).forEach(function(x) {
    if (!x) return
    var m = x.match(/^((0|[1-9][0-9]*)(\.[0-9]+)?)(ms|s|m|h|d|w|M|y|)$/)
    if (!m
    ||  parse_interval_table[m[4]] &#x3e;= last_suffix
    ||  (m[4] === &#x27;&#x27; &#x26;&#x26; last_suffix !== Infinity)) {
      throw Error(&#x27;invalid interval: &#x27; + interval)
    }
    last_suffix = parse_interval_table[m[4]]
    result += Number(m[1]) * parse_interval_table[m[4]]
  })
  return result
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>
    
    
</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.sinopia.config.prototype" id="apidoc.module.sinopia.config.prototype">module sinopia.config.prototype</a></h1>
    
    
    <h2>
        <a href="#apidoc.element.sinopia.config.prototype.can_proxy_to" id="apidoc.element.sinopia.config.prototype.can_proxy_to">
        function <span class="apidocSignatureSpan">sinopia.config.prototype.</span>can_proxy_to
        <span class="apidocSignatureSpan">(package, uplink)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">can_proxy_to = function (package, uplink) {
  return (this.get_package_spec(package).proxy || []).reduce(function(prev, curr) {
    if (uplink === curr) return true
    return prev
  }, false)
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  }
} else {
  var exists = true
}

var uplinks = []
for (var i in self.uplinks) {
  if (self.config.<span class="apidocCodeKeywordSpan">can_proxy_to</span>(name, i)) {
    uplinks.push(self.uplinks[i])
  }
}

async.map(uplinks, function(up, cb) {
  var _options = Object.assign({}, options)
  if (Utils.is_object(pkginfo._uplinks[up.upname])) {
...</pre></li>
    </ul>
    
    
    
    <h2>
        <a href="#apidoc.element.sinopia.config.prototype.get_package_spec" id="apidoc.element.sinopia.config.prototype.get_package_spec">
        function <span class="apidocSignatureSpan">sinopia.config.prototype.</span>get_package_spec
        <span class="apidocSignatureSpan">(package)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">get_package_spec = function (package) {
  for (var i in this.packages) {
    if (minimatch.makeRe(i).exec(package)) {
      return this.packages[i]
    }
  }
  return {}
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
}
  })()
}

Auth.prototype.allow_access = function(package_name, user, callback) {
  var plugins = this.plugins.slice(0)
  var package = Object.assign({ name: package_name },
                          this.config.<span class="apidocCodeKeywordSpan">get_package_spec</span>(package_name))

  ;(function next() {
var p = plugins.shift()

if (typeof(p.allow_access) !== &#x27;function&#x27;) {
  return next()
}
...</pre></li>
    </ul>
    
    
</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.sinopia.local_data" id="apidoc.module.sinopia.local_data">module sinopia.local_data</a></h1>
    
    
    <h2>
        <a href="#apidoc.element.sinopia.local_data.local_data" id="apidoc.element.sinopia.local_data.local_data">
        function <span class="apidocSignatureSpan">sinopia.</span>local_data
        <span class="apidocSignatureSpan">(path)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function LocalData(path) {
  var self = Object.create(LocalData.prototype)
  self.path = path
  try {
    self.data = JSON.parse(fs.readFileSync(self.path, &#x27;utf8&#x27;))
  } catch(_) {
    self.data = { list: [] }
  }
  return self
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>
    
    
</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.sinopia.local_data.prototype" id="apidoc.module.sinopia.local_data.prototype">module sinopia.local_data.prototype</a></h1>
    
    
    <h2>
        <a href="#apidoc.element.sinopia.local_data.prototype.add" id="apidoc.element.sinopia.local_data.prototype.add">
        function <span class="apidocSignatureSpan">sinopia.local_data.prototype.</span>add
        <span class="apidocSignatureSpan">(name)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">add = function (name) {
  if (this.data.list.indexOf(name) === -1) {
    this.data.list.push(name)
    this.sync()
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
storage.create_json(info_file, get_boilerplate(name), function(err) {
  if (err &#x26;&#x26; err.code === &#x27;EEXISTS&#x27;) {
    return callback( Error[409](&#x27;this package is already present&#x27;) )
  }

  var latest = info[&#x27;dist-tags&#x27;].latest
  if (latest &#x26;&#x26; info.versions[latest]) {
    Search.<span class="apidocCodeKeywordSpan">add</span>(info.versions[latest])
  }
  callback()
})
}

Storage.prototype.remove_package = function(name, callback) {
var self = this
...</pre></li>
    </ul>
    
    
    
    <h2>
        <a href="#apidoc.element.sinopia.local_data.prototype.get" id="apidoc.element.sinopia.local_data.prototype.get">
        function <span class="apidocSignatureSpan">sinopia.local_data.prototype.</span>get
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">get = function () {
  return this.data.list
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
}

if (req.remote_user != null &#x26;&#x26; req.remote_user.name !== undefined)
  return next()

req.remote_user = AnonymousUser()

var token = req.cookies.<span class="apidocCodeKeywordSpan">get</span>(&#x27;token&#x27;)
if (token == null) return next()

/*try {
  var user = self.decode_token(token, 60*60)
} catch(err) {
  return next()
}
...</pre></li>
    </ul>
    
    
    
    <h2>
        <a href="#apidoc.element.sinopia.local_data.prototype.remove" id="apidoc.element.sinopia.local_data.prototype.remove">
        function <span class="apidocSignatureSpan">sinopia.local_data.prototype.</span>remove
        <span class="apidocSignatureSpan">(name)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">remove = function (name) {
  var i = this.data.list.indexOf(name)
  if (i !== -1) {
    this.data.list.splice(i, 1)
  }

  this.sync()
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
      storage.rmdir(&#x27;.&#x27;, function(err) {
        callback(err)
      })
    })
  })
})

Search.<span class="apidocCodeKeywordSpan">remove</span>(name)
this.config.localList.remove(name)
}

Storage.prototype._read_create_package = function(name, callback) {
var self = this
var storage = self.storage(name)
if (!storage) {
...</pre></li>
    </ul>
    
    
    
    <h2>
        <a href="#apidoc.element.sinopia.local_data.prototype.sync" id="apidoc.element.sinopia.local_data.prototype.sync">
        function <span class="apidocSignatureSpan">sinopia.local_data.prototype.</span>sync
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">sync = function () {
  // Uses sync to prevent ugly race condition
  try {
    require(&#x27;mkdirp&#x27;).sync(Path.dirname(this.path))
  } catch(err) {}
  fs.writeFileSync(this.path, JSON.stringify(this.data))
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
}

create_config_file(paths[0])
return paths[0].path
}

function create_config_file(config_path) {
require(&#x27;mkdirp&#x27;).<span class="apidocCodeKeywordSpan">sync</span>(Path.dirname(config_path.path))
logger.logger.info({ file: config_path.path }, &#x27;Creating default config file in @{file}&#x27;)

var created_config = fs.readFileSync(require.resolve(&#x27;../conf/default.yaml&#x27;), &#x27;utf8&#x27;)

if (config_path.type === &#x27;xdg&#x27;) {
  var data_dir = process.env.XDG_DATA_HOME
              || Path.join(process.env.HOME, &#x27;.local&#x27;, &#x27;share&#x27;)
...</pre></li>
    </ul>
    
    
</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.sinopia.local_fs" id="apidoc.module.sinopia.local_fs">module sinopia.local_fs</a></h1>
    
    
    <h2>
        <a href="#apidoc.element.sinopia.local_fs.create" id="apidoc.element.sinopia.local_fs.create">
        function <span class="apidocSignatureSpan">sinopia.local_fs.</span>create
        <span class="apidocSignatureSpan">(name, contents, callback)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function create(name, contents, callback) {
  fs.exists(name, function(exists) {
    if (exists) return callback( FSError(&#x27;EEXISTS&#x27;) )
    write(name, contents, callback)
  })
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
var Error        = require(&#x27;http-errors&#x27;)
var Logger       = require(&#x27;./logger&#x27;)
var load_plugins = require(&#x27;./plugin-loader&#x27;).load_plugins

module.exports = Auth

function Auth(config) {
var self = Object.<span class="apidocCodeKeywordSpan">create</span>(Auth.prototype)
self.config = config
self.logger = Logger.logger.child({ sub: &#x27;auth&#x27; })
self.secret = config.secret

var plugin_params = {
  config: config,
  logger: self.logger
...</pre></li>
    </ul>
    
    
    
    <h2>
        <a href="#apidoc.element.sinopia.local_fs.create_json" id="apidoc.element.sinopia.local_fs.create_json">
        function <span class="apidocSignatureSpan">sinopia.local_fs.</span>create_json
        <span class="apidocSignatureSpan">(name, value, cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">create_json = function (name, value, cb) {
  create(name, JSON.stringify(value, null, &#x27;\t&#x27;), cb)
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  return Error[500]()
}

Storage.prototype.add_package = function(name, info, callback) {
  var storage = this.storage(name)
  if (!storage) return callback( Error[404](&#x27;this package cannot be added&#x27;) )

  storage.<span class="apidocCodeKeywordSpan">create_json</span>(info_file, get_boilerplate(name), function(err) {
if (err &#x26;&#x26; err.code === &#x27;EEXISTS&#x27;) {
  return callback( Error[409](&#x27;this package is already present&#x27;) )
}

var latest = info[&#x27;dist-tags&#x27;].latest
if (latest &#x26;&#x26; info.versions[latest]) {
  Search.add(info.versions[latest])
...</pre></li>
    </ul>
    
    
    
    <h2>
        <a href="#apidoc.element.sinopia.local_fs.lock_and_read" id="apidoc.element.sinopia.local_fs.lock_and_read">
        function <span class="apidocSignatureSpan">sinopia.local_fs.</span>lock_and_read
        <span class="apidocSignatureSpan">(name, _callback)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function lock_and_read(name, _callback) {
  open_flock(name, &#x27;r&#x27;, &#x27;exnb&#x27;, 4, 10, function(err, fd) {
    function callback(err) {
      if (err &#x26;&#x26; fd) {
        fs.close(fd, function(err2) {
          _callback(err)
        })
      } else {
        _callback.apply(null, arguments)
      }
    }

    if (err) return callback(err, fd)

    fs.fstat(fd, function(err, st) {
      if (err) return callback(err, fd)

      var buffer = Buffer(st.size)
      if (st.size === 0) return onRead(null, 0, buffer)
      fs.read(fd, buffer, 0, st.size, null, onRead)

      function onRead(err, bytesRead, buffer) {
        if (err) return callback(err, fd)
        if (bytesRead != st.size) return callback(Error(&#x27;st.size != bytesRead&#x27;), fd)

        callback(null, fd, buffer)
      }
    })
  })
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>
    
    
    
    <h2>
        <a href="#apidoc.element.sinopia.local_fs.lock_and_read_json" id="apidoc.element.sinopia.local_fs.lock_and_read_json">
        function <span class="apidocSignatureSpan">sinopia.local_fs.</span>lock_and_read_json
        <span class="apidocSignatureSpan">(name, cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">lock_and_read_json = function (name, cb) {
  lock_and_read(name, function(err, fd, res) {
    if (err) return cb(err, fd)

    var args = []
    try {
      args = [ null, fd, JSON.parse(res.toString(&#x27;utf8&#x27;)) ]
    } catch(err) {
      args = [ err, fd ]
    }
    cb.apply(null, args)
  })
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
// 5. move package.json.tmp package.json
// 6. callback(err?)
//
Storage.prototype.update_package = function(name, updateFn, _callback) {
var self = this
var storage = self.storage(name)
if (!storage) return _callback( Error[404](&#x27;no such package available&#x27;) )
storage.<span class="apidocCodeKeywordSpan">lock_and_read_json</span>(info_file, function(err, fd, json) {
  function callback() {
    var _args = arguments
    if (fd) {
      fs.close(fd, function(err) {
        if (err) return _callback(err)
        _callback.apply(null, _args)
      })
...</pre></li>
    </ul>
    
    
    
    <h2>
        <a href="#apidoc.element.sinopia.local_fs.read" id="apidoc.element.sinopia.local_fs.read">
        function <span class="apidocSignatureSpan">sinopia.local_fs.</span>read
        <span class="apidocSignatureSpan">(name, callback)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function read(name, callback) {
  fs.readFile(name, callback)
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
    if (err) return callback(err, fd)

    fs.fstat(fd, function(err, st) {
if (err) return callback(err, fd)

var buffer = Buffer(st.size)
if (st.size === 0) return onRead(null, 0, buffer)
fs.<span class="apidocCodeKeywordSpan">read</span>(fd, buffer, 0, st.size, null, onRead)

function onRead(err, bytesRead, buffer) {
  if (err) return callback(err, fd)
  if (bytesRead != st.size) return callback(Error(&#x27;st.size != bytesRead&#x27;), fd)

  callback(null, fd, buffer)
}
...</pre></li>
    </ul>
    
    
    
    <h2>
        <a href="#apidoc.element.sinopia.local_fs.read_json" id="apidoc.element.sinopia.local_fs.read_json">
        function <span class="apidocSignatureSpan">sinopia.local_fs.</span>read_json
        <span class="apidocSignatureSpan">(name, cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">read_json = function (name, cb) {
  read(name, function(err, res) {
    if (err) return cb(err)

    var args = []
    try {
      args = [ null, JSON.parse(res.toString(&#x27;utf8&#x27;)) ]
    } catch(err) {
      args = [ err ]
    }
    cb.apply(null, args)
  })
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
var self = this
self.logger.info( { name: name }
                , &#x27;unpublishing @{name} (all)&#x27;)

var storage = self.storage(name)
if (!storage) return callback( Error[404](&#x27;no such package available&#x27;) )

storage.<span class="apidocCodeKeywordSpan">read_json</span>(info_file, function(err, data) {
  if (err) {
    if (err.code === &#x27;ENOENT&#x27;) {
      return callback( Error[404](&#x27;no such package available&#x27;) )
    } else {
      return callback(err)
    }
  }
...</pre></li>
    </ul>
    
    
    
    <h2>
        <a href="#apidoc.element.sinopia.local_fs.read_stream" id="apidoc.element.sinopia.local_fs.read_stream">
        function <span class="apidocSignatureSpan">sinopia.local_fs.</span>read_stream
        <span class="apidocSignatureSpan">(name, stream, callback)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function read_stream(name, stream, callback) {
  var rstream = fs.createReadStream(name)
  rstream.on(&#x27;error&#x27;, function(err) {
    stream.emit(&#x27;error&#x27;, err)
  })
  rstream.on(&#x27;open&#x27;, function(fd) {
    fs.fstat(fd, function(err, stats) {
      if (err) return stream.emit(&#x27;error&#x27;, err)
      stream.emit(&#x27;content-length&#x27;, stats.size)
      stream.emit(&#x27;open&#x27;)
      rstream.pipe(stream)
    })
  })

  var stream = MyStreams.ReadTarballStream()
  stream.abort = function() {
    rstream.close()
  }
  return stream
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
if (!storage) {
  process.nextTick(function() {
    stream.emit(&#x27;error&#x27;, Error[404](&#x27;no such file available&#x27;))
  })
  return stream
}

var rstream = storage.<span class="apidocCodeKeywordSpan">read_stream</span>(filename)
rstream.on(&#x27;error&#x27;, function(err) {
  if (err &#x26;&#x26; err.code === &#x27;ENOENT&#x27;) {
    stream.emit(&#x27;error&#x27;, Error(404, &#x27;no such file available&#x27;))
  } else {
    stream.emit(&#x27;error&#x27;, err)
  }
})
...</pre></li>
    </ul>
    
    
    
    <h2>
        <a href="#apidoc.element.sinopia.local_fs.rmdir" id="apidoc.element.sinopia.local_fs.rmdir">
        function <span class="apidocSignatureSpan">sinopia.local_fs.</span>rmdir
        <span class="apidocSignatureSpan">(path, callback)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">rmdir = function (path, callback) {
  callback = maybeCallback(callback);
  if (handleError((path = getPathFromURL(path)), callback))
    return;
  if (!nullCheck(path, callback)) return;
  var req = new FSReqWrap();
  req.oncomplete = callback;
  binding.rmdir(pathModule._makeLong(path), req);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
      storage.unlink(file, function() {
        unlinkNext(cb)
      })
    }

    unlinkNext(function() {
      // try to unlink the directory, but ignore errors because it can fail
      storage.<span class="apidocCodeKeywordSpan">rmdir</span>(&#x27;.&#x27;, function(err) {
        callback(err)
      })
    })
  })
})

Search.remove(name)
...</pre></li>
    </ul>
    
    
    
    <h2>
        <a href="#apidoc.element.sinopia.local_fs.unlink" id="apidoc.element.sinopia.local_fs.unlink">
        function <span class="apidocSignatureSpan">sinopia.local_fs.</span>unlink
        <span class="apidocSignatureSpan">(path, callback)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">unlink = function (path, callback) {
  callback = makeCallback(callback);
  if (handleError((path = getPathFromURL(path)), callback))
    return;
  if (!nullCheck(path, callback)) return;
  var req = new FSReqWrap();
  req.oncomplete = callback;
  binding.unlink(pathModule._makeLong(path), req);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...

function tempFile(str) {
return str + &#x27;.tmp&#x27; + String(Math.random()).substr(2)
}

function renameTmp(src, dst, _cb) {
function cb(err) {
  if (err) fs.<span class="apidocCodeKeywordSpan">unlink</span>(src)
  _cb(err)
}

if (process.platform !== &#x27;win32&#x27;) {
  return fs.rename(src, dst, cb)
}
...</pre></li>
    </ul>
    
    
    
    <h2>
        <a href="#apidoc.element.sinopia.local_fs.update" id="apidoc.element.sinopia.local_fs.update">
        function <span class="apidocSignatureSpan">sinopia.local_fs.</span>update
        <span class="apidocSignatureSpan">(name, contents, callback)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function update(name, contents, callback) {
  fs.exists(name, function(exists) {
    if (!exists) return callback( FSError(&#x27;ENOENT&#x27;) )
    write(name, contents, callback)
  })
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...

  self.plugins.unshift({
sinopia_version: &#x27;1.1.0&#x27;,

authenticate: function(user, password, cb) {
  if (config.users != null
   &#x26;&#x26; config.users[user] != null
   &#x26;&#x26; (Crypto.createHash(&#x27;sha1&#x27;).<span class="apidocCodeKeywordSpan">update</span>(password).digest(&#x27;he\
x&#x27;)
        === config.users[user].password)
  ) {
    return cb(null, [ user ])
  }

  return cb()
},
...</pre></li>
    </ul>
    
    
    
    <h2>
        <a href="#apidoc.element.sinopia.local_fs.update_json" id="apidoc.element.sinopia.local_fs.update_json">
        function <span class="apidocSignatureSpan">sinopia.local_fs.</span>update_json
        <span class="apidocSignatureSpan">(name, value, cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">update_json = function (name, value, cb) {
  update(name, JSON.stringify(value, null, &#x27;\t&#x27;), cb)
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>
    
    
    
    <h2>
        <a href="#apidoc.element.sinopia.local_fs.write" id="apidoc.element.sinopia.local_fs.write">
        function <span class="apidocSignatureSpan">sinopia.local_fs.</span>write
        <span class="apidocSignatureSpan">(dest, data, cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function write(dest, data, cb) {
  var safe_write = function(cb) {
    var tmpname = tempFile(dest)
    fs.writeFile(tmpname, data, function(err) {
      if (err) return cb(err)
      renameTmp(tmpname, dest, cb)
    })
  }

  safe_write(function(err) {
    if (err &#x26;&#x26; err.code === &#x27;ENOENT&#x27;) {
      mkdirp(Path.dirname(dest), function(err) {
        if (err) return cb(err)
        safe_write(cb)
      })
    } else {
      cb(err)
    }
  })
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  // searching packages
  app.get(&#x27;/-/all/:anything?&#x27;, function(req, res, next) {
    var received_end      = false
    var response_finished = false
    var processing_pkgs   = 0

    res.status(200)
    res.<span class="apidocCodeKeywordSpan">write</span>(&#x27;{&#x22;_updated&#x22;:&#x27; + Date.now());

    var stream = storage.search(req.param.startkey || 0, { req: req })

    stream.on(&#x27;data&#x27;, function each(pkg) {
processing_pkgs++

auth.allow_access(pkg.name, req.remote_user, function(err, allowed) {
...</pre></li>
    </ul>
    
    
    
    <h2>
        <a href="#apidoc.element.sinopia.local_fs.write_json" id="apidoc.element.sinopia.local_fs.write_json">
        function <span class="apidocSignatureSpan">sinopia.local_fs.</span>write_json
        <span class="apidocSignatureSpan">(name, value, cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">write_json = function (name, value, cb) {
  write(name, JSON.stringify(value, null, &#x27;\t&#x27;), cb)
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
// calculate revision a la couchdb
if (typeof(json._rev) !== &#x27;string&#x27;) json._rev = &#x27;0-0000000000000000&#x27;
var rev = json._rev.split(&#x27;-&#x27;)
json._rev = ((+rev[0] || 0) + 1) + &#x27;-&#x27; + Crypto.pseudoRandomBytes(8).toString(&#x27;hex&#x27;)

var storage = this.storage(name)
if (!storage) return callback()
storage.<span class="apidocCodeKeywordSpan">write_json</span>(info_file, json, callback)
}

Storage.prototype.storage = function(package) {
var path = this.config.get_package_spec(package).storage
if (path == null) path = this.config.storage
if (path == null || path === false) {
  this.logger.debug( { name: package }
...</pre></li>
    </ul>
    
    
    
    <h2>
        <a href="#apidoc.element.sinopia.local_fs.write_stream" id="apidoc.element.sinopia.local_fs.write_stream">
        function <span class="apidocSignatureSpan">sinopia.local_fs.</span>write_stream
        <span class="apidocSignatureSpan">(name)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function write_stream(name) {
  var stream = MyStreams.UploadTarballStream()

  var _ended = 0
  stream.on(&#x27;end&#x27;, function() {
    _ended = 1
  })

  fs.exists(name, function(exists) {
    if (exists) return stream.emit(&#x27;error&#x27;, FSError(&#x27;EEXISTS&#x27;))

    var tmpname = name + &#x27;.tmp-&#x27;+String(Math.random()).replace(/^0\./, &#x27;&#x27;)
    var file = fs.createWriteStream(tmpname)
    var opened = false
    stream.pipe(file)

    stream.done = function() {
      function onend() {
        file.on(&#x27;close&#x27;, function() {
          renameTmp(tmpname, name, function(err) {
            if (err) {
              stream.emit(&#x27;error&#x27;, err)
            } else {
              stream.emit(&#x27;success&#x27;)
            }
          })
        })
        file.destroySoon()
      }
      if (_ended) {
        onend()
      } else {
        stream.on(&#x27;end&#x27;, onend)
      }
    }
    stream.abort = function() {
      if (opened) {
        opened = false
        file.on(&#x27;close&#x27;, function() {
          fs.unlink(tmpname, function(){})
        })
      }
      file.destroySoon()
    }
    file.on(&#x27;open&#x27;, function() {
      opened = true
      // re-emitting open because it&#x27;s handled in storage.js
      stream.emit(&#x27;open&#x27;)
    })
    file.on(&#x27;error&#x27;, function(err) {
      stream.emit(&#x27;error&#x27;, err)
    })
  })
  return stream
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
if (!storage) {
  process.nextTick(function() {
    stream.emit(&#x27;error&#x27;, Error[404](&#x22;can&#x27;t upload this package&#x22;))
  })
  return stream
}

var wstream = storage.<span class="apidocCodeKeywordSpan">write_stream</span>(filename)

wstream.on(&#x27;error&#x27;, function(err) {
  if (err.code === &#x27;EEXISTS&#x27;) {
    stream.emit(&#x27;error&#x27;, Error[409](&#x27;this tarball is already present&#x27;))
  } else if (err.code === &#x27;ENOENT&#x27;) {
    // check if package exists to throw an appropriate message
    self.get_package(name, function(_err, res) {
...</pre></li>
    </ul>
    
    
</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.sinopia.local_storage" id="apidoc.module.sinopia.local_storage">module sinopia.local_storage</a></h1>
    
    
    <h2>
        <a href="#apidoc.element.sinopia.local_storage.local_storage" id="apidoc.element.sinopia.local_storage.local_storage">
        function <span class="apidocSignatureSpan">sinopia.</span>local_storage
        <span class="apidocSignatureSpan">(config)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function Storage(config) {
  var self = Object.create(Storage.prototype)
  self.config = config
  self.logger = Logger.logger.child({ sub: &#x27;fs&#x27; })
  return self
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>
    
    
</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.sinopia.local_storage.prototype" id="apidoc.module.sinopia.local_storage.prototype">module sinopia.local_storage.prototype</a></h1>
    
    
    <h2>
        <a href="#apidoc.element.sinopia.local_storage.prototype._each_package" id="apidoc.element.sinopia.local_storage.prototype._each_package">
        function <span class="apidocSignatureSpan">sinopia.local_storage.prototype.</span>_each_package
        <span class="apidocSignatureSpan">(on_package, on_end)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">_each_package = function (on_package, on_end) {
  var self = this
  var storages = {}

  storages[self.config.storage] = true

  if (self.config.packages) {
    Object.keys(self.packages || {}).map(function (pkg) {
      if (self.config.packages[pkg].storage) {
        storages[self.config.packages[pkg].storage] = true
      }
    })
  }

  var base = Path.dirname(self.config.self_path);

  async.eachSeries(Object.keys(storages), function (storage, cb) {
    fs.readdir(Path.resolve(base, storage), function (err, files) {
      if (err) return cb(err)

      async.eachSeries(files, function (file, cb) {
        if (file.match(/^@/)) {
          // scoped
          fs.readdir(Path.resolve(base, storage, file), function (err, files) {
            if (err) return cb(err)

            async.eachSeries(files, function (file2, cb) {
              if (Utils.validate_name(file2)) {
                on_package({
                  name: file + &#x27;/&#x27; + file2,
                  path: Path.resolve(base, storage, file, file2),
                }, cb)
              } else {
                cb()
              }
            }, cb)
          })
        } else if (Utils.validate_name(file)) {
          on_package({
            name: file,
            path: Path.resolve(base, storage, file)
          }, cb)
        } else {
          cb()
        }
      }, cb)
    })
  }, on_end)
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
}

Storage.prototype.search = function(startkey, options) {
  var self = this

  var stream = new Stream.PassThrough({ objectMode: true })

  self.<span class="apidocCodeKeywordSpan">_each_package</span>(function on_package(item, cb) {
    fs.stat(item.path, function(err, stats) {
if (err) return cb(err)

if (stats.mtime &#x3e; startkey) {
  self.get_package(item.name, options, function(err, data) {
    if (err) return cb(err)
...</pre></li>
    </ul>
    
    
    
    <h2>
        <a href="#apidoc.element.sinopia.local_storage.prototype._internal_error" id="apidoc.element.sinopia.local_storage.prototype._internal_error">
        function <span class="apidocSignatureSpan">sinopia.local_storage.prototype.</span>_internal_error
        <span class="apidocSignatureSpan">(err, file, message)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">_internal_error = function (err, file, message) {
  this.logger.error( { err: err, file: file }
                   , message + &#x27; @{file}: @{!err.message}&#x27; )
  return Error[500]()
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  storage.read_json(info_file, function(err, data) {
    // TODO: race condition
    if (err) {
      if (err.code === &#x27;ENOENT&#x27;) {
        // if package doesn&#x27;t exist, we create it here
        data = get_boilerplate(name)
      } else {
        return callback(self.<span class="apidocCodeKeywordSpan">_internal_error</span>(err, info_file, &#x27;error reading&#x27\
;))
      }
    }
    self._normalize_package(data)
    callback(null, data)
  })
}
...</pre></li>
    </ul>
    
    
    
    <h2>
        <a href="#apidoc.element.sinopia.local_storage.prototype._normalize_package" id="apidoc.element.sinopia.local_storage.prototype._normalize_package">
        function <span class="apidocSignatureSpan">sinopia.local_storage.prototype.</span>_normalize_package
        <span class="apidocSignatureSpan">(pkg)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">_normalize_package = function (pkg) {
  ;[&#x27;versions&#x27;, &#x27;dist-tags&#x27;, &#x27;_distfiles&#x27;, &#x27;_attachments&#x27;, &#x27;_uplinks&#x27;].forEach(function(key) {
    if (!Utils.is_object(pkg[key])) pkg[key] = {}
  })
  if (typeof(pkg._rev) !== &#x27;string&#x27;) pkg._rev = &#x27;0-0000000000000000&#x27;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
    if (err) {
if (err.code === &#x27;ENOENT&#x27;) {
  return callback( Error[404](&#x27;no such package available&#x27;) )
} else {
  return callback(err)
}
    }
    self.<span class="apidocCodeKeywordSpan">_normalize_package</span>(data)

    storage.unlink(info_file, function(err) {
if (err) return callback(err)

var files = Object.keys(data._attachments)

function unlinkNext(cb) {
...</pre></li>
    </ul>
    
    
    
    <h2>
        <a href="#apidoc.element.sinopia.local_storage.prototype._read_create_package" id="apidoc.element.sinopia.local_storage.prototype._read_create_package">
        function <span class="apidocSignatureSpan">sinopia.local_storage.prototype.</span>_read_create_package
        <span class="apidocSignatureSpan">(name, callback)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">_read_create_package = function (name, callback) {
  var self = this
  var storage = self.storage(name)
  if (!storage) {
    var data = get_boilerplate(name)
    self._normalize_package(data)
    return callback(null, data)
  }
  storage.read_json(info_file, function(err, data) {
    // TODO: race condition
    if (err) {
      if (err.code === &#x27;ENOENT&#x27;) {
        // if package doesn&#x27;t exist, we create it here
        data = get_boilerplate(name)
      } else {
        return callback(self._internal_error(err, info_file, &#x27;error reading&#x27;))
      }
    }
    self._normalize_package(data)
    callback(null, data)
  })
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  })
}

// synchronize remote package info with the local one
// TODO: readfile called twice
Storage.prototype.update_versions = function(name, newdata, callback) {
  var self = this
  self.<span class="apidocCodeKeywordSpan">_read_create_package</span>(name, function(err, data) {
if (err) return callback(err)

var change = false
for (var ver in newdata.versions) {
  if (data.versions[ver] == null) {
    var verdata = newdata.versions[ver]
...</pre></li>
    </ul>
    
    
    
    <h2>
        <a href="#apidoc.element.sinopia.local_storage.prototype._write_package" id="apidoc.element.sinopia.local_storage.prototype._write_package">
        function <span class="apidocSignatureSpan">sinopia.local_storage.prototype.</span>_write_package
        <span class="apidocSignatureSpan">(name, json, callback)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">_write_package = function (name, json, callback) {

  // calculate revision a la couchdb
  if (typeof(json._rev) !== &#x27;string&#x27;) json._rev = &#x27;0-0000000000000000&#x27;
  var rev = json._rev.split(&#x27;-&#x27;)
  json._rev = ((+rev[0] || 0) + 1) + &#x27;-&#x27; + Crypto.pseudoRandomBytes(8).toString(&#x27;hex&#x27;)

  var storage = this.storage(name)
  if (!storage) return callback()
  storage.write_json(info_file, json, callback)
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
    if (newdata.readme !== data.readme) {
      data.readme = newdata.readme
      change = true
    }

    if (change) {
      self.logger.debug(&#x27;updating package info&#x27;)
      self.<span class="apidocCodeKeywordSpan">_write_package</span>(name, data, function(err) {
        callback(err, data)
      })
    } else {
      callback(null, data)
    }
  })
}
...</pre></li>
    </ul>
    
    
    
    <h2>
        <a href="#apidoc.element.sinopia.local_storage.prototype.add_package" id="apidoc.element.sinopia.local_storage.prototype.add_package">
        function <span class="apidocSignatureSpan">sinopia.local_storage.prototype.</span>add_package
        <span class="apidocSignatureSpan">(name, info, callback)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">add_package = function (name, info, callback) {
  var storage = this.storage(name)
  if (!storage) return callback( Error[404](&#x27;this package cannot be added&#x27;) )

  storage.create_json(info_file, get_boilerplate(name), function(err) {
    if (err &#x26;&#x26; err.code === &#x27;EEXISTS&#x27;) {
      return callback( Error[409](&#x27;this package is already present&#x27;) )
    }

    var latest = info[&#x27;dist-tags&#x27;].latest
    if (latest &#x26;&#x26; info.versions[latest]) {
      Search.add(info.versions[latest])
    }
    callback()
  })
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
}

if (req.params._rev) {
  storage.change_package(name, metadata, req.params.revision, function(err) {
    after_change(err, &#x27;package changed&#x27;)
  })
} else {
  storage.<span class="apidocCodeKeywordSpan">add_package</span>(name, metadata, function(err) {
    after_change(err, &#x27;created new package&#x27;)
  })
}

function after_change(err, ok_message) {
  // old npm behaviour
  if (metadata._attachments == null) {
...</pre></li>
    </ul>
    
    
    
    <h2>
        <a href="#apidoc.element.sinopia.local_storage.prototype.add_tarball" id="apidoc.element.sinopia.local_storage.prototype.add_tarball">
        function <span class="apidocSignatureSpan">sinopia.local_storage.prototype.</span>add_tarball
        <span class="apidocSignatureSpan">(name, filename)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">add_tarball = function (name, filename) {
  assert(Utils.validate_name(filename))

  var stream = MyStreams.UploadTarballStream()
  var _transform = stream._transform
  var length = 0
  var shasum = Crypto.createHash(&#x27;sha1&#x27;)

  stream.abort = stream.done = function(){}

  stream._transform = function(data) {
    shasum.update(data)
    length += data.length
    _transform.apply(stream, arguments)
  }

  var self = this
  if (name === info_file || name === &#x27;__proto__&#x27;) {
    process.nextTick(function() {
      stream.emit(&#x27;error&#x27;, Error[403](&#x22;can&#x27;t use this filename&#x22;))
    })
    return stream
  }

  var storage = self.storage(name)
  if (!storage) {
    process.nextTick(function() {
      stream.emit(&#x27;error&#x27;, Error[404](&#x22;can&#x27;t upload this package&#x22;))
    })
    return stream
  }

  var wstream = storage.write_stream(filename)

  wstream.on(&#x27;error&#x27;, function(err) {
    if (err.code === &#x27;EEXISTS&#x27;) {
      stream.emit(&#x27;error&#x27;, Error[409](&#x27;this tarball is already present&#x27;))
    } else if (err.code === &#x27;ENOENT&#x27;) {
      // check if package exists to throw an appropriate message
      self.get_package(name, function(_err, res) {
        if (_err) {
          stream.emit(&#x27;error&#x27;, _err)
        } else {
          stream.emit(&#x27;error&#x27;, err)
        }
      })
    } else {
      stream.emit(&#x27;error&#x27;, err)
    }
  })

  wstream.on(&#x27;open&#x27;, function() {
    // re-emitting open because it&#x27;s handled in storage.js
    stream.emit(&#x27;open&#x27;)
  })
  wstream.on(&#x27;success&#x27;, function() {
    self.update_package(name, function updater(data, cb) {
      data._attachments[filename] = {
        shasum: shasum.digest(&#x27;hex&#x27;),
      }
      cb()
    }, function(err) {
      if (err) {
        stream.emit(&#x27;error&#x27;, err)
      } else {
        stream.emit(&#x27;success&#x27;)
      }
    })
  })
  stream.abort = function() {
    wstream.abort()
  }
  stream.done = function() {
    if (!length) {
      stream.emit(&#x27;error&#x27;, Error[422](&#x27;refusing to accept zero-length file&#x27;))
      wstream.abort()
    } else {
      wstream.done()
    }
  }
  stream.pipe(wstream)

  return stream
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
        return next({ ok: ok_message })
      })
    })
  })
}

function create_tarball(filename, data, cb) {
  var stream = storage.<span class="apidocCodeKeywordSpan">add_tarball</span>(name, filename)
  stream.on(&#x27;error&#x27;, function(err) {
    cb(err)
  })
  stream.on(&#x27;success&#x27;, function() {
    cb()
  })
...</pre></li>
    </ul>
    
    
    
    <h2>
        <a href="#apidoc.element.sinopia.local_storage.prototype.add_version" id="apidoc.element.sinopia.local_storage.prototype.add_version">
        function <span class="apidocSignatureSpan">sinopia.local_storage.prototype.</span>add_version
        <span class="apidocSignatureSpan">(name, version, metadata, tag, callback)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">add_version = function (name, version, metadata, tag, callback) {
  var self = this
  self.update_package(name, function updater(data, cb) {
    // keep only one readme per package
    data.readme = metadata.readme
    delete metadata.readme

    if (data.versions[version] != null) {
      return cb( Error[409](&#x27;this version already present&#x27;) )
    }

    // if uploaded tarball has a different shasum, it&#x27;s very likely that we have some kind of error
    if (Utils.is_object(metadata.dist) &#x26;&#x26; typeof(metadata.dist.tarball) === &#x27;string&#x27;) {
      var tarball = metadata.dist.tarball.replace(/.*\//, &#x27;&#x27;)
      if (Utils.is_object(data._attachments[tarball])) {
        if (data._attachments[tarball].shasum != null &#x26;&#x26; metadata.dist.shasum != null) {
          if (data._attachments[tarball].shasum != metadata.dist.shasum) {
            return cb( Error[400](&#x27;shasum error, &#x27;
                                + data._attachments[tarball].shasum
                                + &#x27; != &#x27; + metadata.dist.shasum) )
          }
        }

        data._attachments[tarball].version = version
      }
    }

    data.versions[version] = metadata
    Utils.tag_version(data, version, tag, self.config)
    self.config.localList.add(name)
    cb()
  }, callback)
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...

    // this is dumb and memory-consuming, but what choices do we have?
    stream.end(Buffer(data.data, &#x27;base64&#x27;))
    stream.done()
  }

  function create_version(version, data, cb) {
    storage.<span class="apidocCodeKeywordSpan">add_version</span>(name, version, data, null, cb)
  }

  function add_tags(tags, cb) {
    storage.merge_tags(name, tags, cb)
  }
})
...</pre></li>
    </ul>
    
    
    
    <h2>
        <a href="#apidoc.element.sinopia.local_storage.prototype.change_package" id="apidoc.element.sinopia.local_storage.prototype.change_package">
        function <span class="apidocSignatureSpan">sinopia.local_storage.prototype.</span>change_package
        <span class="apidocSignatureSpan">(name, metadata, revision, callback)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">change_package = function (name, metadata, revision, callback) {
  var self = this

  if (!Utils.is_object(metadata.versions) || !Utils.is_object(metadata[&#x27;dist-tags&#x27;])) {
    return callback( Error[422](&#x27;bad data&#x27;) )
  }

  self.update_package(name, function updater(data, cb) {
    for (var ver in data.versions) {
      if (metadata.versions[ver] == null) {
        self.logger.info( { name: name, version: ver }
                        , &#x27;unpublishing @{name}@@{version}&#x27;)
        delete data.versions[ver]

        for (var file in data._attachments) {
          if (data._attachments[file].version === ver) {
            delete data._attachments[file].version
          }
        }
      }
    }
    data[&#x27;dist-tags&#x27;] = metadata[&#x27;dist-tags&#x27;]
    cb()
  }, function(err) {
    if (err) return callback(err)
    callback()
  })
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
try {
  var metadata = Utils.validate_metadata(req.body, name)
} catch(err) {
  return next( Error[422](&#x27;bad incoming package data&#x27;) )
}

if (req.params._rev) {
  storage.<span class="apidocCodeKeywordSpan">change_package</span>(name, metadata, req.params.revision, function(err) {
    after_change(err, &#x27;package changed&#x27;)
  })
} else {
  storage.add_package(name, metadata, function(err) {
    after_change(err, &#x27;created new package&#x27;)
  })
}
...</pre></li>
    </ul>
    
    
    
    <h2>
        <a href="#apidoc.element.sinopia.local_storage.prototype.get_package" id="apidoc.element.sinopia.local_storage.prototype.get_package">
        function <span class="apidocSignatureSpan">sinopia.local_storage.prototype.</span>get_package
        <span class="apidocSignatureSpan">(name, options, callback)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">get_package = function (name, options, callback) {
  if (typeof(options) === &#x27;function&#x27;) callback = options, options = {}

  var self = this
  var storage = self.storage(name)
  if (!storage) return callback( Error[404](&#x27;no such package available&#x27;) )

  storage.read_json(info_file, function(err, result) {
    if (err) {
      if (err.code === &#x27;ENOENT&#x27;) {
        return callback( Error[404](&#x27;no such package available&#x27;) )
      } else {
        return callback(self._internal_error(err, info_file, &#x27;error reading&#x27;))
      }
    }
    self._normalize_package(result)
    callback(err, result)
  })
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  })
  app.get(&#x27;/-/whoami&#x27;, function(req, res, next) {
    next({ username: req.remote_user.name })
  })

  // TODO: anonymous user?
  app.get(&#x27;/:package/:version?&#x27;, can(&#x27;access&#x27;), function(req, res, next) {
    storage.<span class="apidocCodeKeywordSpan">get_package</span>(req.params.package, { req: req }, function(err, info) {
if (err) return next(err)
info = Utils.filter_tarball_urls(info, req, config)

var version = req.params.version
if (!version) return next(info)

var t = Utils.get_version(info, version)
...</pre></li>
    </ul>
    
    
    
    <h2>
        <a href="#apidoc.element.sinopia.local_storage.prototype.get_tarball" id="apidoc.element.sinopia.local_storage.prototype.get_tarball">
        function <span class="apidocSignatureSpan">sinopia.local_storage.prototype.</span>get_tarball
        <span class="apidocSignatureSpan">(name, filename, callback)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">get_tarball = function (name, filename, callback) {
  assert(Utils.validate_name(filename))
  var self = this

  var stream = MyStreams.ReadTarballStream()
  stream.abort = function() {
    if (rstream) rstream.abort()
  }

  var storage = self.storage(name)
  if (!storage) {
    process.nextTick(function() {
      stream.emit(&#x27;error&#x27;, Error[404](&#x27;no such file available&#x27;))
    })
    return stream
  }

  var rstream = storage.read_stream(filename)
  rstream.on(&#x27;error&#x27;, function(err) {
    if (err &#x26;&#x26; err.code === &#x27;ENOENT&#x27;) {
      stream.emit(&#x27;error&#x27;, Error(404, &#x27;no such file available&#x27;))
    } else {
      stream.emit(&#x27;error&#x27;, err)
    }
  })
  rstream.on(&#x27;content-length&#x27;, function(v) {
    stream.emit(&#x27;content-length&#x27;, v)
  })
  rstream.on(&#x27;open&#x27;, function() {
    // re-emitting open because it&#x27;s handled in storage.js
    stream.emit(&#x27;open&#x27;)
    rstream.pipe(stream)
  })
  return stream
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
    }

    return next( Error[404](&#x27;version not found: &#x27; + req.params.version) )
  })
})

app.get(&#x27;/:package/-/:filename&#x27;, can(&#x27;access&#x27;), function(req, res, next) {
  var stream = storage.<span class="apidocCodeKeywordSpan">get_tarball</span>(req.params.package, req.params.filename)
  stream.on(&#x27;content-length&#x27;, function(v) {
    res.header(&#x27;Content-Length&#x27;, v)
  })
  stream.on(&#x27;error&#x27;, function(err) {
    return res.report_error(err)
  })
  res.header(&#x27;Content-Type&#x27;, &#x27;application/octet-stream&#x27;)
...</pre></li>
    </ul>
    
    
    
    <h2>
        <a href="#apidoc.element.sinopia.local_storage.prototype.merge_tags" id="apidoc.element.sinopia.local_storage.prototype.merge_tags">
        function <span class="apidocSignatureSpan">sinopia.local_storage.prototype.</span>merge_tags
        <span class="apidocSignatureSpan">(name, tags, callback)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">merge_tags = function (name, tags, callback) {
  var self = this

  self.update_package(name, function updater(data, cb) {
    for (var t in tags) {
      if (tags[t] === null) {
        delete data[&#x27;dist-tags&#x27;][t]
        continue
      }

      if (data.versions[tags[t]] == null) {
        return cb( Error[404](&#x22;this version doesn&#x27;t exist&#x22;) )
      }

      Utils.tag_version(data, tags[t], t, self.config)
    }
    cb()
  }, callback)
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
})

function tag_package_version(req, res, next) {
  if (typeof(req.body) !== &#x27;string&#x27;) return next(&#x27;route&#x27;)

  var tags = {}
  tags[req.params.tag] = req.body
  storage.<span class="apidocCodeKeywordSpan">merge_tags</span>(req.params.package, tags, function(err) {
    if (err) return next(err)
    res.status(201)
    return next({ ok: &#x27;package tagged&#x27; })
  })
}

// tagging a package
...</pre></li>
    </ul>
    
    
    
    <h2>
        <a href="#apidoc.element.sinopia.local_storage.prototype.remove_package" id="apidoc.element.sinopia.local_storage.prototype.remove_package">
        function <span class="apidocSignatureSpan">sinopia.local_storage.prototype.</span>remove_package
        <span class="apidocSignatureSpan">(name, callback)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">remove_package = function (name, callback) {
  var self = this
  self.logger.info( { name: name }
                  , &#x27;unpublishing @{name} (all)&#x27;)

  var storage = self.storage(name)
  if (!storage) return callback( Error[404](&#x27;no such package available&#x27;) )

  storage.read_json(info_file, function(err, data) {
    if (err) {
      if (err.code === &#x27;ENOENT&#x27;) {
        return callback( Error[404](&#x27;no such package available&#x27;) )
      } else {
        return callback(err)
      }
    }
    self._normalize_package(data)

    storage.unlink(info_file, function(err) {
      if (err) return callback(err)

      var files = Object.keys(data._attachments)

      function unlinkNext(cb) {
        if (files.length === 0) return cb()

        var file = files.shift()
        storage.unlink(file, function() {
          unlinkNext(cb)
        })
      }

      unlinkNext(function() {
        // try to unlink the directory, but ignore errors because it can fail
        storage.rmdir(&#x27;.&#x27;, function(err) {
          callback(err)
        })
      })
    })
  })

  Search.remove(name)
  this.config.localList.remove(name)
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  function add_tags(tags, cb) {
    storage.merge_tags(name, tags, cb)
  }
})

// unpublishing an entire package
app.delete(&#x27;/:package/-rev/*&#x27;, can(&#x27;publish&#x27;), function(req, res, next) {
  storage.<span class="apidocCodeKeywordSpan">remove_package</span>(req.params.package, function(err) {
    if (err) return next(err)
    res.status(201)
    return next({ ok: &#x27;package removed&#x27; })
  })
})

// removing a tarball
...</pre></li>
    </ul>
    
    
    
    <h2>
        <a href="#apidoc.element.sinopia.local_storage.prototype.remove_tarball" id="apidoc.element.sinopia.local_storage.prototype.remove_tarball">
        function <span class="apidocSignatureSpan">sinopia.local_storage.prototype.</span>remove_tarball
        <span class="apidocSignatureSpan">(name, filename, revision, callback)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">remove_tarball = function (name, filename, revision, callback) {
  assert(Utils.validate_name(filename))
  var self = this

  self.update_package(name, function updater(data, cb) {
    if (data._attachments[filename]) {
      delete data._attachments[filename]
      cb()
    } else {
      cb(Error[404](&#x27;no such file available&#x27;))
    }
  }, function(err) {
    if (err) return callback(err)
    var storage = self.storage(name)
    if (storage) storage.unlink(filename, callback)
  })
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
    res.status(201)
    return next({ ok: &#x27;package removed&#x27; })
  })
})

// removing a tarball
app.delete(&#x27;/:package/-/:filename/-rev/:revision&#x27;, can(&#x27;publish&#x27;), function(req, res, next) {
  storage.<span class="apidocCodeKeywordSpan">remove_tarball</span>(req.params.package, req.params.filename, req.params.revision\
, function(err) {
    if (err) return next(err)
    res.status(201)
    return next({ ok: &#x27;tarball removed&#x27; })
  })
})

// uploading package tarball
...</pre></li>
    </ul>
    
    
    
    <h2>
        <a href="#apidoc.element.sinopia.local_storage.prototype.replace_tags" id="apidoc.element.sinopia.local_storage.prototype.replace_tags">
        function <span class="apidocSignatureSpan">sinopia.local_storage.prototype.</span>replace_tags
        <span class="apidocSignatureSpan">(name, tags, callback)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">replace_tags = function (name, tags, callback) {
  var self = this

  self.update_package(name, function updater(data, cb) {
    data[&#x27;dist-tags&#x27;] = {}

    for (var t in tags) {
      if (tags[t] === null) {
        delete data[&#x27;dist-tags&#x27;][t]
        continue
      }

      if (data.versions[tags[t]] == null) {
        return cb( Error[404](&#x22;this version doesn&#x27;t exist&#x22;) )
      }

      Utils.tag_version(data, tags[t], t, self.config)
    }
    cb()
  }, callback)
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  })
})

app.put(&#x27;/-/package/:package/dist-tags&#x27;,
    can(&#x27;publish&#x27;), media(&#x27;application/json&#x27;), expect_json,
    function(req, res, next) {

  storage.<span class="apidocCodeKeywordSpan">replace_tags</span>(req.params.package, req.body, function(err) {
    if (err) return next(err)
    res.status(201)
    return next({ ok: &#x27;tags updated&#x27; })
  })
})

app.delete(&#x27;/-/package/:package/dist-tags&#x27;,
...</pre></li>
    </ul>
    
    
    
    <h2>
        <a href="#apidoc.element.sinopia.local_storage.prototype.search" id="apidoc.element.sinopia.local_storage.prototype.search">
        function <span class="apidocSignatureSpan">sinopia.local_storage.prototype.</span>search
        <span class="apidocSignatureSpan">(startkey, options)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">search = function (startkey, options) {
  var self = this

  var stream = new Stream.PassThrough({ objectMode: true })

  self._each_package(function on_package(item, cb) {
    fs.stat(item.path, function(err, stats) {
      if (err) return cb(err)

      if (stats.mtime &#x3e; startkey) {
        self.get_package(item.name, options, function(err, data) {
          if (err) return cb(err)

          var versions = Utils.semver_sort(Object.keys(data.versions))
          var latest = versions[versions.length - 1]

          if (data.versions[latest]) {
            stream.push({
              name           : data.versions[latest].name,
              description    : data.versions[latest].description,
              &#x27;dist-tags&#x27;    : { latest: latest },
              maintainers    : data.versions[latest].maintainers ||
                                 [ data.versions[latest]._npmUser ].filter(Boolean),
              author         : data.versions[latest].author,
              repository     : data.versions[latest].repository,
              readmeFilename : data.versions[latest].readmeFilename || &#x27;&#x27;,
              homepage       : data.versions[latest].homepage,
              keywords       : data.versions[latest].keywords,
              bugs           : data.versions[latest].bugs,
              license        : data.versions[latest].license,
              time           : { modified: item.time ? new Date(item.time).toISOString() : undefined },
              versions       : {},
            })
          }

          cb()
        })
      } else {
        cb()
      }
    })
  }, function on_end(err) {
    if (err) return stream.emit(&#x27;error&#x27;, err)
    stream.end()
  })

  return stream
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
    var received_end      = false
    var response_finished = false
    var processing_pkgs   = 0

    res.status(200)
    res.write(&#x27;{&#x22;_updated&#x22;:&#x27; + Date.now());

    var stream = storage.<span class="apidocCodeKeywordSpan">search</span>(req.param.startkey || 0, { req: req })

    stream.on(&#x27;data&#x27;, function each(pkg) {
processing_pkgs++

auth.allow_access(pkg.name, req.remote_user, function(err, allowed) {
  processing_pkgs--
...</pre></li>
    </ul>
    
    
    
    <h2>
        <a href="#apidoc.element.sinopia.local_storage.prototype.storage" id="apidoc.element.sinopia.local_storage.prototype.storage">
        function <span class="apidocSignatureSpan">sinopia.local_storage.prototype.</span>storage
        <span class="apidocSignatureSpan">(package)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">storage = function (package) {
  var path = this.config.get_package_spec(package).storage
  if (path == null) path = this.config.storage
  if (path == null || path === false) {
    this.logger.debug( { name: package }
                     , &#x27;this package has no storage defined: @{name}&#x27; )
    return null
  }
  return Path_Wrapper(
    Path.join(
      Path.resolve(Path.dirname(this.config.self_path), path),
      package
    )
  )
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
Storage.prototype._internal_error = function(err, file, message) {
this.logger.error( { err: err, file: file }
                 , message + &#x27; @{file}: @{!err.message}&#x27; )
return Error[500]()
}

Storage.prototype.add_package = function(name, info, callback) {
var storage = this.<span class="apidocCodeKeywordSpan">storage</span>(name)
if (!storage) return callback( Error[404](&#x27;this package cannot be added&#x27;) )

storage.create_json(info_file, get_boilerplate(name), function(err) {
  if (err &#x26;&#x26; err.code === &#x27;EEXISTS&#x27;) {
    return callback( Error[409](&#x27;this package is already present&#x27;) )
  }
...</pre></li>
    </ul>
    
    
    
    <h2>
        <a href="#apidoc.element.sinopia.local_storage.prototype.update_package" id="apidoc.element.sinopia.local_storage.prototype.update_package">
        function <span class="apidocSignatureSpan">sinopia.local_storage.prototype.</span>update_package
        <span class="apidocSignatureSpan">(name, updateFn, _callback)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">update_package = function (name, updateFn, _callback) {
  var self = this
  var storage = self.storage(name)
  if (!storage) return _callback( Error[404](&#x27;no such package available&#x27;) )
  storage.lock_and_read_json(info_file, function(err, fd, json) {
    function callback() {
      var _args = arguments
      if (fd) {
        fs.close(fd, function(err) {
          if (err) return _callback(err)
          _callback.apply(null, _args)
        })
      } else {
        _callback.apply(null, _args)
      }
    }

    if (err) {
      if (err.code === &#x27;EAGAIN&#x27;) {
        return callback( Error[503](&#x27;resource temporarily unavailable&#x27;) )
      } else if (err.code === &#x27;ENOENT&#x27;) {
        return callback( Error[404](&#x27;no such package available&#x27;) )
      } else {
        return callback(err)
      }
    }

    self._normalize_package(json)
    updateFn(json, function(err) {
      if (err) return callback(err)

      self._write_package(name, json, callback)
    })
  })
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  callback(null, data)
}
  })
}

Storage.prototype.add_version = function(name, version, metadata, tag, callback) {
  var self = this
  self.<span class="apidocCodeKeywordSpan">update_package</span>(name, function updater(data, cb) {
// keep only one readme per package
data.readme = metadata.readme
delete metadata.readme

if (data.versions[version] != null) {
  return cb( Error[409](&#x27;this version already present&#x27;) )
}
...</pre></li>
    </ul>
    
    
    
    <h2>
        <a href="#apidoc.element.sinopia.local_storage.prototype.update_versions" id="apidoc.element.sinopia.local_storage.prototype.update_versions">
        function <span class="apidocSignatureSpan">sinopia.local_storage.prototype.</span>update_versions
        <span class="apidocSignatureSpan">(name, newdata, callback)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">update_versions = function (name, newdata, callback) {
  var self = this
  self._read_create_package(name, function(err, data) {
    if (err) return callback(err)

    var change = false
    for (var ver in newdata.versions) {
      if (data.versions[ver] == null) {
        var verdata = newdata.versions[ver]

        // we don&#x27;t keep readmes for package versions,
        // only one readme per package
        delete verdata.readme

        change = true
        data.versions[ver] = verdata

        if (verdata.dist &#x26;&#x26; verdata.dist.tarball) {
          var filename = URL.parse(verdata.dist.tarball).pathname.replace(/^.*\//, &#x27;&#x27;)
          // we do NOT overwrite any existing records
          if (data._distfiles[filename] == null) {
            var hash = data._distfiles[filename] = {
              url: verdata.dist.tarball,
              sha: verdata.dist.shasum,
            }

            if (verdata._sinopia_uplink) {
              // if we got this information from a known registry,
              // use the same protocol for the tarball
              //
              // see https://github.com/rlidwka/sinopia/issues/166
              var tarball_url = URL.parse(hash.url)
              var uplink_url  = URL.parse(self.config.uplinks[verdata._sinopia_uplink].url)
              if (uplink_url.host === tarball_url.host) {
                tarball_url.protocol = uplink_url.protocol
                hash.registry = verdata._sinopia_uplink
                hash.url = URL.format(tarball_url)
              }
            }
          }
        }
      }
    }
    for (var tag in newdata[&#x27;dist-tags&#x27;]) {
      if (!Array.isArray(data[&#x27;dist-tags&#x27;][tag]) || data[&#x27;dist-tags&#x27;][tag].length != newdata[&#x27;dist-tags&#x27;][tag].length) {
        // backward compat
        var need_change = true
      } else {
        for (var i=0; i&#x3c;data[&#x27;dist-tags&#x27;][tag].length; i++) {
          if (data[&#x27;dist-tags&#x27;][tag][i] != newdata[&#x27;dist-tags&#x27;][tag][i]) {
            var need_change = true
            break
          }
        }
      }

      if (need_change) {
        change = true
        data[&#x27;dist-tags&#x27;][tag] = newdata[&#x27;dist-tags&#x27;][tag]
      }
    }
    for (var up in newdata._uplinks) {
      var need_change = !Utils.is_object(data._uplinks[up])
                     || newdata._uplinks[up].etag !== data._uplinks[up].etag
                     || newdata._uplinks[up].fetched !== data._uplinks[up].fetched

      if (need_change) {
        change = true
        data._uplinks[up] = newdata._uplinks[up]
      }
    }
    if (newdata.readme !== data.readme) {
      data.readme = newdata.readme
      change = true
    }

    if (change) {
      self.logger.debug(&#x27;updating package info&#x27;)
      self._write_package(name, data, function(err) {
        callback(err, data)
      })
    } else {
      callback(null, data)
    }
  })
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...

    if (!exists) {
      return callback( Error[404](&#x27;no such package available&#x27;)
                     , null
                     , uplink_errors )
    }

    self.local.<span class="apidocCodeKeywordSpan">update_versions</span>(name, pkginfo, function(err, pkginfo) {
      if (err) return callback(err)
      return callback(null, pkginfo, uplink_errors)
    })
  })
}

// function gets a local info and an info from uplinks and tries to merge it
...</pre></li>
    </ul>
    
    
</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.sinopia.logger" id="apidoc.module.sinopia.logger">module sinopia.logger</a></h1>
    
    
    <h2>
        <a href="#apidoc.element.sinopia.logger.setup" id="apidoc.element.sinopia.logger.setup">
        function <span class="apidocSignatureSpan">sinopia.logger.</span>setup
        <span class="apidocSignatureSpan">(logs)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">setup = function (logs) {
  var streams = []
  if (logs == null) logs = [{ type: &#x27;stdout&#x27;, format: &#x27;pretty&#x27;, level: &#x27;http&#x27; }]

  logs.forEach(function(target) {
    var stream = new Stream()
    stream.writable = true

    if (target.type === &#x27;stdout&#x27; || target.type === &#x27;stderr&#x27;) {
      // destination stream
      var dest = target.type === &#x27;stdout&#x27; ? process.stdout : process.stderr

      if (target.format === &#x27;pretty&#x27;) {
        // making fake stream for prettypritting
        stream.write = function(obj) {
          dest.write(print(obj.level, obj.msg, obj, dest.isTTY) + &#x27;\n&#x27;)
        }
      } else {
        stream.write = function(obj) {
          dest.write(JSON.stringify(obj, Logger.safeCycles()) + &#x27;\n&#x27;)
        }
      }
    } else if (target.type === &#x27;file&#x27;) {
      var dest = require(&#x27;fs&#x27;).createWriteStream(target.path, {flags: &#x27;a&#x27;, encoding: &#x27;utf8&#x27;})
      dest.on(&#x27;error&#x27;, function (err) {
        Logger.emit(&#x27;error&#x27;, err)
      })
      stream.write = function(obj) {
        if (target.format === &#x27;pretty&#x27;) {
          dest.write(print(obj.level, obj.msg, obj, false) + &#x27;\n&#x27;)
        } else {
          dest.write(JSON.stringify(obj, Logger.safeCycles()) + &#x27;\n&#x27;)
        }
      }
    } else {
      throw Error(&#x27;wrong target type for a log&#x27;)
    }

    if (target.level === &#x27;http&#x27;) target.level = 35
    streams.push({
      type: &#x27;raw&#x27;,
      level: target.level || 35,
      stream: stream,
    })
  })

  var logger = new Logger({
    name: &#x27;sinopia&#x27;,
    streams: streams,
    serializers: {
      err: Logger.stdSerializers.err,
      req: Logger.stdSerializers.req,
      res: Logger.stdSerializers.res,
    },
  })

  module.exports.logger = logger
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
try {
  // for debugging memory leaks
  // totally optional
  require(&#x27;heapdump&#x27;)
} catch(err) {}

var logger = require(&#x27;./logger&#x27;)
logger.<span class="apidocCodeKeywordSpan">setup</span>() // default setup

var commander = require(&#x27;commander&#x27;)
var constants = require(&#x27;constants&#x27;)
var fs        = require(&#x27;fs&#x27;)
var http      = require(&#x27;http&#x27;)
var https     = require(&#x27;https&#x27;)
var YAML      = require(&#x27;js-yaml&#x27;)
...</pre></li>
    </ul>
    
    
    
    
</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.sinopia.middleware" id="apidoc.module.sinopia.middleware">module sinopia.middleware</a></h1>
    
    
    <h2>
        <a href="#apidoc.element.sinopia.middleware.allow" id="apidoc.element.sinopia.middleware.allow">
        function <span class="apidocSignatureSpan">sinopia.middleware.</span>allow
        <span class="apidocSignatureSpan">(auth)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">allow = function (auth) {
  return function(action) {
    return function(req, res, next) {
      req.pause();
      auth[&#x27;allow_&#x27;+action](req.params.package, req.remote_user, function(error, is_allowed) {
        req.resume();
        if (error) {
          next(error)
        } else if (is_allowed) {
          next()
        } else {
          // last plugin (that&#x27;s our built-in one) returns either
          // cb(err) or cb(null, true), so this should never happen
          throw Error(&#x27;bug in the auth plugin system&#x27;)
        }
      })
    }
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
var match         = Middleware.match
var media         = Middleware.media
var validate_name = Middleware.validate_name
var validate_pkg  = Middleware.validate_package

module.exports = function(config, auth, storage) {
var app = express.Router()
var can = Middleware.<span class="apidocCodeKeywordSpan">allow</span>(auth)

// validate all of these params as a package name
// this might be too harsh, so ask if it causes trouble
app.param(&#x27;package&#x27;,  validate_pkg)
app.param(&#x27;filename&#x27;, validate_name)
app.param(&#x27;tag&#x27;,      validate_name)
app.param(&#x27;version&#x27;,  validate_name)
...</pre></li>
    </ul>
    
    
    
    <h2>
        <a href="#apidoc.element.sinopia.middleware.anti_loop" id="apidoc.element.sinopia.middleware.anti_loop">
        function <span class="apidocSignatureSpan">sinopia.middleware.</span>anti_loop
        <span class="apidocSignatureSpan">(config)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">anti_loop = function (config) {
  return function(req, res, next) {
    if (req.headers.via != null) {
      var arr = req.headers.via.split(&#x27;,&#x27;)

      for (var i=0; i&#x3c;arr.length; i++) {
        var m = arr[i].match(/\s*(\S+)\s+(\S+)/)
        if (m &#x26;&#x26; m[2] === config.server_id) {
          return next( Error[508](&#x27;loop detected&#x27;) )
        }
      }
    }
    next()
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
app.param(&#x27;_rev&#x27;,             match(/^-rev$/))
app.param(&#x27;org_couchdb_user&#x27;, match(/^org\.couchdb\.user:/))
app.param(&#x27;anything&#x27;,         match(/.*/))

app.use(auth.basic_middleware())
//app.use(auth.bearer_middleware())
app.use(expressJson5({ strict: false, limit: config.max_body_size || &#x27;10mb&#x27; }))
app.use(Middleware.<span class="apidocCodeKeywordSpan">anti_loop</span>(config))

// for &#x22;npm whoami&#x22;
app.get(&#x27;/whoami&#x27;, function(req, res, next) {
  if (req.headers.referer === &#x27;whoami&#x27;) {
    next({ username: req.remote_user.name })
  } else {
    next(&#x27;route&#x27;)
...</pre></li>
    </ul>
    
    
    
    <h2>
        <a href="#apidoc.element.sinopia.middleware.expect_json" id="apidoc.element.sinopia.middleware.expect_json">
        function <span class="apidocSignatureSpan">sinopia.middleware.</span>expect_json
        <span class="apidocSignatureSpan">(req, res, next)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function expect_json(req, res, next) {
  if (!utils.is_object(req.body)) {
    return next( Error[400](&#x22;can&#x27;t parse incoming json&#x22;) )
  }
  next()
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>
    
    
    
    <h2>
        <a href="#apidoc.element.sinopia.middleware.final" id="apidoc.element.sinopia.middleware.final">
        function <span class="apidocSignatureSpan">sinopia.middleware.</span>final
        <span class="apidocSignatureSpan">(body, req, res, next)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">final = function (body, req, res, next) {
  if (res.statusCode === 401 &#x26;&#x26; !res.getHeader(&#x27;WWW-Authenticate&#x27;)) {
    // they say it&#x27;s required for 401, so...
    res.header(&#x27;WWW-Authenticate&#x27;, &#x27;Basic, Bearer&#x27;)
  }

  try {
    if (typeof(body) === &#x27;string&#x27; || typeof(body) === &#x27;object&#x27;) {
      if (!res.getHeader(&#x27;Content-type&#x27;)) {
        res.header(&#x27;Content-type&#x27;, &#x27;application/json&#x27;)
      }

      if (typeof(body) === &#x27;object&#x27; &#x26;&#x26; body != null) {
        if (typeof(body.error) === &#x27;string&#x27;) {
          res._sinopia_error = body.error
        }
        body = JSON.stringify(body, undefined, &#x27;  &#x27;) + &#x27;\n&#x27;
      }

      // don&#x27;t send etags with errors
      if (!res.statusCode || (res.statusCode &#x3e;= 200 &#x26;&#x26; res.statusCode &#x3c; 300)) {
        res.header(&#x27;ETag&#x27;, &#x27;&#x22;&#x27; + md5sum(body) + &#x27;&#x22;&#x27;)
      }
    } else {
      // send(null), send(204), etc.
    }
  } catch(err) {
    // if sinopia sends headers first, and then calls res.send()
    // as an error handler, we can&#x27;t report error properly,
    // and should just close socket
    if (err.message.match(/set headers after they are sent/)) {
      if (res.socket != null) res.socket.destroy()
      return
    } else {
      throw err
    }
  }

  res.send(body)
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...

return data
}

Auth.prototype.aes_encrypt = function(buf) {
var c = Crypto.createCipher(&#x27;aes192&#x27;, this.secret)
var b1 = c.update(buf)
var b2 = c.<span class="apidocCodeKeywordSpan">final</span>()
return Buffer.concat([ b1, b2 ])
}

Auth.prototype.aes_decrypt = function(buf) {
try {
  var c = Crypto.createDecipher(&#x27;aes192&#x27;, this.secret)
  var b1 = c.update(buf)
...</pre></li>
    </ul>
    
    
    
    <h2>
        <a href="#apidoc.element.sinopia.middleware.log" id="apidoc.element.sinopia.middleware.log">
        function <span class="apidocSignatureSpan">sinopia.middleware.</span>log
        <span class="apidocSignatureSpan">(req, res, next)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">log = function (req, res, next) {
  // logger
  req.log = Logger.logger.child({ sub: &#x27;in&#x27; })

  var _auth = req.headers.authorization
  if (_auth != null) req.headers.authorization = &#x27;&#x3c;Classified&#x3e;&#x27;
  var _cookie = req.headers.cookie
  if (_cookie != null) req.headers.cookie = &#x27;&#x3c;Classified&#x3e;&#x27;

  req.url = req.originalUrl
  req.log.info( { req: req, ip: req.ip }
              , &#x27;@{ip} requested \&#x27;@{req.method} @{req.url}\&#x27;&#x27; )
  req.originalUrl = req.url

  if (_auth != null) req.headers.authorization = _auth
  if (_cookie != null) req.headers.cookie = _cookie

  var bytesin = 0
  req.on(&#x27;data&#x27;, function(chunk) {
    bytesin += chunk.length
  })

  var bytesout = 0
  var _write = res.write
  res.write = function(buf) {
    bytesout += buf.length
    _write.apply(res, arguments)
  }

  function log() {
    var message = &#x22;@{status}, user: @{user}, req: &#x27;@{request.method} @{request.url}&#x27;&#x22;
    if (res._sinopia_error) {
      message += &#x27;, error: @{!error}&#x27;
    } else {
      message += &#x27;, bytes: @{bytes.in}/@{bytes.out}&#x27;
    }

    req.url = req.originalUrl
    req.log.warn({
      request : { method: req.method, url: req.url },
      level   : 35, // http
      user    : req.remote_user &#x26;&#x26; req.remote_user.name,
      status  : res.statusCode,
      error   : res._sinopia_error,
      bytes   : {
        in  : bytesin,
        out : bytesout,
      }
    }, message)
    req.originalUrl = req.url
  }

  req.on(&#x27;close&#x27;, function() {
    log(true)
  })

  var _end = res.end
  res.end = function(buf) {
    if (buf) bytesout += buf.length
    _end.apply(res, arguments)
    log()
  }
  next()
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>
    
    
    
    <h2>
        <a href="#apidoc.element.sinopia.middleware.match" id="apidoc.element.sinopia.middleware.match">
        function <span class="apidocSignatureSpan">sinopia.middleware.</span>match
        <span class="apidocSignatureSpan">(regexp)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function match(regexp) {
  return function(req, res, next, value, name) {
    if (regexp.exec(value)) {
      next()
    } else {
      next(&#x27;route&#x27;)
    }
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  }
}

var users = {all:true, anonymous:true, &#x27;undefined&#x27;:true, owner:true, none:true}

var check_user_or_uplink = function(arg) {
  assert(arg !== &#x27;all&#x27; &#x26;&#x26; arg !== &#x27;owner&#x27; &#x26;&#x26; arg !== &#x27;anonymous&#x27; &#x26;&#x26; \
arg !== &#x27;undefined&#x27; &#x26;&#x26; arg !== &#x27;none&#x27;, &#x27;CONFIG: reserved user/uplink name: &#x27; + arg)
  assert(!arg.<span class="apidocCodeKeywordSpan">match</span>(/\s/), &#x27;CONFIG: invalid user name: &#x27; + arg)
  assert(users[arg] == null, &#x27;CONFIG: duplicate user/uplink name: &#x27; + arg)
  users[arg] = true
}

;[ &#x27;users&#x27;, &#x27;uplinks&#x27;, &#x27;packages&#x27; ].forEach(function(x) {
  if (self[x] == null) self[x] = {}
  assert(Utils.is_object(self[x]), &#x27;CONFIG: bad &#x22;&#x27;+x+&#x27;&#x22; value (object expected)&#x27;)
...</pre></li>
    </ul>
    
    
    
    <h2>
        <a href="#apidoc.element.sinopia.middleware.media" id="apidoc.element.sinopia.middleware.media">
        function <span class="apidocSignatureSpan">sinopia.middleware.</span>media
        <span class="apidocSignatureSpan">(expect)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function media(expect) {
  return function(req, res, next) {
    if (req.headers[&#x27;content-type&#x27;] !== expect) {
      next( Error[415](&#x27;wrong content-type, expect: &#x27; + expect
                     + &#x27;, got: &#x27;+req.headers[&#x27;content-type&#x27;]) )
    } else {
      next()
    }
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>
    
    
    
    <h2>
        <a href="#apidoc.element.sinopia.middleware.validate_name" id="apidoc.element.sinopia.middleware.validate_name">
        function <span class="apidocSignatureSpan">sinopia.middleware.</span>validate_name
        <span class="apidocSignatureSpan">(req, res, next, value, name)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function validate_name(req, res, next, value, name) {
  if (value.charAt(0) === &#x27;-&#x27;) {
    // special case in couchdb usually
    next(&#x27;route&#x27;)
  } else if (utils.validate_name(value)) {
    next()
  } else {
    next( Error[403](&#x27;invalid &#x27; + name) )
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
}, function(err) {
  if (err) return callback(err)
  callback()
})
}

Storage.prototype.remove_tarball = function(name, filename, revision, callback) {
assert(Utils.<span class="apidocCodeKeywordSpan">validate_name</span>(filename))
var self = this

self.update_package(name, function updater(data, cb) {
  if (data._attachments[filename]) {
    delete data._attachments[filename]
    cb()
  } else {
...</pre></li>
    </ul>
    
    
    
    <h2>
        <a href="#apidoc.element.sinopia.middleware.validate_package" id="apidoc.element.sinopia.middleware.validate_package">
        function <span class="apidocSignatureSpan">sinopia.middleware.</span>validate_package
        <span class="apidocSignatureSpan">(req, res, next, value, name)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function validate_package(req, res, next, value, name) {
  if (value.charAt(0) === &#x27;-&#x27;) {
    // special case in couchdb usually
    next(&#x27;route&#x27;)
  } else if (utils.validate_package(value)) {
    next()
  } else {
    next( Error[403](&#x27;invalid &#x27; + name) )
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  }
}

module.exports.validate_package = function validate_package(req, res, next, value, name) {
  if (value.charAt(0) === &#x27;-&#x27;) {
    // special case in couchdb usually
    next(&#x27;route&#x27;)
  } else if (utils.<span class="apidocCodeKeywordSpan">validate_package</span>(value)) {
    next()
  } else {
    next( Error[403](&#x27;invalid &#x27; + name) )
  }
}

module.exports.media = function media(expect) {
...</pre></li>
    </ul>
    
    
</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.sinopia.plugin_loader" id="apidoc.module.sinopia.plugin_loader">module sinopia.plugin_loader</a></h1>
    
    
    <h2>
        <a href="#apidoc.element.sinopia.plugin_loader.load_plugins" id="apidoc.element.sinopia.plugin_loader.load_plugins">
        function <span class="apidocSignatureSpan">sinopia.plugin_loader.</span>load_plugins
        <span class="apidocSignatureSpan">(config, plugin_configs, params, sanity_check)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function load_plugins(config, plugin_configs, params, sanity_check) {
  var plugins = Object.keys(plugin_configs || {}).map(function(p) {
    var plugin

    // npm package
    if (plugin == null &#x26;&#x26; p.match(/^[^\.\/]/)) {
      plugin = try_load(&#x27;sinopia-&#x27; + p)
    }

    if (plugin == null) {
      plugin = try_load(p)
    }

    // relative to config path
    if (plugin == null &#x26;&#x26; p.match(/^\.\.?($|\/)/)) {
      plugin = try_load(Path.resolve(Path.dirname(config.self_path), p))
    }

    if (plugin == null) {
      throw Error(&#x27;&#x22;&#x27; + p + &#x27;&#x22; plugin not found\n&#x27;
        + &#x27;try &#x22;npm install sinopia-&#x27; + p + &#x27;&#x22;&#x27;)
    }

    if (typeof(plugin) !== &#x27;function&#x27;)
      throw Error(&#x27;&#x22;&#x27; + p + &#x27;&#x22; doesn\&#x27;t look like a valid plugin&#x27;)

    plugin = plugin(plugin_configs[p], params)

    if (plugin == null || !sanity_check(plugin))
      throw Error(&#x27;&#x22;&#x27; + p + &#x27;&#x22; doesn\&#x27;t look like a valid plugin&#x27;)

    return plugin
  })

  return plugins
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>
    
    
</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.sinopia.status_cats" id="apidoc.module.sinopia.status_cats">module sinopia.status_cats</a></h1>
    
    
    <h2>
        <a href="#apidoc.element.sinopia.status_cats.get_image" id="apidoc.element.sinopia.status_cats.get_image">
        function <span class="apidocSignatureSpan">sinopia.status_cats.</span>get_image
        <span class="apidocSignatureSpan">(status)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">get_image = function (status) {
  if (status in images) {
    return &#x27;http://flic.kr/p/&#x27; + images[status]
    //return &#x27;https://secure.flickr.com/photos/girliemac/&#x27;+images[status]+&#x27;/in/set-72157628409467125/lightbox/&#x27;
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  }
}

module.exports.middleware = function(req, res, next) {
  var _writeHead = res.writeHead
  res.writeHead = function(status) {
    if (status in images) {
      res.setHeader(&#x27;X-Status-Cat&#x27;, module.exports.<span class="apidocCodeKeywordSpan">get_image</span>(status))
    }
    _writeHead.apply(res, arguments)
  }

  next()
}
...</pre></li>
    </ul>
    
    
    
    <h2>
        <a href="#apidoc.element.sinopia.status_cats.middleware" id="apidoc.element.sinopia.status_cats.middleware">
        function <span class="apidocSignatureSpan">sinopia.status_cats.</span>middleware
        <span class="apidocSignatureSpan">(req, res, next)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">middleware = function (req, res, next) {
  var _writeHead = res.writeHead
  res.writeHead = function(status) {
    if (status in images) {
      res.setHeader(&#x27;X-Status-Cat&#x27;, module.exports.get_image(status))
    }
    _writeHead.apply(res, arguments)
  }

  next()
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>
    
    
</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.sinopia.storage" id="apidoc.module.sinopia.storage">module sinopia.storage</a></h1>
    
    
    <h2>
        <a href="#apidoc.element.sinopia.storage.storage" id="apidoc.element.sinopia.storage.storage">
        function <span class="apidocSignatureSpan">sinopia.</span>storage
        <span class="apidocSignatureSpan">(config)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function Storage(config) {
  var self = Object.create(Storage.prototype)
  self.config = config

  // we support a number of uplinks, but only one local storage
  // Proxy and Local classes should have similar API interfaces
  self.uplinks = {}
  for (var p in config.uplinks) {
    self.uplinks[p] = Proxy(config.uplinks[p], config)
    self.uplinks[p].upname = p
  }
  self.local = Local(config)
  self.logger = Logger.logger.child()

  return self
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
Storage.prototype._internal_error = function(err, file, message) {
this.logger.error( { err: err, file: file }
                 , message + &#x27; @{file}: @{!err.message}&#x27; )
return Error[500]()
}

Storage.prototype.add_package = function(name, info, callback) {
var storage = this.<span class="apidocCodeKeywordSpan">storage</span>(name)
if (!storage) return callback( Error[404](&#x27;this package cannot be added&#x27;) )

storage.create_json(info_file, get_boilerplate(name), function(err) {
  if (err &#x26;&#x26; err.code === &#x27;EEXISTS&#x27;) {
    return callback( Error[409](&#x27;this package is already present&#x27;) )
  }
...</pre></li>
    </ul>
    
    
    
    <h2>
        <a href="#apidoc.element.sinopia.storage._merge_versions" id="apidoc.element.sinopia.storage._merge_versions">
        function <span class="apidocSignatureSpan">sinopia.storage.</span>_merge_versions
        <span class="apidocSignatureSpan">(local, up, config)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">_merge_versions = function (local, up, config) {
  // copy new versions to a cache
  // NOTE: if a certain version was updated, we can&#x27;t refresh it reliably
  for (var i in up.versions) {
    if (local.versions[i] == null) {
      local.versions[i] = up.versions[i]
    }
  }

  // refresh dist-tags
  for (var i in up[&#x27;dist-tags&#x27;]) {
    var added = Utils.tag_version(local, up[&#x27;dist-tags&#x27;][i], i, config || {})
    if (i === &#x27;latest&#x27; &#x26;&#x26; added) {
      // if remote has more fresh package, we should borrow its readme
      local.readme = up.readme
    }
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
    enumerable   : false,
    configurable : false,
    writable     : true,
  })
}

try {
  Storage.<span class="apidocCodeKeywordSpan">_merge_versions</span>(pkginfo, up_res, self.config)
} catch(err) {
  self.logger.error({
    sub: &#x27;out&#x27;,
    err: err,
  }, &#x27;package.json parsing error @{!err.message}\n@{err.stack}&#x27;)
  return cb(null, [ err ])
}
...</pre></li>
    </ul>
    
    
</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.sinopia.storage.prototype" id="apidoc.module.sinopia.storage.prototype">module sinopia.storage.prototype</a></h1>
    
    
    <h2>
        <a href="#apidoc.element.sinopia.storage.prototype._sync_package_with_uplinks" id="apidoc.element.sinopia.storage.prototype._sync_package_with_uplinks">
        function <span class="apidocSignatureSpan">sinopia.storage.prototype.</span>_sync_package_with_uplinks
        <span class="apidocSignatureSpan">(name, pkginfo, options, callback)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">_sync_package_with_uplinks = function (name, pkginfo, options, callback) {
  var self = this

  if (!pkginfo) {
    var exists = false

    pkginfo = {
      name        : name,
      versions    : {},
      &#x27;dist-tags&#x27; : {},
      _uplinks    : {},
    }
  } else {
    var exists = true
  }

  var uplinks = []
  for (var i in self.uplinks) {
    if (self.config.can_proxy_to(name, i)) {
      uplinks.push(self.uplinks[i])
    }
  }

  async.map(uplinks, function(up, cb) {
    var _options = Object.assign({}, options)
    if (Utils.is_object(pkginfo._uplinks[up.upname])) {
      var fetched = pkginfo._uplinks[up.upname].fetched
      if (fetched &#x26;&#x26; fetched &#x3e; (Date.now() - up.maxage)) {
        return cb()
      }

      _options.etag = pkginfo._uplinks[up.upname].etag
    }

    up.get_package(name, _options, function(err, up_res, etag) {
      if (err &#x26;&#x26; err.status === 304)
        pkginfo._uplinks[up.upname].fetched = Date.now()

      if (err || !up_res) return cb(null, [err || Error(&#x27;no data&#x27;)])

      try {
        Utils.validate_metadata(up_res, name)
      } catch(err) {
        self.logger.error({
          sub: &#x27;out&#x27;,
          err: err,
        }, &#x27;package.json validating error @{!err.message}\n@{err.stack}&#x27;)
        return cb(null, [ err ])
      }

      pkginfo._uplinks[up.upname] = {
        etag: etag,
        fetched: Date.now()
      }

      for (var i in up_res.versions) {
        // this won&#x27;t be serialized to json,
        // kinda like an ES6 Symbol
        Object.defineProperty(up_res.versions[i], &#x27;_sinopia_uplink&#x27;, {
          value        : up.upname,
          enumerable   : false,
          configurable : false,
          writable     : true,
        })
      }

      try {
        Storage._merge_versions(pkginfo, up_res, self.config)
      } catch(err) {
        self.logger.error({
          sub: &#x27;out&#x27;,
          err: err,
        }, &#x27;package.json parsing error @{!err.message}\n@{err.stack}&#x27;)
        return cb(null, [ err ])
      }

      // if we got to this point, assume that the correct package exists
      // on the uplink
      exists = true
      cb()
    })
  }, function(err, uplink_errors) {
    assert(!err &#x26;&#x26; Array.isArray(uplink_errors))

    if (!exists) {
      return callback( Error[404](&#x27;no such package available&#x27;)
                     , null
                     , uplink_errors )
    }

    self.local.update_versions(name, pkginfo, function(err, pkginfo) {
      if (err) return callback(err)
      return callback(null, pkginfo, uplink_errors)
    })
  })
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
if (results) return cb( Error[409](&#x27;this package is already present&#x27;) )

cb()
    })
  }

  function check_package_remote(cb) {
    self.<span class="apidocCodeKeywordSpan">_sync_package_with_uplinks</span>(name, null, {}, function(err, results, err_result\
s) {
// something weird
if (err &#x26;&#x26; err.status !== 404) return cb(err)

// checking package
if (results) return cb( Error[409](&#x27;this package is already present&#x27;) )

for (var i=0; i&#x3c;err_results.length; i++) {
...</pre></li>
    </ul>
    
    
    
    <h2>
        <a href="#apidoc.element.sinopia.storage.prototype.add_package" id="apidoc.element.sinopia.storage.prototype.add_package">
        function <span class="apidocSignatureSpan">sinopia.storage.prototype.</span>add_package
        <span class="apidocSignatureSpan">(name, metadata, callback)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">add_package = function (name, metadata, callback) {
  var self = this

  // NOTE:
  // - when we checking package for existance, we ask ALL uplinks
  // - when we publishing package, we only publish it to some of them
  // so all requests are necessary

  check_package_local(function(err) {
    if (err) return callback(err)

    check_package_remote(function(err) {
      if (err) return callback(err)

      publish_package(function(err) {
        if (err) return callback(err)
        callback()
      })
    })
  })

  function check_package_local(cb) {
    self.local.get_package(name, {}, function(err, results) {
      if (err &#x26;&#x26; err.status !== 404) return cb(err)

      if (results) return cb( Error[409](&#x27;this package is already present&#x27;) )

      cb()
    })
  }

  function check_package_remote(cb) {
    self._sync_package_with_uplinks(name, null, {}, function(err, results, err_results) {
      // something weird
      if (err &#x26;&#x26; err.status !== 404) return cb(err)

      // checking package
      if (results) return cb( Error[409](&#x27;this package is already present&#x27;) )

      for (var i=0; i&#x3c;err_results.length; i++) {
        // checking error
        // if uplink fails with a status other than 404, we report failure
        if (err_results[i][0] != null) {
          if (err_results[i][0].status !== 404) {
            return cb( Error[503](&#x27;one of the uplinks is down, refuse to publish&#x27;) )
          }
        }
      }

      return cb()
    })
  }

  function publish_package(cb) {
    self.local.add_package(name, metadata, callback)
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
}

if (req.params._rev) {
  storage.change_package(name, metadata, req.params.revision, function(err) {
    after_change(err, &#x27;package changed&#x27;)
  })
} else {
  storage.<span class="apidocCodeKeywordSpan">add_package</span>(name, metadata, function(err) {
    after_change(err, &#x27;created new package&#x27;)
  })
}

function after_change(err, ok_message) {
  // old npm behaviour
  if (metadata._attachments == null) {
...</pre></li>
    </ul>
    
    
    
    <h2>
        <a href="#apidoc.element.sinopia.storage.prototype.add_tarball" id="apidoc.element.sinopia.storage.prototype.add_tarball">
        function <span class="apidocSignatureSpan">sinopia.storage.prototype.</span>add_tarball
        <span class="apidocSignatureSpan">(name, filename)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">add_tarball = function (name, filename) {
  return this.local.add_tarball(name, filename)
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
        return next({ ok: ok_message })
      })
    })
  })
}

function create_tarball(filename, data, cb) {
  var stream = storage.<span class="apidocCodeKeywordSpan">add_tarball</span>(name, filename)
  stream.on(&#x27;error&#x27;, function(err) {
    cb(err)
  })
  stream.on(&#x27;success&#x27;, function() {
    cb()
  })
...</pre></li>
    </ul>
    
    
    
    <h2>
        <a href="#apidoc.element.sinopia.storage.prototype.add_version" id="apidoc.element.sinopia.storage.prototype.add_version">
        function <span class="apidocSignatureSpan">sinopia.storage.prototype.</span>add_version
        <span class="apidocSignatureSpan">(name, version, metadata, tag, callback)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">add_version = function (name, version, metadata, tag, callback) {
  return this.local.add_version(name, version, metadata, tag, callback)
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...

    // this is dumb and memory-consuming, but what choices do we have?
    stream.end(Buffer(data.data, &#x27;base64&#x27;))
    stream.done()
  }

  function create_version(version, data, cb) {
    storage.<span class="apidocCodeKeywordSpan">add_version</span>(name, version, data, null, cb)
  }

  function add_tags(tags, cb) {
    storage.merge_tags(name, tags, cb)
  }
})
...</pre></li>
    </ul>
    
    
    
    <h2>
        <a href="#apidoc.element.sinopia.storage.prototype.change_package" id="apidoc.element.sinopia.storage.prototype.change_package">
        function <span class="apidocSignatureSpan">sinopia.storage.prototype.</span>change_package
        <span class="apidocSignatureSpan">(name, metadata, revision, callback)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">change_package = function (name, metadata, revision, callback) {
  return this.local.change_package(name, metadata, revision, callback)
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
try {
  var metadata = Utils.validate_metadata(req.body, name)
} catch(err) {
  return next( Error[422](&#x27;bad incoming package data&#x27;) )
}

if (req.params._rev) {
  storage.<span class="apidocCodeKeywordSpan">change_package</span>(name, metadata, req.params.revision, function(err) {
    after_change(err, &#x27;package changed&#x27;)
  })
} else {
  storage.add_package(name, metadata, function(err) {
    after_change(err, &#x27;created new package&#x27;)
  })
}
...</pre></li>
    </ul>
    
    
    
    <h2>
        <a href="#apidoc.element.sinopia.storage.prototype.get_local" id="apidoc.element.sinopia.storage.prototype.get_local">
        function <span class="apidocSignatureSpan">sinopia.storage.prototype.</span>get_local
        <span class="apidocSignatureSpan">(callback)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">get_local = function (callback) {
  var self = this
  var locals = this.config.localList.get()
  var packages = []

  var getPackage = function(i) {
    self.local.get_package(locals[i], function(err, info) {
      if (!err) {
        var latest = Array.isArray(info[&#x27;dist-tags&#x27;].latest)
                   ? Utils.semver_sort(info[&#x27;dist-tags&#x27;].latest).pop()
                   : info[&#x27;dist-tags&#x27;].latest
        if (info.versions[latest]) {
          packages.push(info.versions[latest])
        } else {
          self.logger.warn( { package: locals[i] }
                          , &#x27;package @{package} does not have a &#x22;latest&#x22; tag?&#x27; )
        }
      }

      if (i &#x3e;= locals.length - 1) {
        callback(null, packages)
      } else {
        getPackage(i + 1)
      }
    })
  }

  if (locals.length) {
    getPackage(0)
  } else {
    callback(null, [])
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  }
  app.get(&#x27;/&#x27;, function(req, res, next) {
var base = config.url_prefix
         ? config.url_prefix.replace(/\/$/, &#x27;&#x27;)
         : req.protocol + &#x27;://&#x27; + req.get(&#x27;host&#x27;)
res.setHeader(&#x27;Content-Type&#x27;, &#x27;text/html&#x27;)

storage.<span class="apidocCodeKeywordSpan">get_local</span>(function(err, packages) {
  if (err) throw err // that function shouldn&#x27;t produce any
  async.filterSeries(packages, function(package, cb) {
    auth.allow_access(package.name, req.remote_user, function(err, allowed) {
      setImmediate(function () {
        cb(!err &#x26;&#x26; allowed)
      })
    })
...</pre></li>
    </ul>
    
    
    
    <h2>
        <a href="#apidoc.element.sinopia.storage.prototype.get_package" id="apidoc.element.sinopia.storage.prototype.get_package">
        function <span class="apidocSignatureSpan">sinopia.storage.prototype.</span>get_package
        <span class="apidocSignatureSpan">(name, options, callback)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">get_package = function (name, options, callback) {
  if (typeof(options) === &#x27;function&#x27;) callback = options, options = {}

  var self = this

  self.local.get_package(name, options, function(err, data) {
    if (err &#x26;&#x26; (!err.status || err.status &#x3e;= 500)) {
      // report internal errors right away
      return callback(err)
    }

    self._sync_package_with_uplinks(name, data, options, function(err, result, uplink_errors) {
      if (err) return callback(err)
      var whitelist = [ &#x27;_rev&#x27;, &#x27;name&#x27;, &#x27;versions&#x27;, &#x27;dist-tags&#x27;, &#x27;readme&#x27; ]
      for (var i in result) {
        if (whitelist.indexOf(i) === -1) delete result[i]
      }

      if (self.config.ignore_latest_tag || !result[&#x27;dist-tags&#x27;].latest) {
        result[&#x27;dist-tags&#x27;].latest = Utils.semver_sort(Object.keys(result.versions))
      }

      for (var i in result[&#x27;dist-tags&#x27;]) {
        if (Array.isArray(result[&#x27;dist-tags&#x27;][i])) {
          result[&#x27;dist-tags&#x27;][i] = result[&#x27;dist-tags&#x27;][i][result[&#x27;dist-tags&#x27;][i].length-1]
          if (result[&#x27;dist-tags&#x27;][i] == null) delete result[&#x27;dist-tags&#x27;][i]
        }
      }

      // npm can throw if this field doesn&#x27;t exist
      result._attachments = {}

      callback(null, result, uplink_errors)
    })
  })
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  })
  app.get(&#x27;/-/whoami&#x27;, function(req, res, next) {
    next({ username: req.remote_user.name })
  })

  // TODO: anonymous user?
  app.get(&#x27;/:package/:version?&#x27;, can(&#x27;access&#x27;), function(req, res, next) {
    storage.<span class="apidocCodeKeywordSpan">get_package</span>(req.params.package, { req: req }, function(err, info) {
if (err) return next(err)
info = Utils.filter_tarball_urls(info, req, config)

var version = req.params.version
if (!version) return next(info)

var t = Utils.get_version(info, version)
...</pre></li>
    </ul>
    
    
    
    <h2>
        <a href="#apidoc.element.sinopia.storage.prototype.get_tarball" id="apidoc.element.sinopia.storage.prototype.get_tarball">
        function <span class="apidocSignatureSpan">sinopia.storage.prototype.</span>get_tarball
        <span class="apidocSignatureSpan">(name, filename)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">get_tarball = function (name, filename) {
  var stream = MyStreams.ReadTarballStream()
  stream.abort = function() {}

  var self = this

  // if someone requesting tarball, it means that we should already have some
  // information about it, so fetching package info is unnecessary

  // trying local first
  var rstream = self.local.get_tarball(name, filename)
  var is_open = false
  rstream.on(&#x27;error&#x27;, function(err) {
    if (is_open || err.status !== 404) {
      return stream.emit(&#x27;error&#x27;, err)
    }

    // local reported 404
    var err404 = err
    rstream.abort()
    rstream = null // gc

    self.local.get_package(name, function(err, info) {
      if (!err &#x26;&#x26; info._distfiles &#x26;&#x26; info._distfiles[filename] != null) {
        // information about this file exists locally
        serve_file(info._distfiles[filename])

      } else {
        // we know nothing about this file, trying to get information elsewhere

        self._sync_package_with_uplinks(name, info, {}, function(err, info) {
          if (err) return stream.emit(&#x27;error&#x27;, err)

          if (!info._distfiles || info._distfiles[filename] == null) {
            return stream.emit(&#x27;error&#x27;, err404)
          }

          serve_file(info._distfiles[filename])
        })
      }
    })
  })
  rstream.on(&#x27;content-length&#x27;, function(v) {
    stream.emit(&#x27;content-length&#x27;, v)
  })
  rstream.on(&#x27;open&#x27;, function() {
    is_open = true
    rstream.pipe(stream)
  })
  return stream

  function serve_file(file) {
    var uplink = null
    for (var p in self.uplinks) {
      if (self.uplinks[p].can_fetch_url(file.url)) {
        uplink = self.uplinks[p]
      }
    }
    if (uplink == null) {
      uplink = Proxy({
        url: file.url,
        _autogenerated: true,
      }, self.config)
    }

    var savestream = self.local.add_tarball(name, filename)
    var on_open = function() {
      on_open = function(){} // prevent it from being called twice
      var rstream2 = uplink.get_url(file.url)
      rstream2.on(&#x27;error&#x27;, function(err) {
        if (savestream) savestream.abort()
        savestream = null
        stream.emit(&#x27;error&#x27;, err)
      })
      rstream2.on(&#x27;end&#x27;, function() {
        if (savestream) savestream.done()
      })

      rstream2.on(&#x27;content-length&#x27;, function(v) {
        stream.emit(&#x27;content-length&#x27;, v)
        if (savestream) savestream.emit(&#x27;content-length&#x27;, v)
      })
      rstream2.pipe(stream)
      if (savestream) rstream2.pipe(savestream)
    }

    savestream.on(&#x27;open&#x27;, function() {
      on_open()
    })
    savestream.on(&#x27;error&#x27;, function(err) {
      self.logger.warn( { err: err }
                      , &#x27;error saving file: @{err.message}\n@{err.stack}&#x27; )
      if (savestream) savestream.abort()
      savestream = null
      on_open()
    })
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
    }

    return next( Error[404](&#x27;version not found: &#x27; + req.params.version) )
  })
})

app.get(&#x27;/:package/-/:filename&#x27;, can(&#x27;access&#x27;), function(req, res, next) {
  var stream = storage.<span class="apidocCodeKeywordSpan">get_tarball</span>(req.params.package, req.params.filename)
  stream.on(&#x27;content-length&#x27;, function(v) {
    res.header(&#x27;Content-Length&#x27;, v)
  })
  stream.on(&#x27;error&#x27;, function(err) {
    return res.report_error(err)
  })
  res.header(&#x27;Content-Type&#x27;, &#x27;application/octet-stream&#x27;)
...</pre></li>
    </ul>
    
    
    
    <h2>
        <a href="#apidoc.element.sinopia.storage.prototype.merge_tags" id="apidoc.element.sinopia.storage.prototype.merge_tags">
        function <span class="apidocSignatureSpan">sinopia.storage.prototype.</span>merge_tags
        <span class="apidocSignatureSpan">(name, tag_hash, callback)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">merge_tags = function (name, tag_hash, callback) {
  return this.local.merge_tags(name, tag_hash, callback)
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
})

function tag_package_version(req, res, next) {
  if (typeof(req.body) !== &#x27;string&#x27;) return next(&#x27;route&#x27;)

  var tags = {}
  tags[req.params.tag] = req.body
  storage.<span class="apidocCodeKeywordSpan">merge_tags</span>(req.params.package, tags, function(err) {
    if (err) return next(err)
    res.status(201)
    return next({ ok: &#x27;package tagged&#x27; })
  })
}

// tagging a package
...</pre></li>
    </ul>
    
    
    
    <h2>
        <a href="#apidoc.element.sinopia.storage.prototype.remove_package" id="apidoc.element.sinopia.storage.prototype.remove_package">
        function <span class="apidocSignatureSpan">sinopia.storage.prototype.</span>remove_package
        <span class="apidocSignatureSpan">(name, callback)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">remove_package = function (name, callback) {
  return this.local.remove_package(name, callback)
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  function add_tags(tags, cb) {
    storage.merge_tags(name, tags, cb)
  }
})

// unpublishing an entire package
app.delete(&#x27;/:package/-rev/*&#x27;, can(&#x27;publish&#x27;), function(req, res, next) {
  storage.<span class="apidocCodeKeywordSpan">remove_package</span>(req.params.package, function(err) {
    if (err) return next(err)
    res.status(201)
    return next({ ok: &#x27;package removed&#x27; })
  })
})

// removing a tarball
...</pre></li>
    </ul>
    
    
    
    <h2>
        <a href="#apidoc.element.sinopia.storage.prototype.remove_tarball" id="apidoc.element.sinopia.storage.prototype.remove_tarball">
        function <span class="apidocSignatureSpan">sinopia.storage.prototype.</span>remove_tarball
        <span class="apidocSignatureSpan">(name, filename, revision, callback)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">remove_tarball = function (name, filename, revision, callback) {
  return this.local.remove_tarball(name, filename, revision, callback)
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
    res.status(201)
    return next({ ok: &#x27;package removed&#x27; })
  })
})

// removing a tarball
app.delete(&#x27;/:package/-/:filename/-rev/:revision&#x27;, can(&#x27;publish&#x27;), function(req, res, next) {
  storage.<span class="apidocCodeKeywordSpan">remove_tarball</span>(req.params.package, req.params.filename, req.params.revision\
, function(err) {
    if (err) return next(err)
    res.status(201)
    return next({ ok: &#x27;tarball removed&#x27; })
  })
})

// uploading package tarball
...</pre></li>
    </ul>
    
    
    
    <h2>
        <a href="#apidoc.element.sinopia.storage.prototype.replace_tags" id="apidoc.element.sinopia.storage.prototype.replace_tags">
        function <span class="apidocSignatureSpan">sinopia.storage.prototype.</span>replace_tags
        <span class="apidocSignatureSpan">(name, tag_hash, callback)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">replace_tags = function (name, tag_hash, callback) {
  return this.local.replace_tags(name, tag_hash, callback)
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  })
})

app.put(&#x27;/-/package/:package/dist-tags&#x27;,
    can(&#x27;publish&#x27;), media(&#x27;application/json&#x27;), expect_json,
    function(req, res, next) {

  storage.<span class="apidocCodeKeywordSpan">replace_tags</span>(req.params.package, req.body, function(err) {
    if (err) return next(err)
    res.status(201)
    return next({ ok: &#x27;tags updated&#x27; })
  })
})

app.delete(&#x27;/-/package/:package/dist-tags&#x27;,
...</pre></li>
    </ul>
    
    
    
    <h2>
        <a href="#apidoc.element.sinopia.storage.prototype.search" id="apidoc.element.sinopia.storage.prototype.search">
        function <span class="apidocSignatureSpan">sinopia.storage.prototype.</span>search
        <span class="apidocSignatureSpan">(startkey, options)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">search = function (startkey, options) {
  var self = this

  var stream = new Stream.PassThrough({ objectMode: true })

  async.eachSeries(Object.keys(self.uplinks), function(up_name, cb) {
    // shortcut: if `local=1` is supplied, don&#x27;t call uplinks
    if (options.req.query.local !== undefined) return cb()

    var lstream = self.uplinks[up_name].search(startkey, options)
    lstream.pipe(stream, { end: false })
    lstream.on(&#x27;error&#x27;, function (err) {
      self.logger.error({ err: err }, &#x27;uplink error: @{err.message}&#x27;)
      cb(), cb = function () {}
    })
    lstream.on(&#x27;end&#x27;, function () {
      cb(), cb = function () {}
    })

    stream.abort = function () {
      if (lstream.abort) lstream.abort()
      cb(), cb = function () {}
    }
  }, function () {
    var lstream = self.local.search(startkey, options)
    stream.abort = function () { lstream.abort() }
    lstream.pipe(stream, { end: true })
    lstream.on(&#x27;error&#x27;, function (err) {
      self.logger.error({ err: err }, &#x27;search error: @{err.message}&#x27;)
      stream.end()
    })
  })

  return stream
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
    var received_end      = false
    var response_finished = false
    var processing_pkgs   = 0

    res.status(200)
    res.write(&#x27;{&#x22;_updated&#x22;:&#x27; + Date.now());

    var stream = storage.<span class="apidocCodeKeywordSpan">search</span>(req.param.startkey || 0, { req: req })

    stream.on(&#x27;data&#x27;, function each(pkg) {
processing_pkgs++

auth.allow_access(pkg.name, req.remote_user, function(err, allowed) {
  processing_pkgs--
...</pre></li>
    </ul>
    
    
</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.sinopia.streams" id="apidoc.module.sinopia.streams">module sinopia.streams</a></h1>
    
    
    <h2>
        <a href="#apidoc.element.sinopia.streams.ReadTarballStream" id="apidoc.element.sinopia.streams.ReadTarballStream">
        function <span class="apidocSignatureSpan">sinopia.streams.</span>ReadTarballStream
        <span class="apidocSignatureSpan">(options)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function ReadTarball(options) {
  var self = new Stream.PassThrough(options)
  Object.setPrototypeOf(self, ReadTarball.prototype)

  // called when data is not needed anymore
  add_abstract_method(self, &#x27;abort&#x27;)

  return self
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
      if (err) return stream.emit(&#x27;error&#x27;, err)
      stream.emit(&#x27;content-length&#x27;, stats.size)
      stream.emit(&#x27;open&#x27;)
      rstream.pipe(stream)
    })
  })

  var stream = MyStreams.<span class="apidocCodeKeywordSpan">ReadTarballStream</span>()
  stream.abort = function() {
    rstream.close()
  }
  return stream
}

function create(name, contents, callback) {
...</pre></li>
    </ul>
    
    
    
    <h2>
        <a href="#apidoc.element.sinopia.streams.UploadTarballStream" id="apidoc.element.sinopia.streams.UploadTarballStream">
        function <span class="apidocSignatureSpan">sinopia.streams.</span>UploadTarballStream
        <span class="apidocSignatureSpan">(options)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function UploadTarball(options) {
  var self = new Stream.PassThrough(options)
  Object.setPrototypeOf(self, UploadTarball.prototype)

  // called when user closes connection before upload finishes
  add_abstract_method(self, &#x27;abort&#x27;)

  // called when upload finishes successfully
  add_abstract_method(self, &#x27;done&#x27;)

  return self
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  } else {
    cb(err)
  }
})
}

function write_stream(name) {
var stream = MyStreams.<span class="apidocCodeKeywordSpan">UploadTarballStream</span>()

var _ended = 0
stream.on(&#x27;end&#x27;, function() {
  _ended = 1
})

fs.exists(name, function(exists) {
...</pre></li>
    </ul>
    
    
</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.sinopia.up_storage" id="apidoc.module.sinopia.up_storage">module sinopia.up_storage</a></h1>
    
    
    <h2>
        <a href="#apidoc.element.sinopia.up_storage.up_storage" id="apidoc.element.sinopia.up_storage.up_storage">
        function <span class="apidocSignatureSpan">sinopia.</span>up_storage
        <span class="apidocSignatureSpan">(config, mainconfig)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function Storage(config, mainconfig) {
  var self = Object.create(Storage.prototype)
  self.config = config
  self.failed_requests = 0
  self.userAgent = mainconfig.user_agent
  self.ca = config.ca
  self.logger = Logger.logger.child({sub: &#x27;out&#x27;})
  self.server_id = mainconfig.server_id

  self.url = URL.parse(self.config.url)

  _setupProxy.call(self, self.url.hostname, config, mainconfig, self.url.protocol === &#x27;https:&#x27;)

  self.config.url = self.config.url.replace(/\/$/, &#x27;&#x27;)
  if (Number(self.config.timeout) &#x3e;= 1000) {
    self.logger.warn([ &#x27;Too big timeout value: &#x27; + self.config.timeout,
                       &#x27;We changed time format to nginx-like one&#x27;,
                       &#x27;(see http://wiki.nginx.org/ConfigNotation)&#x27;,
                       &#x27;so please update your config accordingly&#x27; ].join(&#x27;\n&#x27;))
  }

  // a bunch of different configurable timers
  self.maxage       = parse_interval(config_get(&#x27;maxage&#x27;      , &#x27;2m&#x27; ))
  self.timeout      = parse_interval(config_get(&#x27;timeout&#x27;     , &#x27;30s&#x27;))
  self.max_fails    =         Number(config_get(&#x27;max_fails&#x27;   ,  2   ))
  self.fail_timeout = parse_interval(config_get(&#x27;fail_timeout&#x27;, &#x27;5m&#x27; ))
  return self

  // just a helper (`config[key] || default` doesn&#x27;t work because of zeroes)
  function config_get(key, def) {
    return config[key] != null ? config[key] : def
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>
    
    
</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.sinopia.up_storage.prototype" id="apidoc.module.sinopia.up_storage.prototype">module sinopia.up_storage.prototype</a></h1>
    
    
    <h2>
        <a href="#apidoc.element.sinopia.up_storage.prototype._add_proxy_headers" id="apidoc.element.sinopia.up_storage.prototype._add_proxy_headers">
        function <span class="apidocSignatureSpan">sinopia.up_storage.prototype.</span>_add_proxy_headers
        <span class="apidocSignatureSpan">(req, headers)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">_add_proxy_headers = function (req, headers) {
  if (req) {
    // Only submit X-Forwarded-For field if we don&#x27;t have a proxy selected
    // in the config file.
    //
    // Otherwise misconfigured proxy could return 407:
    // https://github.com/rlidwka/sinopia/issues/254
    //
    if (!this.proxy) {
      headers[&#x27;X-Forwarded-For&#x27;] = (
        req &#x26;&#x26; req.headers[&#x27;x-forwarded-for&#x27;]
        ? req.headers[&#x27;x-forwarded-for&#x27;] + &#x27;, &#x27;
        : &#x27;&#x27;
      ) + req.connection.remoteAddress
    }
  }

  // always attach Via header to avoid loops, even if we&#x27;re not proxying
  headers[&#x27;Via&#x27;] =
    req &#x26;&#x26; req.headers[&#x27;via&#x27;]
    ? req.headers[&#x27;via&#x27;] + &#x27;, &#x27;
    : &#x27;&#x27;

  headers[&#x27;Via&#x27;] += &#x27;1.1 &#x27; + this.server_id + &#x27; (Sinopia)&#x27;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
}

var self = this
var headers = options.headers || {}
headers[&#x27;Accept&#x27;]          = headers[&#x27;Accept&#x27;]          || &#x27;application/json&#x27;
headers[&#x27;Accept-Encoding&#x27;] = headers[&#x27;Accept-Encoding&#x27;] || &#x27;gzip&#x27;
headers[&#x27;User-Agent&#x27;]      = headers[&#x27;User-Agent&#x27;]      || this.userAgent
this.<span class="apidocCodeKeywordSpan">_add_proxy_headers</span>(options.req, headers)

var method = options.method   || &#x27;GET&#x27;
var uri    = options.uri_full || (this.config.url + options.uri)

self.logger.info({
  method  : method,
  headers : headers,
...</pre></li>
    </ul>
    
    
    
    <h2>
        <a href="#apidoc.element.sinopia.up_storage.prototype.can_fetch_url" id="apidoc.element.sinopia.up_storage.prototype.can_fetch_url">
        function <span class="apidocSignatureSpan">sinopia.up_storage.prototype.</span>can_fetch_url
        <span class="apidocSignatureSpan">(url)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">can_fetch_url = function (url) {
  url = URL.parse(url)

  return url.protocol === this.url.protocol
      &#x26;&#x26; url.host === this.url.host
      &#x26;&#x26; url.path.indexOf(this.url.path) === 0
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  rstream.pipe(stream)
})
return stream

function serve_file(file) {
  var uplink = null
  for (var p in self.uplinks) {
    if (self.uplinks[p].<span class="apidocCodeKeywordSpan">can_fetch_url</span>(file.url)) {
      uplink = self.uplinks[p]
    }
  }
  if (uplink == null) {
    uplink = Proxy({
      url: file.url,
      _autogenerated: true,
...</pre></li>
    </ul>
    
    
    
    <h2>
        <a href="#apidoc.element.sinopia.up_storage.prototype.get_package" id="apidoc.element.sinopia.up_storage.prototype.get_package">
        function <span class="apidocSignatureSpan">sinopia.up_storage.prototype.</span>get_package
        <span class="apidocSignatureSpan">(name, options, callback)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">get_package = function (name, options, callback) {
  if (typeof(options) === &#x27;function&#x27;) callback = options, options = {}

  var headers = {}
  if (options.etag) {
    headers[&#x27;If-None-Match&#x27;] = options.etag
    headers[&#x27;Accept&#x27;]        = &#x27;application/octet-stream&#x27;
  }

  this.request({
    uri     : &#x27;/&#x27; + encode(name),
    json    : true,
    headers : headers,
    req     : options.req,
  }, function(err, res, body) {
    if (err) return callback(err)
    if (res.statusCode === 404) {
      return callback( Error[404](&#x22;package doesn&#x27;t exist on uplink&#x22;) )
    }
    if (!(res.statusCode &#x3e;= 200 &#x26;&#x26; res.statusCode &#x3c; 300)) {
      var error = Error(&#x27;bad status code: &#x27; + res.statusCode)
      error.remoteStatus = res.statusCode
      return callback(error)
    }
    callback(null, body, res.headers.etag)
  })
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  })
  app.get(&#x27;/-/whoami&#x27;, function(req, res, next) {
    next({ username: req.remote_user.name })
  })

  // TODO: anonymous user?
  app.get(&#x27;/:package/:version?&#x27;, can(&#x27;access&#x27;), function(req, res, next) {
    storage.<span class="apidocCodeKeywordSpan">get_package</span>(req.params.package, { req: req }, function(err, info) {
if (err) return next(err)
info = Utils.filter_tarball_urls(info, req, config)

var version = req.params.version
if (!version) return next(info)

var t = Utils.get_version(info, version)
...</pre></li>
    </ul>
    
    
    
    <h2>
        <a href="#apidoc.element.sinopia.up_storage.prototype.get_tarball" id="apidoc.element.sinopia.up_storage.prototype.get_tarball">
        function <span class="apidocSignatureSpan">sinopia.up_storage.prototype.</span>get_tarball
        <span class="apidocSignatureSpan">(name, options, filename)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">get_tarball = function (name, options, filename) {
  if (!options) options = {}
  return this.get_url(this.config.url + &#x27;/&#x27; + name + &#x27;/-/&#x27; + filename)
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
    }

    return next( Error[404](&#x27;version not found: &#x27; + req.params.version) )
  })
})

app.get(&#x27;/:package/-/:filename&#x27;, can(&#x27;access&#x27;), function(req, res, next) {
  var stream = storage.<span class="apidocCodeKeywordSpan">get_tarball</span>(req.params.package, req.params.filename)
  stream.on(&#x27;content-length&#x27;, function(v) {
    res.header(&#x27;Content-Length&#x27;, v)
  })
  stream.on(&#x27;error&#x27;, function(err) {
    return res.report_error(err)
  })
  res.header(&#x27;Content-Type&#x27;, &#x27;application/octet-stream&#x27;)
...</pre></li>
    </ul>
    
    
    
    <h2>
        <a href="#apidoc.element.sinopia.up_storage.prototype.get_url" id="apidoc.element.sinopia.up_storage.prototype.get_url">
        function <span class="apidocSignatureSpan">sinopia.up_storage.prototype.</span>get_url
        <span class="apidocSignatureSpan">(url)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">get_url = function (url) {
  var stream = MyStreams.ReadTarballStream()
  stream.abort = function() {}
  var current_length = 0, expected_length

  var rstream = this.request({
    uri_full: url,
    encoding: null,
    headers: { Accept: &#x27;application/octet-stream&#x27; },
  })

  rstream.on(&#x27;response&#x27;, function(res) {
    if (res.statusCode === 404) {
      return stream.emit(&#x27;error&#x27;, Error[404](&#x22;file doesn&#x27;t exist on uplink&#x22;))
    }
    if (!(res.statusCode &#x3e;= 200 &#x26;&#x26; res.statusCode &#x3c; 300)) {
      return stream.emit(&#x27;error&#x27;, Error(&#x27;bad uplink status code: &#x27; + res.statusCode))
    }
    if (res.headers[&#x27;content-length&#x27;]) {
      expected_length = res.headers[&#x27;content-length&#x27;]
      stream.emit(&#x27;content-length&#x27;, res.headers[&#x27;content-length&#x27;])
    }

    rstream.pipe(stream)
  })

  rstream.on(&#x27;error&#x27;, function(err) {
    stream.emit(&#x27;error&#x27;, err)
  })
  rstream.on(&#x27;data&#x27;, function(d) {
    current_length += d.length
  })
  rstream.on(&#x27;end&#x27;, function(d) {
    if (d) current_length += d.length
    if (expected_length &#x26;&#x26; current_length != expected_length)
      stream.emit(&#x27;error&#x27;, Error(&#x27;content length mismatch&#x27;))
  })
  return stream
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
    _autogenerated: true,
  }, self.config)
}

var savestream = self.local.add_tarball(name, filename)
var on_open = function() {
  on_open = function(){} // prevent it from being called twice
  var rstream2 = uplink.<span class="apidocCodeKeywordSpan">get_url</span>(file.url)
  rstream2.on(&#x27;error&#x27;, function(err) {
    if (savestream) savestream.abort()
    savestream = null
    stream.emit(&#x27;error&#x27;, err)
  })
  rstream2.on(&#x27;end&#x27;, function() {
    if (savestream) savestream.done()
...</pre></li>
    </ul>
    
    
    
    <h2>
        <a href="#apidoc.element.sinopia.up_storage.prototype.request" id="apidoc.element.sinopia.up_storage.prototype.request">
        function <span class="apidocSignatureSpan">sinopia.up_storage.prototype.</span>request
        <span class="apidocSignatureSpan">(options, cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">request = function (options, cb) {
  if (!this.status_check()) {
    var req = new Stream.Readable()
    process.nextTick(function() {
      if (typeof(cb) === &#x27;function&#x27;) cb(Error(&#x27;uplink is offline&#x27;))
      req.emit(&#x27;error&#x27;, Error(&#x27;uplink is offline&#x27;))
    })
    // preventing &#x27;Uncaught, unspecified &#x22;error&#x22; event&#x27;
    req.on(&#x27;error&#x27;, function(){})
    return req
  }

  var self = this
  var headers = options.headers || {}
  headers[&#x27;Accept&#x27;]          = headers[&#x27;Accept&#x27;]          || &#x27;application/json&#x27;
  headers[&#x27;Accept-Encoding&#x27;] = headers[&#x27;Accept-Encoding&#x27;] || &#x27;gzip&#x27;
  headers[&#x27;User-Agent&#x27;]      = headers[&#x27;User-Agent&#x27;]      || this.userAgent
  this._add_proxy_headers(options.req, headers)

  var method = options.method   || &#x27;GET&#x27;
  var uri    = options.uri_full || (this.config.url + options.uri)

  self.logger.info({
    method  : method,
    headers : headers,
    uri     : uri,
  }, &#x22;making request: &#x27;@{method} @{uri}&#x27;&#x22;)

  if (Utils.is_object(options.json)) {
    var json = JSON.stringify(options.json)
    headers[&#x27;Content-Type&#x27;] = headers[&#x27;Content-Type&#x27;] || &#x27;application/json&#x27;
  }

  var request_callback = cb ? (function (err, res, body) {
    var error
    var res_length = err ? 0 : body.length

    do_decode()
    do_log()
    cb(err, res, body)

    function do_decode() {
      if (err) {
        error = err.message
        return
      }

      if (options.json &#x26;&#x26; res.statusCode &#x3c; 300) {
        try {
          body = JSON.parse(body.toString(&#x27;utf8&#x27;))
        } catch(_err) {
          body = {}
          err = _err
          error = err.message
        }
      }

      if (!err &#x26;&#x26; Utils.is_object(body)) {
        if (typeof(body.error) === &#x27;string&#x27;) {
          error = body.error
        }
      }
    }

    function do_log() {
      var message = &#x27;@{!status}, req: \&#x27;@{request.method} @{request.url}\&#x27;&#x27;
      message += error
               ? &#x27;, error: @{!error}&#x27;
               : &#x27;, bytes: @{bytes.in}/@{bytes.out}&#x27;
      self.logger.warn({
        err     : err,
        request : { method: method, url: uri },
        level   : 35, // http
        status  : res != null ? res.statusCode : &#x27;ERR&#x27;,
        error   : error,
        bytes   : {
          in  : json ? json.length : 0,
          out : res_length || 0,
        }
      }, message)
    }
  }) : undefined

  var req = request({
    url      : uri,
    method   : method,
    headers  : headers,
    body     : json,
    ca       : this.ca,
    proxy    : this.proxy,
    encoding : null,
    gzip     : true,
    timeout  : this.timeout,
  }, request_callback)

  var status_called = false
  req.on(&#x27;response&#x27;, function(res) {
    if (!req._sinopia_aborted &#x26;&#x26; !status_called) {
      status_called = true
      self.status_check(true)
    }

    if (!request_callback) {
      ;(function do_log() {
        var message = &#x27;@{!status}, req: \&#x27;@{request.method} @{request.url}\&#x27; (streaming)&#x27;
        self.logger.warn({
          request : { method: method, url: uri },
          level   : 35, // http
          status  : res != null ? res.statusCode : &#x27;ERR&#x27;,
        }, message)
      })()
    }
  })
  req.on(&#x27;error&#x27;, function(_err) {
    if (!req._sinopia_aborted &#x26;&#x26; !status_called) {
      status_called = true
      self.status_check(false)
    }
  })
  return req
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...

var headers = {}
if (options.etag) {
  headers[&#x27;If-None-Match&#x27;] = options.etag
  headers[&#x27;Accept&#x27;]        = &#x27;application/octet-stream&#x27;
}

this.<span class="apidocCodeKeywordSpan">request</span>({
  uri     : &#x27;/&#x27; + encode(name),
  json    : true,
  headers : headers,
  req     : options.req,
}, function(err, res, body) {
  if (err) return callback(err)
  if (res.statusCode === 404) {
...</pre></li>
    </ul>
    
    
    
    <h2>
        <a href="#apidoc.element.sinopia.up_storage.prototype.search" id="apidoc.element.sinopia.up_storage.prototype.search">
        function <span class="apidocSignatureSpan">sinopia.up_storage.prototype.</span>search
        <span class="apidocSignatureSpan">(startkey, options)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">search = function (startkey, options) {
  var self = this

  var stream = new Stream.PassThrough({ objectMode: true })

  var req = self.request({
    uri: options.req.url,
    req: options.req,
  })

  req.on(&#x27;response&#x27;, function (res) {
    if (!String(res.statusCode).match(/^2\d\d$/)) {
      return stream.emit(&#x27;error&#x27;, Error(&#x27;bad status code &#x27; + res.statusCode + &#x27; from uplink&#x27;))
    }

    res.pipe(JSONStream.parse(&#x27;*&#x27;)).on(&#x27;data&#x27;, function (pkg) {
      if (Utils.is_object(pkg)) {
        stream.emit(&#x27;data&#x27;, pkg)
      }
    })

    res.on(&#x27;end&#x27;, function () {
      stream.emit(&#x27;end&#x27;)
    })
  })

  req.on(&#x27;error&#x27;, function (err) {
    stream.emit(&#x27;error&#x27;, err)
  })

  stream.abort = function () {
    req.abort()
    stream.emit(&#x27;end&#x27;)
  }

  return stream
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
    var received_end      = false
    var response_finished = false
    var processing_pkgs   = 0

    res.status(200)
    res.write(&#x27;{&#x22;_updated&#x22;:&#x27; + Date.now());

    var stream = storage.<span class="apidocCodeKeywordSpan">search</span>(req.param.startkey || 0, { req: req })

    stream.on(&#x27;data&#x27;, function each(pkg) {
processing_pkgs++

auth.allow_access(pkg.name, req.remote_user, function(err, allowed) {
  processing_pkgs--
...</pre></li>
    </ul>
    
    
    
    <h2>
        <a href="#apidoc.element.sinopia.up_storage.prototype.status_check" id="apidoc.element.sinopia.up_storage.prototype.status_check">
        function <span class="apidocSignatureSpan">sinopia.up_storage.prototype.</span>status_check
        <span class="apidocSignatureSpan">(alive)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">status_check = function (alive) {
  if (arguments.length === 0) {
    if (this.failed_requests &#x3e;= this.max_fails
     &#x26;&#x26; Math.abs(Date.now() - this.last_request_time) &#x3c; this.fail_timeout) {
      return false
    } else {
      return true
    }
  } else {
    if (alive) {
      if (this.failed_requests &#x3e;= this.max_fails) {
        this.logger.warn({ host: this.url.host }, &#x27;host @{host} is back online&#x27;)
      }
      this.failed_requests = 0
    } else {
      this.failed_requests++
      if (this.failed_requests === this.max_fails) {
        this.logger.warn({ host: this.url.host }, &#x27;host @{host} is now offline&#x27;)
      }
    }
    this.last_request_time = Date.now()
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
} else {
  this.logger.debug( { url: this.url.href, proxy: this.proxy }
                   , &#x27;using proxy @{proxy} for @{url}&#x27; )
}
}

Storage.prototype.request = function(options, cb) {
if (!this.<span class="apidocCodeKeywordSpan">status_check</span>()) {
  var req = new Stream.Readable()
  process.nextTick(function() {
    if (typeof(cb) === &#x27;function&#x27;) cb(Error(&#x27;uplink is offline&#x27;))
    req.emit(&#x27;error&#x27;, Error(&#x27;uplink is offline&#x27;))
  })
  // preventing &#x27;Uncaught, unspecified &#x22;error&#x22; event&#x27;
  req.on(&#x27;error&#x27;, function(){})
...</pre></li>
    </ul>
    
    
</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.sinopia.utils" id="apidoc.module.sinopia.utils">module sinopia.utils</a></h1>
    
    
    <h2>
        <a href="#apidoc.element.sinopia.utils.filter_tarball_urls" id="apidoc.element.sinopia.utils.filter_tarball_urls">
        function <span class="apidocSignatureSpan">sinopia.utils.</span>filter_tarball_urls
        <span class="apidocSignatureSpan">(pkg, req, config)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">filter_tarball_urls = function (pkg, req, config) {
  function filter(_url) {
    if (!req.headers.host) return _url

    var filename = URL.parse(_url).pathname.replace(/^.*\//, &#x27;&#x27;)

    if (config.url_prefix != null) {
      var result = config.url_prefix.replace(/\/$/, &#x27;&#x27;)
    } else {
      var result = req.protocol + &#x27;://&#x27; + req.headers.host
    }

    return result + &#x27;/&#x27; + pkg.name.replace(/\//g, &#x27;%2f&#x27;) + &#x27;/-/&#x27; + filename
  }

  for (var ver in pkg.versions) {
    var dist = pkg.versions[ver].dist
    if (dist != null &#x26;&#x26; dist.tarball != null) {
      //dist.__sinopia_orig_tarball = dist.tarball
      dist.tarball = filter(dist.tarball)
    }
  }
  return pkg
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
    next({ username: req.remote_user.name })
  })

  // TODO: anonymous user?
  app.get(&#x27;/:package/:version?&#x27;, can(&#x27;access&#x27;), function(req, res, next) {
    storage.get_package(req.params.package, { req: req }, function(err, info) {
if (err) return next(err)
info = Utils.<span class="apidocCodeKeywordSpan">filter_tarball_urls</span>(info, req, config)

var version = req.params.version
if (!version) return next(info)

var t = Utils.get_version(info, version)
if (t != null) return next(t)
...</pre></li>
    </ul>
    
    
    
    <h2>
        <a href="#apidoc.element.sinopia.utils.get_version" id="apidoc.element.sinopia.utils.get_version">
        function <span class="apidocSignatureSpan">sinopia.utils.</span>get_version
        <span class="apidocSignatureSpan">(object, version)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">get_version = function (object, version) {
  if (object.versions[version] != null) return object.versions[version]

  try {
    version = Semver.parse(version, true)
    for (var k in object.versions) {
      if (version.compare(Semver.parse(k, true)) === 0) {
        return object.versions[k]
      }
    }
  } catch (err) {
    return undefined
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
    storage.get_package(req.params.package, { req: req }, function(err, info) {
if (err) return next(err)
info = Utils.filter_tarball_urls(info, req, config)

var version = req.params.version
if (!version) return next(info)

var t = Utils.<span class="apidocCodeKeywordSpan">get_version</span>(info, version)
if (t != null) return next(t)

if (info[&#x27;dist-tags&#x27;] != null) {
  if (info[&#x27;dist-tags&#x27;][version] != null) {
    version = info[&#x27;dist-tags&#x27;][version]
    t = Utils.get_version(info, version)
    if (t != null) return next(t)
...</pre></li>
    </ul>
    
    
    
    <h2>
        <a href="#apidoc.element.sinopia.utils.is_object" id="apidoc.element.sinopia.utils.is_object">
        function <span class="apidocSignatureSpan">sinopia.utils.</span>is_object
        <span class="apidocSignatureSpan">(obj)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">is_object = function (obj) {
  return typeof(obj) === &#x27;object&#x27; &#x26;&#x26; obj !== null &#x26;&#x26; !Array.isArray(obj)
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  assert(!arg.match(/\s/), &#x27;CONFIG: invalid user name: &#x27; + arg)
  assert(users[arg] == null, &#x27;CONFIG: duplicate user/uplink name: &#x27; + arg)
  users[arg] = true
}

;[ &#x27;users&#x27;, &#x27;uplinks&#x27;, &#x27;packages&#x27; ].forEach(function(x) {
  if (self[x] == null) self[x] = {}
  assert(Utils.<span class="apidocCodeKeywordSpan">is_object</span>(self[x]), &#x27;CONFIG: bad &#x22;&#x27;+x+&#x27;&#x22; valu\
e (object expected)&#x27;)
})

for (var i in self.users) check_user_or_uplink(i)
for (var i in self.uplinks) check_user_or_uplink(i)

for (var i in self.users) {
  assert(self.users[i].password, &#x27;CONFIG: no password for user: &#x27; + i)
...</pre></li>
    </ul>
    
    
    
    <h2>
        <a href="#apidoc.element.sinopia.utils.parse_address" id="apidoc.element.sinopia.utils.parse_address">
        function <span class="apidocSignatureSpan">sinopia.utils.</span>parse_address
        <span class="apidocSignatureSpan">(addr)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function parse_address(addr) {
  //
  // Allow:
  //
  //  - https:localhost:1234        - protocol + host + port
  //  - localhost:1234              - host + port
  //  - 1234                        - port
  //  - http::1234                  - protocol + port
  //  - https://localhost:443/      - full url + https
  //  - http://[::1]:443/           - ipv6
  //  - unix:/tmp/http.sock         - unix sockets
  //  - https://unix:/tmp/http.sock - unix sockets (https)
  //
  // TODO: refactor it to something more reasonable?
  //
  //        protocol :  //      (  host  )|(    ipv6     ):  port  /
  var m = /^((https?):(\/\/)?)?((([^\/:]*)|\[([^\[\]]+)\]):)?(\d+)\/?$/.exec(addr)

  if (m) return {
    proto: m[2] || &#x27;http&#x27;,
    host:  m[6] || m[7] || &#x27;localhost&#x27;,
    port:  m[8] || &#x27;4873&#x27;,
  }

  var m = /^((https?):(\/\/)?)?unix:(.*)$/.exec(addr)

  if (m) return {
    proto: m[2] || &#x27;http&#x27;,
    path:  m[4],
  }

  return null
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  } else if (config.listen) {
addresses = [ config.listen ]
  } else {
addresses = [ &#x27;4873&#x27; ]
  }

  addresses = addresses.map(function(addr) {
var parsed_addr = Utils.<span class="apidocCodeKeywordSpan">parse_address</span>(addr)

if (!parsed_addr) {
  logger.logger.warn({ addr: addr },
     &#x27;invalid address - @{addr}, we expect a port (e.g. &#x22;4873&#x22;),&#x27;
   + &#x27; host:port (e.g. &#x22;localhost:4873&#x22;) or full url&#x27;
   + &#x27; (e.g. &#x22;http://localhost:4873/&#x22;)&#x27;)
}
...</pre></li>
    </ul>
    
    
    
    <h2>
        <a href="#apidoc.element.sinopia.utils.semver_sort" id="apidoc.element.sinopia.utils.semver_sort">
        function <span class="apidocSignatureSpan">sinopia.utils.</span>semver_sort
        <span class="apidocSignatureSpan">(array)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function semver_sort(array) {
  return array
        .filter(function(x) {
          if (!Semver.parse(x, true)) {
            Logger.logger.warn( {ver: x}, &#x27;ignoring bad version @{ver}&#x27; )
            return false
          }
          return true
        })
        .sort(Semver.compareLoose)
        .map(String)
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
    fs.stat(item.path, function(err, stats) {
      if (err) return cb(err)

      if (stats.mtime &#x3e; startkey) {
        self.get_package(item.name, options, function(err, data) {
if (err) return cb(err)

var versions = Utils.<span class="apidocCodeKeywordSpan">semver_sort</span>(Object.keys(data.versions))
var latest = versions[versions.length - 1]

if (data.versions[latest]) {
  stream.push({
    name           : data.versions[latest].name,
    description    : data.versions[latest].description,
    &#x27;dist-tags&#x27;    : { latest: latest },
...</pre></li>
    </ul>
    
    
    
    <h2>
        <a href="#apidoc.element.sinopia.utils.tag_version" id="apidoc.element.sinopia.utils.tag_version">
        function <span class="apidocSignatureSpan">sinopia.utils.</span>tag_version
        <span class="apidocSignatureSpan">(data, version, tag, config)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">tag_version = function (data, version, tag, config) {
  if (!can_add_tag(tag, config)) return false

  switch (typeof(data[&#x27;dist-tags&#x27;][tag])) {
    case &#x27;string&#x27;:
      data[&#x27;dist-tags&#x27;][tag] = [ data[&#x27;dist-tags&#x27;][tag] ]
      break
    case &#x27;object&#x27;: // array
      break
    default:
      data[&#x27;dist-tags&#x27;][tag] = []
  }
  if (data[&#x27;dist-tags&#x27;][tag].indexOf(version) === -1) {
    data[&#x27;dist-tags&#x27;][tag].push(version)
    data[&#x27;dist-tags&#x27;][tag] = module.exports.semver_sort(data[&#x27;dist-tags&#x27;][tag])
    return data[&#x27;dist-tags&#x27;][tag][data[&#x27;dist-tags&#x27;][tag].length - 1] === version
  }
  return false
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
      }

      data._attachments[tarball].version = version
    }
  }

  data.versions[version] = metadata
  Utils.<span class="apidocCodeKeywordSpan">tag_version</span>(data, version, tag, self.config)
  self.config.localList.add(name)
  cb()
}, callback)
}

Storage.prototype.merge_tags = function(name, tags, callback) {
var self = this
...</pre></li>
    </ul>
    
    
    
    <h2>
        <a href="#apidoc.element.sinopia.utils.validate_metadata" id="apidoc.element.sinopia.utils.validate_metadata">
        function <span class="apidocSignatureSpan">sinopia.utils.</span>validate_metadata
        <span class="apidocSignatureSpan">(object, name)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">validate_metadata = function (object, name) {
  assert(module.exports.is_object(object), &#x27;not a json object&#x27;)
  assert.equal(object.name, name)

  if (!module.exports.is_object(object[&#x27;dist-tags&#x27;])) {
    object[&#x27;dist-tags&#x27;] = {}
  }

  if (!module.exports.is_object(object[&#x27;versions&#x27;])) {
    object[&#x27;versions&#x27;] = {}
  }

  return object
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...

if (Object.keys(req.body).length == 1 &#x26;&#x26; Utils.is_object(req.body.users)) {
  // 501 status is more meaningful, but npm doesn&#x27;t show error message for 5xx
  return next( Error[404](&#x27;npm star|unstar calls are not implemented&#x27;) )
}

try {
  var metadata = Utils.<span class="apidocCodeKeywordSpan">validate_metadata</span>(req.body, name)
} catch(err) {
  return next( Error[422](&#x27;bad incoming package data&#x27;) )
}

if (req.params._rev) {
  storage.change_package(name, metadata, req.params.revision, function(err) {
    after_change(err, &#x27;package changed&#x27;)
...</pre></li>
    </ul>
    
    
    
    <h2>
        <a href="#apidoc.element.sinopia.utils.validate_name" id="apidoc.element.sinopia.utils.validate_name">
        function <span class="apidocSignatureSpan">sinopia.utils.</span>validate_name
        <span class="apidocSignatureSpan">(name)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">validate_name = function (name) {
  if (typeof(name) !== &#x27;string&#x27;) return false
  name = name.toLowerCase()

  // all URL-safe characters and &#x22;@&#x22; for issue #75
  if (!name.match(/^[-a-zA-Z0-9_.!~*&#x27;()@]+$/)
   || name.charAt(0) === &#x27;.&#x27; // &#x22;.bin&#x22;, etc.
   || name.charAt(0) === &#x27;-&#x27; // &#x22;-&#x22; is reserved by couchdb
   || name === &#x27;node_modules&#x27;
   || name === &#x27;__proto__&#x27;
   || name === &#x27;package.json&#x27;
   || name === &#x27;favicon.ico&#x27;
  ) {
    return false
  } else {
    return true
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
}, function(err) {
  if (err) return callback(err)
  callback()
})
}

Storage.prototype.remove_tarball = function(name, filename, revision, callback) {
assert(Utils.<span class="apidocCodeKeywordSpan">validate_name</span>(filename))
var self = this

self.update_package(name, function updater(data, cb) {
  if (data._attachments[filename]) {
    delete data._attachments[filename]
    cb()
  } else {
...</pre></li>
    </ul>
    
    
    
    <h2>
        <a href="#apidoc.element.sinopia.utils.validate_package" id="apidoc.element.sinopia.utils.validate_package">
        function <span class="apidocSignatureSpan">sinopia.utils.</span>validate_package
        <span class="apidocSignatureSpan">(name)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">validate_package = function (name) {
  name = name.split(&#x27;/&#x27;, 2)
  if (name.length === 1) {
    // normal package
    return module.exports.validate_name(name[0])
  } else {
    // scoped package
    return name[0][0] === &#x27;@&#x27;
        &#x26;&#x26; module.exports.validate_name(name[0].slice(1))
        &#x26;&#x26; module.exports.validate_name(name[1])
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  }
}

module.exports.validate_package = function validate_package(req, res, next, value, name) {
  if (value.charAt(0) === &#x27;-&#x27;) {
    // special case in couchdb usually
    next(&#x27;route&#x27;)
  } else if (utils.<span class="apidocCodeKeywordSpan">validate_package</span>(value)) {
    next()
  } else {
    next( Error[403](&#x27;invalid &#x27; + name) )
  }
}

module.exports.media = function media(expect) {
...</pre></li>
    </ul>
    
    
</div>

<div class="apidocFooterDiv">
    [ this document was created with
    <a href="https://github.com/kaizhu256/node-utility2" target="_blank">utility2</a>
    ]
</div>
</div>
